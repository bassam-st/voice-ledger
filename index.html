<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.json" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      background: #f5f5f5;
      color: #111827;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      text-align: center;
      margin: 8px 0 4px;
      color: #16a34a;
      font-size: 1.4rem;
    }
    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .install-bar {
      text-align: center;
      margin-bottom: 8px;
    }
    .install-btn {
      border: 1px solid #16a34a;
      background: #ecfdf3;
      color: #166534;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .tabs {
      display: flex;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #374151;
    }
    .tab.active {
      background: #16a34a;
      color: #ffffff;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #374151;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .row > div {
      flex: 1;
    }

    .items-header {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .items-header small {
      color: #6b7280;
      font-size: 0.75rem;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: #16a34a;
      color: #ffffff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-danger {
      background: #ef4444;
      color: #ffffff;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid #16a34a;
      color: #166534;
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .items-container {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .item-row {
      display: grid;
      grid-template-columns: minmax(0,1.7fr) minmax(0,1fr) 90px 80px 70px;
      gap: 6px;
      align-items: center;
    }
    .item-row input,
    .item-row select {
      padding: 6px 8px;
      font-size: 0.8rem;
      border-radius: 10px;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .text-muted {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .badge {
      background: #ecfdf3;
      color: #166534;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .statements-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }
    .statement-item {
      background: #ecfdf3;
      border-radius: 12px;
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }
    .statement-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .statement-meta span:first-child {
      font-weight: 600;
    }

    pre {
      white-space: pre-wrap;
      font-family: inherit;
      background: #f9fafb;
      border-radius: 12px;
      padding: 10px;
      font-size: 0.85rem;
    }

    .totals-block {
      background: #ecfdf3;
      border-radius: 16px;
      padding: 10px;
      font-size: 0.85rem;
      margin-top: 6px;
    }
    .totals-block h3 {
      margin: 0 0 4px;
      font-size: 0.9rem;
      color: #166534;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    @media (max-width: 640px) {
      .item-row {
        grid-template-columns: minmax(0,2fr) minmax(0,1fr) 80px 80px 70px;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
      .row {
        flex-direction: column;
      }
    }

    @media print {
      body {
        background: #ffffff;
      }
      .card, .app {
        box-shadow: none !important;
        margin: 0;
        padding: 0;
      }
      .no-print {
        display: none !important;
      }
      .print-only {
        display: block !important;
      }
    }
    .print-only {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    <div class="subtitle">Ø­ÙØ¸ ÙƒØ´ÙˆÙØ§Øª Ø¹Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø­Ø³Ø§Ø¨)</div>

    <div class="install-bar no-print">
      <button id="installButton" class="install-btn" hidden>ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“±</button>
    </div>

    <!-- Ø§Ù„ÙƒØ´ÙˆÙØ§Øª / Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div class="card no-print">
      <div class="tabs">
        <button class="tab active" id="tab-statements">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</button>
        <button class="tab" id="tab-clients">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
      <div id="view-statements">
        <div class="row" style="margin-bottom:8px;">
          <div>
            <label for="clientName">Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input id="clientName" list="clientsList" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
            <datalist id="clientsList"></datalist>
          </div>
          <div>
            <label for="statementDate">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input id="statementDate" type="date" />
          </div>
        </div>

        <div style="margin-bottom:8px;">
          <label for="statementTitle">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
          <input id="statementTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† Ø´Ø­Ù†Ø©ØŒ ØªØ³ÙˆÙŠØ© Ø­Ø³Ø§Ø¨ØŒ Ø³Ù„ÙØ©..." />
        </div>

        <div class="items-header">
          <div class="section-title">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
          <div class="badges">
            <button id="addItemBtn" class="btn btn-primary btn-small">+ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
            <button id="copyLastItemsBtn" class="btn btn-secondary btn-small">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù</button>
          </div>
        </div>
        <div class="text-muted">
          ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ù…ØªØ¹Ø¯Ø¯Ø©ØŒ Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ (Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡) ÙˆØ§Ù„Ø¹Ù…Ù„Ø© Ù„ÙƒÙ„ Ø¨Ù†Ø¯.
        </div>

        <div id="itemsContainer" class="items-container"></div>

        <div style="margin-top:8px;">
          <label for="manualTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
          <input id="manualTotal" placeholder="Ù…Ø«Ø§Ù„: 3,326,706 ÙŠÙ…Ù†ÙŠ + 2,300 Ø³Ø¹ÙˆØ¯ÙŠ" />
        </div>

        <div style="margin-top:8px;">
          <label for="extraNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
          <textarea id="extraNotes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ´Ù"></textarea>
        </div>

        <div class="row" style="margin-top:10px; gap:8px;">
          <button id="saveStatementBtn" class="btn btn-primary" style="flex:1;">
            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
          </button>
          <button id="newStatementSameClientBtn" class="btn btn-secondary" style="flex:1;">
            + ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)
          </button>
        </div>

        <hr style="margin:14px 0; border:none; border-top:1px dashed #e5e7eb;" />

        <div>
          <div class="section-title">Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</div>
          <pre id="outputText"></pre>

          <div class="row" style="margin-top:8px; gap:8px;">
            <button id="copyTextBtn" class="btn btn-secondary" style="flex:1;">
              ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ
            </button>
            <button id="shareWhatsappBtn" class="btn btn-primary" style="flex:1;">
              ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨
            </button>
          </div>
          <button id="printPdfBtn" class="btn btn-outline" style="margin-top:8px; width:100%;">
            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF
          </button>
        </div>

        <hr style="margin:14px 0; border:none; border-top:1px dashed #e5e7eb;" />

        <div>
          <div class="section-title">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:</div>
          <div class="text-muted">Ø§Ø®ØªØ± ÙƒØ´ÙÙ‹Ø§ Ù„ÙØªØ­Ù‡ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ù‡.</div>
          <div id="statementsList" class="statements-list"></div>
        </div>

        <div style="margin-top:12px;">
          <div class="section-title">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div id="clientTotals" class="totals-block">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„Ù„Ø¹Ù…ÙŠÙ„.
          </div>
        </div>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© -->
      <div id="view-clients" style="display:none;">
        <div class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</div>
        <div class="text-muted">
          ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„Ù‡. Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·.
        </div>
        <ul id="clientsSimpleList" style="margin-top:8px; padding-right:18px; font-size:0.9rem;"></ul>
      </div>
    </div>

    <!-- Ù†Ø³Ø®Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· (Ø´ÙƒÙ„ Ø¬Ø¯ÙˆÙ„) -->
    <div id="printArea" class="print-only">
      <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ù…Ù† Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    </div>
  </div>

  <script>
    // ==========================
    // ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ
    // ==========================
    const STORAGE_KEY = 'voiceLedgerData_v3';
    let ledgerData = {};
    let currentEditingId = null;
    let deferredPrompt = null;

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        ledgerData = raw ? JSON.parse(raw) : {};
      } catch (e) {
        console.error('Storage error', e);
        ledgerData = {};
      }
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(ledgerData));
    }

    // ==========================
    // Ø¹Ù†Ø§ØµØ± DOM
    // ==========================
    const clientNameInput = document.getElementById('clientName');
    const clientsList = document.getElementById('clientsList');
    const statementDateInput = document.getElementById('statementDate');
    const statementTitleInput = document.getElementById('statementTitle');
    const itemsContainer = document.getElementById('itemsContainer');
    const manualTotalInput = document.getElementById('manualTotal');
    const extraNotesInput = document.getElementById('extraNotes');
    const outputText = document.getElementById('outputText');
    const statementsList = document.getElementById('statementsList');
    const clientTotalsBox = document.getElementById('clientTotals');
    const clientsSimpleList = document.getElementById('clientsSimpleList');
    const printArea = document.getElementById('printArea');

    // ==========================
    // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª / Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    // ==========================
    const tabStatements = document.getElementById('tab-statements');
    const tabClients = document.getElementById('tab-clients');
    const viewStatements = document.getElementById('view-statements');
    const viewClients = document.getElementById('view-clients');

    tabStatements.addEventListener('click', () => {
      tabStatements.classList.add('active');
      tabClients.classList.remove('active');
      viewStatements.style.display = '';
      viewClients.style.display = 'none';
    });

    tabClients.addEventListener('click', () => {
      tabClients.classList.add('active');
      tabStatements.classList.remove('active');
      viewStatements.style.display = 'none';
      viewClients.style.display = '';
      renderClientsList();
    });

    // ==========================
    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¨Ù†Ø¯
    // ==========================
    const currencies = ['ÙŠÙ…Ù†ÙŠ', 'Ø³Ø¹ÙˆØ¯ÙŠ', 'Ø¯ÙˆÙ„Ø§Ø±', 'Ø¯Ø±Ù‡Ù…', 'Ø¹Ù…Ø§Ù†ÙŠ'];

    function createItemRow(data = {}) {
      const row = document.createElement('div');
      row.className = 'item-row';

      const descInput = document.createElement('input');
      descInput.placeholder = 'ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù†ØŒ ØªØµØ±ÙŠØ­ØŒ Ø§Ù„Ø¬ÙˆØ§Ù„...)';
      descInput.value = data.desc || '';

      const amountInput = document.createElement('input');
      amountInput.type = 'number';
      amountInput.min = '0';
      amountInput.value = data.amount != null ? data.amount : '';
      amountInput.placeholder = 'Ø§Ù„Ù…Ø¨Ù„Øº';

      const currencySelect = document.createElement('select');
      currencies.forEach(cur => {
        const opt = document.createElement('option');
        opt.value = cur;
        opt.textContent = cur;
        if (data.currency === cur) opt.selected = true;
        currencySelect.appendChild(opt);
      });
      if (!data.currency) currencySelect.value = 'ÙŠÙ…Ù†ÙŠ';

      const directionSelect = document.createElement('select');
      ['Ø¹Ù„ÙŠÙ‡', 'Ù„Ù‡'].forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        if (data.direction === d) opt.selected = true;
        directionSelect.appendChild(opt);
      });
      if (!data.direction) directionSelect.value = 'Ø¹Ù„ÙŠÙ‡';

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn btn-danger btn-small';
      deleteBtn.textContent = 'Ø­Ø°Ù';
      deleteBtn.addEventListener('click', () => {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) {
          row.remove();
        }
      });

      row.appendChild(descInput);
      row.appendChild(amountInput);
      row.appendChild(currencySelect);
      row.appendChild(directionSelect);
      row.appendChild(deleteBtn);

      itemsContainer.appendChild(row);
    }

    document.getElementById('addItemBtn').addEventListener('click', () => {
      createItemRow();
    });

    document.getElementById('copyLastItemsBtn').addEventListener('click', () => {
      const client = clientNameInput.value.trim();
      if (!client) {
        alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      const clientData = ledgerData[client];
      if (!clientData || !clientData.statements || clientData.statements.length === 0) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.');
        return;
      }
      if (!confirm('Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙÙ‚Ø· Ù…Ù† Ø¢Ø®Ø± ÙƒØ´ÙØŒ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¨Ø§Ù„Øº. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;

      const last = clientData.statements[clientData.statements.length - 1];
      itemsContainer.innerHTML = '';
      last.items.forEach(it => {
        createItemRow({ desc: it.desc, amount: '', currency: it.currency, direction: it.direction });
      });
    });

    // ==========================
    // Ø­ÙØ¸ / ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù
    // ==========================
    function collectItemsFromUI() {
      const rows = Array.from(itemsContainer.querySelectorAll('.item-row'));
      const items = [];
      for (const row of rows) {
        const [descInput, amountInput, currencySelect, directionSelect] =
          row.querySelectorAll('input, select');

        const desc = descInput.value.trim();
        const amount = parseFloat(amountInput.value || '0');
        const currency = currencySelect.value;
        const direction = directionSelect.value;

        if (!desc && !amount) continue;
        items.push({ desc, amount, currency, direction });
      }
      return items;
    }

    function calculateTotals(items) {
      const totals = {}; // {currency:{positive,negative,net}}
      for (const it of items) {
        if (!totals[it.currency]) {
          totals[it.currency] = { positive: 0, negative: 0, net: 0 };
        }
        if (it.direction === 'Ù„Ù‡') {
          totals[it.currency].positive += it.amount;
          totals[it.currency].net += it.amount;
        } else {
          totals[it.currency].negative += it.amount;
          totals[it.currency].net -= it.amount;
        }
      }
      return totals;
    }

    function formatNumber(num) {
      if (!Number.isFinite(num)) return '';
      return num.toLocaleString('ar-EG');
    }

    function renderWhatsappText(statement) {
      const { clientName, date, title, items, totals, manualTotal, extraNotes } = statement;
      const lines = [];
      lines.push(clientName || '');
      lines.push(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date || ''}`);
      lines.push('--------------');
      items.forEach((it, idx) => {
        lines.push(
          `${idx + 1}- ${it.desc} ${formatNumber(it.amount)} ${it.currency} (${it.direction})`
        );
      });
      if (manualTotal) {
        lines.push('--------------');
        lines.push(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${manualTotal}`);
      }
      if (totals && Object.keys(totals).length > 0) {
        lines.push('--------------');
        lines.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù (Ø­Ø³Ø¨ Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡):');
        Object.entries(totals).forEach(([cur, t]) => {
          if (t.net === 0) return;
          const side = t.net > 0 ? 'Ù„Ù‡' : 'Ø¹Ù„ÙŠÙ‡';
          lines.push(`Ø§Ù„ØµØ§ÙÙŠ: ${formatNumber(Math.abs(t.net))} ${cur} (${side})`);
        });
      }
      if (extraNotes) {
        lines.push('--------------');
        lines.push(extraNotes);
      }
      return lines.join('\n');
    }

    function renderPrintLayout(statement) {
      const { clientName, date, title, items, totals, manualTotal, extraNotes } = statement;

      let rowsHtml = '';
      items.forEach((it, idx) => {
        rowsHtml += `
          <tr>
            <td>${idx + 1}</td>
            <td>${it.desc}</td>
            <td>${formatNumber(it.amount)}</td>
            <td>${it.currency}</td>
            <td>${it.direction}</td>
          </tr>`;
      });

      let totalsHtml = '';
      if (totals && Object.keys(totals).length > 0) {
        totalsHtml += '<h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù</h3><ul>';
        Object.entries(totals).forEach(([cur, t]) => {
          if (t.net === 0) return;
          const side = t.net > 0 ? 'Ù„Ù‡' : 'Ø¹Ù„ÙŠÙ‡';
          totalsHtml += `<li>${formatNumber(Math.abs(t.net))} ${cur} (${side})</li>`;
        });
        totalsHtml += '</ul>';
      }

      printArea.innerHTML = `
        <div style="text-align:center; margin-bottom:8px;">
          <h2 style="margin:0 0 4px;">ÙƒØ´Ù Ø­Ø³Ø§Ø¨</h2>
          <div>${clientName || ''}</div>
          <div>${date || ''}</div>
          <div>${title || ''}</div>
        </div>
        <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
          <thead>
            <tr>
              <th style="border:1px solid #000; padding:4px;">#</th>
              <th style="border:1px solid #000; padding:4px;">Ø§Ù„ÙˆØµÙ</th>
              <th style="border:1px solid #000; padding:4px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th style="border:1px solid #000; padding:4px;">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
              <th style="border:1px solid #000; padding:4px;">Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
        <div style="margin-top:8px;">
          ${manualTotal ? `<div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (ÙƒØªØ§Ø¨Ø©): ${manualTotal}</div>` : ''}
          ${extraNotes ? `<div>Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${extraNotes}</div>` : ''}
        </div>
        <div style="margin-top:8px;">${totalsHtml}</div>
      `;
    }

    function buildStatementObject() {
      const clientName = clientNameInput.value.trim();
      const date = statementDateInput.value;
      const title = statementTitleInput.value.trim();
      if (!clientName) {
        alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return null;
      }
      if (!date) {
        alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.');
        return null;
      }
      const items = collectItemsFromUI();
      if (items.length === 0) {
        alert('Ø£Ø¶Ù Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
        return null;
      }
      const totals = calculateTotals(items);
      const manualTotal = manualTotalInput.value.trim();
      const extraNotes = extraNotesInput.value.trim();
      const id = currentEditingId || Date.now().toString();

      return { id, clientName, date, title, items, totals, manualTotal, extraNotes };
    }

    function resetForm(keepClient = false) {
      const client = clientNameInput.value;
      const today = new Date().toISOString().slice(0, 10);
      if (!keepClient) clientNameInput.value = '';
      statementDateInput.value = today;
      statementTitleInput.value = '';
      itemsContainer.innerHTML = '';
      manualTotalInput.value = '';
      extraNotesInput.value = '';
      outputText.textContent = '';
      currentEditingId = null;
      createItemRow(); // Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ ÙØ§Ø±Øº
      if (keepClient) clientNameInput.value = client;
    }

    document.getElementById('saveStatementBtn').addEventListener('click', () => {
      const statement = buildStatementObject();
      if (!statement) return;

      const clientName = statement.clientName;
      if (!ledgerData[clientName]) {
        ledgerData[clientName] = { statements: [] };
      }

      if (currentEditingId) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´ÙØŸ')) return;
        const idx = ledgerData[clientName].statements.findIndex(s => s.id === currentEditingId);
        if (idx !== -1) {
          ledgerData[clientName].statements[idx] = statement;
        } else {
          ledgerData[clientName].statements.push(statement);
        }
      } else {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
        ledgerData[clientName].statements.push(statement);
      }

      saveToStorage();
      outputText.textContent = renderWhatsappText(statement);
      renderClientUI(clientName);
      renderClientsList();
      renderPrintLayout(statement);
      currentEditingId = statement.id;
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    });

    document.getElementById('newStatementSameClientBtn').addEventListener('click', () => {
      resetForm(true);
    });

    // ==========================
    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
    // ==========================
    function renderClientUI(clientName) {
      const clientData = ledgerData[clientName];
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© datalist
      clientsList.innerHTML = '';
      Object.keys(ledgerData).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        clientsList.appendChild(opt);
      });

      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª
      statementsList.innerHTML = '';
      if (!clientData || !clientData.statements || clientData.statements.length === 0) {
        statementsList.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ÙƒØ´Ù Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
      } else {
        clientData.statements
          .slice()
          .sort((a, b) => a.date.localeCompare(b.date))
          .forEach(st => {
            const div = document.createElement('div');
            div.className = 'statement-item';

            const meta = document.createElement('div');
            meta.className = 'statement-meta';
            meta.innerHTML = `
              <span>${st.date}</span>
              <span>${st.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</span>
            `;

            const actions = document.createElement('div');
            const openBtn = document.createElement('button');
            openBtn.className = 'btn btn-secondary btn-small';
            openBtn.textContent = 'ÙØªØ­ / ØªØ¹Ø¯ÙŠÙ„';
            openBtn.addEventListener('click', () => {
              loadStatementIntoForm(clientName, st.id);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-small';
            deleteBtn.textContent = 'Ø­Ø°Ù';
            deleteBtn.addEventListener('click', () => {
              if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) return;
              ledgerData[clientName].statements =
                ledgerData[clientName].statements.filter(x => x.id !== st.id);
              saveToStorage();
              if (currentEditingId === st.id) {
                resetForm(true);
              }
              renderClientUI(clientName);
            });

            actions.appendChild(openBtn);
            actions.appendChild(deleteBtn);

            div.appendChild(meta);
            div.appendChild(actions);
            statementsList.appendChild(div);
          });
      }

      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„
      const totalsByCurrency = {};
      if (clientData && clientData.statements) {
        clientData.statements.forEach(st => {
          Object.entries(st.totals || {}).forEach(([cur, t]) => {
            if (!totalsByCurrency[cur]) {
              totalsByCurrency[cur] = { net: 0 };
            }
            totalsByCurrency[cur].net += t.net;
          });
        });
      }

      if (!clientData || clientData.statements.length === 0) {
        clientTotalsBox.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„Ù„Ø¹Ù…ÙŠÙ„.';
      } else {
        let html = `<h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„: ${clientName}</h3><hr>`;
        const currenciesTotals = Object.entries(totalsByCurrency);
        if (currenciesTotals.length === 0) {
          html += '<div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµØ§ÙÙŠ ÙˆØ§Ø¶Ø­ (Ø±Ø¨Ù…Ø§ ÙƒÙ„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù…ØªÙˆØ§Ø²Ù†Ø©).</div>';
        } else {
          currenciesTotals.forEach(([cur, t]) => {
            if (t.net === 0) return;
            const side = t.net > 0 ? 'Ù„Ù‡' : 'Ø¹Ù„ÙŠÙ‡';
            html += `<div>${formatNumber(Math.abs(t.net))} ${cur} (${side})</div>`;
          });
        }
        clientTotalsBox.innerHTML = html;
      }
    }

    function loadStatementIntoForm(clientName, id) {
      const clientData = ledgerData[clientName];
      if (!clientData) return;
      const st = clientData.statements.find(s => s.id === id);
      if (!st) return;

      currentEditingId = st.id;
      clientNameInput.value = clientName;
      statementDateInput.value = st.date;
      statementTitleInput.value = st.title || '';
      manualTotalInput.value = st.manualTotal || '';
      extraNotesInput.value = st.extraNotes || '';
      itemsContainer.innerHTML = '';
      st.items.forEach(it => createItemRow(it));
      outputText.textContent = renderWhatsappText(st);
      renderPrintLayout(st);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderClientsList() {
      clientsSimpleList.innerHTML = '';
      const names = Object.keys(ledgerData);
      if (names.length === 0) {
        clientsSimpleList.innerHTML = '<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯.</li>';
        return;
      }
      names.sort().forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        clientsSimpleList.appendChild(li);
      });
    }

    // ==========================
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Øµ / ÙˆØ§ØªØ³Ø§Ø¨ / PDF
    // ==========================
    document.getElementById('copyTextBtn').addEventListener('click', async () => {
      const text = outputText.textContent.trim();
      if (!text) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù†Ø³Ø®Ù‡. Ø§Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© âœ…');
      } catch {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø®ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
      }
    });

    document.getElementById('shareWhatsappBtn').addEventListener('click', () => {
      const text = outputText.textContent.trim();
      if (!text) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      const encoded = encodeURIComponent(text);
      const url = `https://wa.me/?text=${encoded}`;
      window.open(url, '_blank');
    });

    document.getElementById('printPdfBtn').addEventListener('click', () => {
      const statement = buildStatementObject();
      if (!statement) return;
      renderPrintLayout(statement);
      window.print();
    });

    // ==========================
    // PWA: ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    // ==========================
    const installButton = document.getElementById('installButton');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.hidden = false;
    });

    installButton.addEventListener('click', async () => {
      if (!deferredPrompt) {
        alert('Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­.');
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        console.log('User accepted A2HS');
      }
      deferredPrompt = null;
      installButton.hidden = true;
    });

    window.addEventListener('appinstalled', () => {
      installButton.hidden = true;
    });

    // ==========================
    // Service Worker
    // ==========================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => {
          console.warn('SW registration failed', err);
        });
      });
    }

    // ==========================
    // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    // ==========================
    (function init() {
      loadFromStorage();
      const today = new Date().toISOString().slice(0, 10);
      statementDateInput.value = today;
      createItemRow();
      // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
      Object.keys(ledgerData).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        clientsList.appendChild(opt);
      });
    })();
  </script>
</body>
</html>
