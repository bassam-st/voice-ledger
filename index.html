<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      background: #f3f4f6;
      color: #111827;
      line-height: 1.5;
    }
    .app { max-width: 640px; margin: 16px auto; padding: 0 12px; }

    .app-title { text-align: center; font-size: 1.4rem; margin-bottom: 4px; color: #065f46; }

    #installAppBtn {
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.95rem;
      color: #047857;
      cursor: pointer;
      text-decoration: underline;
      display: none;
    }

    /* ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± ÙˆØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tabs { display: flex; background: #e5e7eb; border-radius: 999px; padding: 4px; margin: 12px 0; }
    .tab-btn {
      flex: 1;
      padding: 8px 0;
      border: none;
      border-radius: 999px;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
    }
    .tab-btn.active { background: #16a34a; color: #ffffff; }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }

    h2 { font-size: 1.1rem; margin-bottom: 6px; color: #065f46; }

    label { font-size: 0.85rem; color: #4b5563; }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      margin: 6px 0;
      background: #f9fafb;
    }

    textarea { min-height: 70px; resize: vertical; }

    .btn {
      border: none;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-primary { background: #16a34a; color: white; }
    .btn-secondary { background: #e5e7eb; }
    .btn-danger { background: #ef4444; color:#fff; }
    .btn-outline { border: 1px solid #d1d5db; background:white; }

    /* Ø·Ø¨Ø§Ø¹Ø© PDF */
    @media print {
      .no-print { display:none !important; }
      body { background:white !important; }
      .card { border:1px solid #ddd; box-shadow:none; }
      input,select,textarea { background:white !important; }
    }
  </style>
</head>

<body>
  <div class="app">

    <h1 class="app-title">ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    <div id="installAppBtn" class="no-print">ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>

    <div class="tabs no-print">
      <button id="tab-ledger" class="tab-btn active">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</button>
      <button id="tab-customers" class="tab-btn">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    </div>

    <div id="ledger-section">
      <div class="card">
        <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØ´Ù</h2>

        <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
        <select id="customerSelect"></select>

        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateInput" />

        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
        <input type="text" id="titleInput" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ´Ù ÙŠÙˆÙ… 16" />

        <h2>Ø§Ù„Ø¨Ù†ÙˆØ¯</h2>
        <button id="addItemBtn" class="btn btn-primary no-print">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
        <button id="copyLastBtn" class="btn btn-outline no-print">ğŸ“‹ Ù†Ø³Ø® Ø¢Ø®Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯</button>

        <div id="itemsContainer" style="margin-top:10px;"></div>

        <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <input id="manualTotalInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 500 Ø§Ù„Ù ÙŠÙ…Ù†ÙŠ + 500 Ø³Ø¹ÙˆØ¯ÙŠ">

        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
        <textarea id="notesInput"></textarea>

        <button id="saveStatementBtn" class="btn btn-primary" style="width:100%;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù</button>
        <button id="newStatementBtn" class="btn btn-secondary" style="width:100%;margin-top:6px;">ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
      </div>

      <div class="card">
        <h2>Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨</h2>
        <textarea id="whatsText" readonly></textarea>

        <button id="copyTextBtn" class="btn btn-outline no-print" style="width:100%;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
        <button id="shareWhatsBtn" class="btn btn-primary no-print" style="width:100%;margin-top:6px;">ğŸŸ¢ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>

        <button id="exportPdfBtn" class="btn btn-outline no-print" style="width:100%;margin-top:6px;">ğŸ“ Ù…Ø´Ø§Ø±ÙƒØ© PDF</button>
      </div>

      <div class="card">
        <h2>ğŸ“‚ Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</h2>
        <div id="historyList"></div>
      </div>

      <div class="card">
        <h2>ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <div id="summaryContent"></div>
      </div>
    </div>

    <div id="customers-section" style="display:none;">
      <div class="card">
        <h2>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
        <input id="newCustomerInput" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <button id="addCustomerBtn" class="btn btn-primary" style="width:100%;">+ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        <div id="customerList" style="margin-top:10px;"></div>
      </div>
    </div>

  </div>

  <script>
    /* ========== Service Worker ========== */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    /* ========== Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª ========== */
    let deferredPrompt;
    const installBtn = document.getElementById("installAppBtn");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = "block";
    });

    installBtn.addEventListener("click", async () => {
      if (!deferredPrompt) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù†");
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });

    /* ========== Ø§Ù„ØªØ®Ø²ÙŠÙ† ========== */
    const KEY = "ledgerDataV1";
    function load() { return JSON.parse(localStorage.getItem(KEY) || `{ "customers":[], "statements":{} }`); }
    function save() { localStorage.setItem(KEY, JSON.stringify(data)); }
    let data = load();

    /* ========== Ø¹Ù†Ø§ØµØ± HTML ========== */
    const customerSelect = document.getElementById("customerSelect");
    const dateInput = document.getElementById("dateInput");
    const titleInput = document.getElementById("titleInput");
    const notesInput = document.getElementById("notesInput");
    const manualTotalInput = document.getElementById("manualTotalInput");
    const itemsContainer = document.getElementById("itemsContainer");
    const whatsText = document.getElementById("whatsText");
    const summaryContent = document.getElementById("summaryContent");
    const historyList = document.getElementById("historyList");

    /* ========== Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ========== */
    function renderCustomers() {
      customerSelect.innerHTML = "";
      data.customers.forEach(c => {
        const o = document.createElement("option");
        o.value = o.textContent = c;
        customerSelect.appendChild(o);
      });
    }

    /* ========== Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø¨Ù†Ø¯ ========== */
    function addItem(item = {}) {
      const wrap = document.createElement("div");
      wrap.style.marginBottom = "10px";

      wrap.innerHTML = `
        <input placeholder="Ø§Ù„ÙˆØµÙ" value="${item.desc || ""}">
        <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" value="${item.amount || ""}">
        <select>
          <option>ÙŠÙ…Ù†ÙŠ</option>
          <option>Ø³Ø¹ÙˆØ¯ÙŠ</option>
          <option>Ø¯ÙˆÙ„Ø§Ø±</option>
          <option>Ø¯Ø±Ù‡Ù…</option>
        </select>
        <select>
          <option>Ø¹Ù„ÙŠÙ‡</option>
          <option>Ù„Ù‡</option>
        </select>
        <button class="btn btn-danger no-print" style="margin-top:5px;">Ø­Ø°Ù</button>
      `;

      const btn = wrap.querySelector("button");
      btn.onclick = () => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ")) wrap.remove();
      };

      itemsContainer.appendChild(wrap);
      return wrap;
    }

    document.getElementById("addItemBtn").onclick = () => addItem();

    /* ========== Ø¬Ù…Ø¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ ========== */
    function collectItems() {
      const rows = [...itemsContainer.children];
      return rows.map(r => {
        const [desc, amount, currency, dir] = r.querySelectorAll("input,select");
        return {
          desc: desc.value.trim(),
          amount: +amount.value || 0,
          currency: currency.value,
          dir: dir.value
        };
      });
    }

    /* ========== Ù†Ø³Ø® Ø¢Ø®Ø± ÙƒØ´Ù ========== */
    document.getElementById("copyLastBtn").onclick = () => {
      const cust = customerSelect.value;
      if (!data.statements[cust] || !data.statements[cust].length)
        return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚");

      const last = data.statements[cust][data.statements[cust].length - 1];
      itemsContainer.innerHTML = "";
      last.items.forEach(i => addItem({ desc:i.desc, currency:i.currency }));
    };

    /* ========== Ø¥Ù†Ø´Ø§Ø¡ Ù†Øµ ÙˆØ§ØªØ³Ø§Ø¨ ========== */
    function updateWhats() {
      const cust = customerSelect.value;
      const date = dateInput.value;
      const title = titleInput.value.trim();
      const notes = notesInput.value.trim();
      const items = collectItems();

      let out = `${cust}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n----------------\n`;

      items.forEach((i, idx) => {
        out += `${idx + 1}- ${i.desc} ${i.amount} ${i.currency} (${i.dir})\n`;
      });

      if (manualTotalInput.value.trim())
        out += `----------------\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${manualTotalInput.value}\n`;

      if (notes)
        out += `----------------\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}`;

      whatsText.value = out;
    }

    /* ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ */
    document.querySelectorAll("input,select,textarea").forEach(e => {
      e.addEventListener("input", updateWhats);
    });

    /* ========== Ø­ÙØ¸ ÙƒØ´Ù ========== */
    document.getElementById("saveStatementBtn").onclick = () => {
      const cust = customerSelect.value;
      if (!cust) return alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„");

      const items = collectItems();
      if (!items.length) return alert("Ø£Ø¶Ù Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

      if (!data.statements[cust]) data.statements[cust] = [];

      data.statements[cust].push({
        id: Date.now(),
        date: dateInput.value,
        title: titleInput.value,
        notes: notesInput.value,
        manual: manualTotalInput.value,
        items
      });

      save();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù");

      renderHistory();
      renderSummary();
    };

    /* ========== ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ ========== */
    document.getElementById("newStatementBtn").onclick = () => {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ØŸ")) return;
      titleInput.value = "";
      notesInput.value = "";
      manualTotalInput.value = "";
      itemsContainer.innerHTML = "";
      addItem();
      updateWhats();
    };

    /* ========== Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª ========== */
    function renderHistory() {
      const cust = customerSelect.value;
      historyList.innerHTML = "";

      const list = data.statements[cust] || [];
      list.forEach(st => {
        const div = document.createElement("div");
        div.style.background = "#ecfdf3";
        div.style.padding = "8px";
        div.style.borderRadius = "12px";
        div.style.marginBottom = "6px";

        div.innerHTML = `
          <strong>${st.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</strong>
          <div>${st.date}</div>
          <button class="btn btn-outline no-print" style="margin-top:5px;">ÙØªØ­</button>
          <button class="btn btn-danger no-print" style="margin-top:5px;">Ø­Ø°Ù</button>
        `;

        const [openBtn, delBtn] = div.querySelectorAll("button");

        openBtn.onclick = () => {
          if (!confirm("ÙØªØ­ Ø§Ù„ÙƒØ´Ù Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŸ")) return;

          dateInput.value = st.date;
          titleInput.value = st.title;
          notesInput.value = st.notes;
          manualTotalInput.value = st.manual;

          itemsContainer.innerHTML = "";
          st.items.forEach(i => addItem(i));
          updateWhats();
        };

        delBtn.onclick = () => {
          if (!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ")) return;
          data.statements[cust] = data.statements[cust].filter(x => x.id !== st.id);
          save();
          renderHistory();
          renderSummary();
        };
        historyList.appendChild(div);
      });
    }

    /* ========== Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ ========== */
    function renderSummary() {
      const cust = customerSelect.value;
      const stmts = data.statements[cust] || [];

      const totals = {};

      stmts.forEach(st => {
        st.items.forEach(i => {
          if (!totals[i.currency]) totals[i.currency] = { lah: 0, alaih: 0 };
          if (i.dir === "Ù„Ù‡") totals[i.currency].lah += i.amount;
          else totals[i.currency].alaih += i.amount;
        });
      });

      summaryContent.innerHTML = Object.keys(totals).map(cur => {
        const t = totals[cur];
        const diff = t.lah - t.alaih;
        const dir = diff > 0 ? "Ù„Ù‡" : diff < 0 ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯";
        return `
          <div style="margin-bottom:6px;">
            <strong>${cur}</strong><br>
            Ù„Ù‡: ${t.lah}<br>
            Ø¹Ù„ÙŠÙ‡: ${t.alaih}<br>
            <strong>Ø§Ù„ØµØ§ÙÙŠ (${dir}): ${Math.abs(diff)}</strong>
          </div>
        `;
      }).join("");
    }

    /* ========== Ù…Ø´Ø§Ø±ÙƒØ© PDF ========== */
    document.getElementById("exportPdfBtn").onclick = () => window.print();

    /* ========== Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ ========== */
    document.getElementById("shareWhatsBtn").onclick = () => {
      const text = encodeURIComponent(whatsText.value);
      window.open("https://wa.me/?text=" + text, "_blank");
    };

    document.getElementById("copyTextBtn").onclick = () => {
      navigator.clipboard.writeText(whatsText.value);
      alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®");
    };

    /* ========== ØªØ¨ÙˆÙŠØ¨Ø§Øª ========== */
    document.getElementById("tab-customers").onclick = () => {
      ledger-section.style.display = "none";
      customers-section.style.display = "";
      tab-customers.classList.add("active");
      tab-ledger.classList.remove("active");
    };

    document.getElementById("tab-ledger").onclick = () => {
      ledger-section.style.display = "";
      customers-section.style.display = "none";
      tab-ledger.classList.add("active");
      tab-customers.classList.remove("active");
    };

    /* ========== ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ ========== */
    if (data.customers.length === 0) {
      data.customers.push("Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯");
      save();
    }

    renderCustomers();
    renderHistory();
    renderSummary();

    addItem();
    dateInput.value = new Date().toISOString().slice(0,10);
    updateWhats();
  </script>

</body>
</html>
