<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#16a34a" />

  <!-- manifest + PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      background: #f3f4f6;
      color: #111827;
      line-height: 1.5;
    }

    .app {
      max-width: 640px;
      margin: 16px auto 32px;
      padding: 0 12px;
    }

    .app-title {
      text-align: center;
      font-size: 1.3rem;
      margin-bottom: 4px;
      color: #065f46;
    }

    .install-link {
      text-align: center;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: #047857;
      cursor: pointer;
      text-decoration: underline;
    }

    .install-link[disabled] {
      color: #9ca3af;
      text-decoration: none;
      cursor: default;
    }

    .tabs {
      display: flex;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 12px;
    }

    .tab-btn {
      flex: 1;
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 8px 0;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .tab-btn.active {
      background: #16a34a;
      color: #fff;
      font-weight: 600;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 12px 12px 14px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      margin-bottom: 12px;
    }

    h2 {
      font-size: 1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: #065f46;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 2px;
      color: #4b5563;
    }

    .field-row {
      margin-bottom: 8px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      background: #f9fafb;
      color: #111827;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-primary {
      background: #16a34a;
      color: #fff;
      flex: 1;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      flex: 1;
    }

    .btn-danger {
      background: #ef4444;
      color: #fff;
    }

    .btn-outline {
      background: #ffffff;
      border: 1px solid #d1d5db;
      color: #111827;
    }

    .btn-small {
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
    }

    .items-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 6px;
    }

    .items-header-row .btn-small {
      font-size: 0.8rem;
    }

    .items-grid {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr) minmax(0, 2fr) minmax(0, 2fr);
      gap: 6px;
      margin-bottom: 4px;
      align-items: center;
    }

    .items-grid + .btn-danger {
      margin-bottom: 6px;
      width: 100%;
    }

    .muted {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: #ecfdf3;
      color: #166534;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
    }

    .history-item {
      padding: 6px 8px;
      border-radius: 10px;
      background: #ecfdf3;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }

    .history-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .history-title {
      font-weight: 600;
      color: #065f46;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .history-date {
      font-size: 0.8rem;
      color: #4b5563;
      white-space: nowrap;
    }

    .history-actions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .history-actions .btn {
      flex: 1;
      padding: 4px 6px;
      font-size: 0.75rem;
    }

    .summary-line {
      font-size: 0.86rem;
      margin-bottom: 3px;
    }

    .summary-line strong {
      color: #065f46;
    }

    .chips-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    /* ÙˆØ§ØªØ³Ø§Ø¨ / PDF / Ù†Ø³Ø® Ø§Ù„Ù†Øµ */
    .share-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .share-row .btn {
      flex: 1;
    }

    /* ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ */
    .customer-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
      max-height: 240px;
      overflow-y: auto;
    }

    .customer-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: #ecfdf3;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .customer-pill span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    footer {
      text-align: center;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    /* ğŸ–¨ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      body {
        background: #ffffff !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .no-print {
        display: none !important;
      }

      .app {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 10px !important;
      }

      .card {
        box-shadow: none !important;
        border: 1px solid #e5e7eb !important;
        margin-bottom: 8px !important;
        border-radius: 8px !important;
      }

      input,
      select,
      textarea {
        background: #ffffff !important;
        border: 1px solid #d1d5db !important;
        box-shadow: none !important;
      }

      .summary-card {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1 class="app-title">ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    <div id="installBtn" class="install-link no-print">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“±</div>

    <div class="tabs no-print">
      <button class="tab-btn active" id="tab-ledger">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</button>
      <button class="tab-btn" id="tab-customers">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="print-area">
      <!-- ğŸŸ¢ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
      <section class="card" id="ledger-section">
        <h2>Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</h2>

        <div class="field-row">
          <label for="customerSelect">Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
          <select id="customerSelect"></select>
        </div>

        <div class="field-row">
          <label for="dateInput">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
          <input type="date" id="dateInput" />
        </div>

        <div class="field-row">
          <label for="titleInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
          <input
            type="text"
            id="titleInput"
            placeholder="Ù…Ø«Ø§Ù„: Ø³ÙˆØ§Ù‚Ø© Ø¹Ø±Ø¶ Ø´Ø­Ø±Ø§Ù†"
          />
        </div>

        <div class="field-row">
          <div class="items-header-row">
            <span class="muted">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</span>
            <div style="display:flex; gap:6px;">
              <button id="copyLastItemsBtn" type="button" class="btn btn-small btn-outline no-print">
                ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù
              </button>
              <button id="addItemBtn" type="button" class="btn btn-small btn-primary">
                + Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
              </button>
            </div>
          </div>
          <p class="muted">
            Ù„ÙƒÙ„ Ø¨Ù†Ø¯ Ø§Ø®ØªØ±: <strong>Ù„Ù‡ Ø£Ùˆ Ø¹Ù„ÙŠÙ‡</strong> Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„Ø©.
          </p>
        </div>

        <div id="itemsContainer"></div>

        <div class="field-row">
          <label for="manualTotalInput">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
          <input
            type="text"
            id="manualTotalInput"
            placeholder="Ù…Ø«Ø§Ù„: 3,326,706 ÙŠÙ…Ù†ÙŠ + 2,300 Ø³Ø¹ÙˆØ¯ÙŠ"
          />
        </div>

        <div class="field-row">
          <label for="notesInput">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
          <textarea
            id="notesInput"
            placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ´Ù"
          ></textarea>
        </div>

        <div class="btn-row">
          <button id="saveStatementBtn" type="button" class="btn btn-primary">
            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
          </button>
          <button id="newStatementSameClientBtn" type="button" class="btn btn-secondary">
            + ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)
          </button>
        </div>
      </section>

      <!-- Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ -->
      <section class="card">
        <h2>Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</h2>
        <textarea id="whatsText" readonly></textarea>
        <div class="share-row no-print">
          <button id="copyTextBtn" type="button" class="btn btn-outline">
            ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ
          </button>
          <button id="shareWhatsBtn" type="button" class="btn btn-primary">
            ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨
          </button>
        </div>
        <button id="exportPdfBtn" type="button" class="btn btn-outline w-100 no-print" style="width:100%;margin-top:6px;">
          ğŸ“ Ù…Ø´Ø§Ø±ÙƒØ© ÙƒÙ€ PDF / Ø·Ø¨Ø§Ø¹Ø©
        </button>
      </section>

      <!-- Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
      <section class="card">
        <h2>ğŸ“‚ Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:</h2>
        <div id="historyList" class="history-list"></div>
      </section>

      <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <section class="card summary-card">
        <h2>ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <div id="summaryContent" class="muted"></div>
      </section>
    </div>

    <!-- ğŸŸ¢ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <section class="card no-print" id="customers-section" style="display:none;">
      <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>

      <div class="field-row">
        <label for="newCustomerInput">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:</label>
        <input
          type="text"
          id="newCustomerInput"
          placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©"
        />
      </div>
      <button id="addCustomerBtn" type="button" class="btn btn-primary" style="width:100%;margin-bottom:8px;">
        + Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„
      </button>

      <p class="muted">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</p>
      <div id="customerList" class="customer-list"></div>
    </section>

    <footer class="no-print">
      Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ Ø§Ø®ØªÙŠØ§Ø±
      <strong>"Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"</strong>.
    </footer>
  </div>

  <script>
    // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† =====
    const STORAGE_KEY = "voiceLedgerData_v2";

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return {
            customers: ["Ø¨Ø§Ø¯ÙŠØ¨Ø§Ù†"],
            statements: {},
          };
        }
        const parsed = JSON.parse(raw);
        if (!parsed.customers) parsed.customers = [];
        if (!parsed.statements) parsed.statements = {};
        return parsed;
      } catch (e) {
        console.error("loadData error", e);
        return { customers: [], statements: {} };
      }
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    let data = loadData();
    let currentCustomer = data.customers[0] || "";
    let editingStatementId = null;
    let deferredPrompt = null;

    // ===== Ø¹Ù†Ø§ØµØ± DOM =====
    const customerSelect = document.getElementById("customerSelect");
    const dateInput = document.getElementById("dateInput");
    const titleInput = document.getElementById("titleInput");
    const manualTotalInput = document.getElementById("manualTotalInput");
    const notesInput = document.getElementById("notesInput");
    const itemsContainer = document.getElementById("itemsContainer");
    const whatsText = document.getElementById("whatsText");
    const historyList = document.getElementById("historyList");
    const summaryContent = document.getElementById("summaryContent");

    const saveStatementBtn = document.getElementById("saveStatementBtn");
    const newStatementSameClientBtn = document.getElementById("newStatementSameClientBtn");
    const addItemBtn = document.getElementById("addItemBtn");
    const copyLastItemsBtn = document.getElementById("copyLastItemsBtn");
    const copyTextBtn = document.getElementById("copyTextBtn");
    const shareWhatsBtn = document.getElementById("shareWhatsBtn");
    const exportPdfBtn = document.getElementById("exportPdfBtn");

    const tabLedger = document.getElementById("tab-ledger");
    const tabCustomers = document.getElementById("tab-customers");
    const ledgerSection = document.getElementById("ledger-section");
    const customersSection = document.getElementById("customers-section");

    const newCustomerInput = document.getElementById("newCustomerInput");
    const addCustomerBtn = document.getElementById("addCustomerBtn");
    const customerList = document.getElementById("customerList");

    const installBtn = document.getElementById("installBtn");

    // ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± =====
    function renderCustomersSelect() {
      customerSelect.innerHTML = "";
      if (data.customers.length === 0) {
        data.customers.push("Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯");
      }
      data.customers.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        customerSelect.appendChild(opt);
      });
      if (!currentCustomer) currentCustomer = data.customers[0];
      customerSelect.value = currentCustomer;
    }

    function renderCustomersList() {
      customerList.innerHTML = "";
      data.customers.forEach((c) => {
        const div = document.createElement("div");
        div.className = "customer-pill";
        const span = document.createElement("span");
        span.textContent = c;
        const btn = document.createElement("button");
        btn.className = "btn btn-small btn-outline";
        btn.textContent = "ØªØ­Ø¯ÙŠØ¯";
        btn.addEventListener("click", () => {
          currentCustomer = c;
          customerSelect.value = c;
          switchToLedgerTab();
          refreshAllForCustomer();
        });
        div.appendChild(span);
        div.appendChild(btn);
        customerList.appendChild(div);
      });
    }

    function addEmptyItemRow(item) {
      const row = document.createElement("div");

      const grid = document.createElement("div");
      grid.className = "items-grid";

      // Ø§Ù„ÙˆØµÙ
      const descInput = document.createElement("input");
      descInput.type = "text";
      descInput.placeholder = "ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù†ØŒ Ø§Ù„Ø¬ÙˆØ¯Ù‡ØŒ Ø­ÙˆØ§Ù„Ù‡...)";
      descInput.value = item?.description || "";

      // Ø§Ù„Ø¹Ù…Ù„Ø©
      const currencySelect = document.createElement("select");
      ["ÙŠÙ…Ù†ÙŠ", "Ø³Ø¹ÙˆØ¯ÙŠ", "Ø¯ÙˆÙ„Ø§Ø±", "Ø¯Ø±Ù‡Ù…", "Ø¹Ù…Ø§Ù†ÙŠ"].forEach((cur) => {
        const o = document.createElement("option");
        o.value = cur;
        o.textContent = cur;
        currencySelect.appendChild(o);
      });
      currencySelect.value = item?.currency || "ÙŠÙ…Ù†ÙŠ";

      // Ø§Ù„Ù…Ø¨Ù„Øº
      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.min = "0";
      amountInput.step = "0.01";
      amountInput.placeholder = "0";
      amountInput.value = item?.amount != null ? item.amount : "";

      // Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡
      const dirSelect = document.createElement("select");
      ["Ø¹Ù„ÙŠÙ‡", "Ù„Ù‡"].forEach((d) => {
        const o = document.createElement("option");
        o.value = d;
        o.textContent = d;
        dirSelect.appendChild(o);
      });
      dirSelect.value = item?.direction || "Ø¹Ù„ÙŠÙ‡";

      grid.appendChild(descInput);
      grid.appendChild(currencySelect);
      grid.appendChild(amountInput);
      grid.appendChild(dirSelect);

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "btn btn-danger";
      delBtn.textContent = "Ø­Ø°Ù";
      delBtn.addEventListener("click", () => {
        const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ");
        if (!ok) return;
        row.remove();
        generateWhatsText();
        updateSummary();
      });

      row.appendChild(grid);
      row.appendChild(delBtn);
      itemsContainer.appendChild(row);

      [descInput, currencySelect, amountInput, dirSelect].forEach((el) => {
        el.addEventListener("input", () => {
          generateWhatsText();
        });
      });
    }

    function collectItemsFromForm() {
      const rows = Array.from(itemsContainer.children);
      const items = [];
      rows.forEach((row) => {
        const [descInput, currencySelect, amountInput, dirSelect] = row.querySelectorAll(
          "input, select"
        );
        const description = descInput.value.trim();
        const currency = currencySelect.value;
        const amount = parseFloat(amountInput.value.replace(",", ""));
        const direction = dirSelect.value;
        if (!description && (isNaN(amount) || amount <= 0)) return;
        items.push({
          description,
          currency,
          amount: isNaN(amount) ? 0 : amount,
          direction,
        });
      });
      return items;
    }

    function setItemsInForm(items, { copyAmounts } = { copyAmounts: true }) {
      itemsContainer.innerHTML = "";
      items.forEach((item) => {
        addEmptyItemRow({
          description: item.description,
          currency: item.currency,
          amount: copyAmounts ? item.amount : "",
          direction: item.direction,
        });
      });
      if (items.length === 0) {
        addEmptyItemRow();
      }
    }

    function getCustomerStatements(cust) {
      if (!data.statements[cust]) data.statements[cust] = [];
      return data.statements[cust];
    }

    function formatDateForDisplay(d) {
      return d;
    }

    function generateWhatsText() {
      const customer = currentCustomer || customerSelect.value || "";
      const date = dateInput.value || "";
      const title = titleInput.value.trim();
      const items = collectItemsFromForm();
      const notes = notesInput.value.trim();

      let lines = [];
      if (customer) lines.push(customer);
      if (date) lines.push("Ø§Ù„ØªØ§Ø±ÙŠØ®: " + date);
      lines.push("---------------");

      items.forEach((item, idx) => {
        const num = idx + 1;
        const amountStr =
          item.amount && !isNaN(item.amount)
            ? item.amount.toLocaleString("en-US")
            : "0";
        const line =
          num +
          "- " +
          (item.description || "Ø¨Ù†Ø¯ Ø¨Ø¯ÙˆÙ† ÙˆØµÙ") +
          " " +
          amountStr +
          " " +
          item.currency +
          " (" +
          item.direction +
          ")";
        lines.push(line);
      });

      if (manualTotalInput.value.trim()) {
        lines.push("---------------");
        lines.push("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + manualTotalInput.value.trim());
      }

      if (notes) {
        lines.push("---------------");
        lines.push("Ù…Ù„Ø§Ø­Ø¸Ø§Øª: " + notes);
      }

      whatsText.value = lines.join("\n");
    }

    function renderHistory() {
      const statements = getCustomerStatements(currentCustomer);
      historyList.innerHTML = "";
      if (!statements.length) {
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        historyList.appendChild(p);
        return;
      }
      const sorted = [...statements].sort((a, b) => (a.date > b.date ? -1 : 1));
      sorted.forEach((st) => {
        const div = document.createElement("div");
        div.className = "history-item";

        const top = document.createElement("div");
        top.className = "history-top";

        const titleSpan = document.createElement("div");
        titleSpan.className = "history-title";
        titleSpan.textContent = st.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";

        const dateSpan = document.createElement("div");
        dateSpan.className = "history-date";
        dateSpan.textContent = st.date;

        top.appendChild(titleSpan);
        top.appendChild(dateSpan);

        const chips = document.createElement("div");
        chips.className = "chips-row";

        const countChip = document.createElement("span");
        countChip.className = "tag";
        countChip.textContent = st.items.length + " Ø¨Ù†ÙˆØ¯";

        chips.appendChild(countChip);

        const actions = document.createElement("div");
        actions.className = "history-actions";

        const openBtn = document.createElement("button");
        openBtn.type = "button";
        openBtn.className = "btn btn-outline";
        openBtn.textContent = "ÙØªØ­ / ØªØ¹Ø¯ÙŠÙ„";
        openBtn.addEventListener("click", () => {
          const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŸ");
          if (!ok) return;
          openStatement(st.id);
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "btn btn-danger";
        deleteBtn.textContent = "Ø­Ø°Ù";
        deleteBtn.addEventListener("click", () => {
          const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ");
          if (!ok) return;
          deleteStatement(st.id);
        });

        actions.appendChild(openBtn);
        actions.appendChild(deleteBtn);

        div.appendChild(top);
        if (st.manualTotal) {
          const mt = document.createElement("div");
          mt.className = "muted";
          mt.textContent = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + st.manualTotal;
          div.appendChild(mt);
        }
        div.appendChild(chips);
        div.appendChild(actions);

        historyList.appendChild(div);
      });
    }

    function calcSummaryForCustomer(cust) {
      const stmts = getCustomerStatements(cust);
      const totals = {}; // currency -> {lah: , alaih: }
      stmts.forEach((st) => {
        st.items.forEach((item) => {
          if (!totals[item.currency]) {
            totals[item.currency] = { lah: 0, alaih: 0 };
          }
          if (item.direction === "Ù„Ù‡") {
            totals[item.currency].lah += item.amount || 0;
          } else {
            totals[item.currency].alaih += item.amount || 0;
          }
        });
      });
      return totals;
    }

    function updateSummary() {
      const totals = calcSummaryForCustomer(currentCustomer);
      const keys = Object.keys(totals);
      if (!keys.length) {
        summaryContent.innerHTML =
          '<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
        return;
      }
      const lines = [];
      lines.push(
        `<p class="summary-line"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„: ${currentCustomer}</strong></p>`
      );
      lines.push('<p class="summary-line">--------------------</p>');
      keys.forEach((cur) => {
        const { lah, alaih } = totals[cur];
        const diff = lah - alaih;
        const dirText =
          diff > 0 ? "Ù„Ù‡" : diff < 0 ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯";
        const diffAbs = Math.abs(diff);

        lines.push(
          `<p class="summary-line">${cur}:
          <br/>Ù„Ù‡: ${lah.toLocaleString("en-US")}
          <br/>Ø¹Ù„ÙŠÙ‡: ${alaih.toLocaleString("en-US")}
          <br/><strong>Ø§Ù„ØµØ§ÙÙŠ (${dirText}): ${
            diffAbs ? diffAbs.toLocaleString("en-US") : 0
          }</strong></p>`
        );
      });

      summaryContent.innerHTML = lines.join("");
    }

    function openStatement(id) {
      const stmts = getCustomerStatements(currentCustomer);
      const st = stmts.find((s) => s.id === id);
      if (!st) return;
      editingStatementId = id;
      dateInput.value = st.date;
      titleInput.value = st.title || "";
      manualTotalInput.value = st.manualTotal || "";
      notesInput.value = st.notes || "";
      setItemsInForm(st.items, { copyAmounts: true });
      generateWhatsText();
    }

    function deleteStatement(id) {
      const stmts = getCustomerStatements(currentCustomer);
      const idx = stmts.findIndex((s) => s.id === id);
      if (idx === -1) return;
      stmts.splice(idx, 1);
      saveData();
      editingStatementId = null;
      renderHistory();
      updateSummary();
      generateWhatsText();
    }

    function refreshAllForCustomer() {
      renderHistory();
      updateSummary();
      generateWhatsText();
    }

    // ===== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø± =====
    addItemBtn.addEventListener("click", () => {
      addEmptyItemRow();
    });

    copyLastItemsBtn.addEventListener("click", () => {
      const stmts = getCustomerStatements(currentCustomer);
      if (!stmts.length) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù†Ù‡.");
        return;
      }
      const last = [...stmts].sort((a, b) => (a.date > b.date ? -1 : 1))[0];
      setItemsInForm(last.items, { copyAmounts: false });
      generateWhatsText();
    });

    customerSelect.addEventListener("change", () => {
      currentCustomer = customerSelect.value;
      editingStatementId = null;
      refreshAllForCustomer();
    });

    saveStatementBtn.addEventListener("click", () => {
      const customer = customerSelect.value.trim();
      if (!customer) {
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„.");
        return;
      }
      const date = dateInput.value || new Date().toISOString().slice(0, 10);
      const title = titleInput.value.trim();
      const manualTotal = manualTotalInput.value.trim();
      const notes = notesInput.value.trim();
      const items = collectItemsFromForm();
      if (!items.length) {
        alert("Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§.");
        return;
      }

      if (!data.customers.includes(customer)) {
        data.customers.push(customer);
      }

      const stmts = getCustomerStatements(customer);

      if (editingStatementId != null) {
        const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´ÙØŸ");
        if (!ok) return;
        const st = stmts.find((s) => s.id === editingStatementId);
        if (st) {
          st.date = date;
          st.title = title;
          st.manualTotal = manualTotal;
          st.notes = notes;
          st.items = items;
        }
      } else {
        const id = Date.now();
        stmts.push({
          id,
          date,
          title,
          manualTotal,
          notes,
          items,
        });
      }

      saveData();
      renderCustomersSelect();
      renderCustomersList();
      currentCustomer = customer;
      editingStatementId = null;
      customerSelect.value = currentCustomer;
      refreshAllForCustomer();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    });

    newStatementSameClientBtn.addEventListener("click", () => {
      const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ");
      if (!ok) return;
      editingStatementId = null;
      titleInput.value = "";
      manualTotalInput.value = "";
      notesInput.value = "";
      setItemsInForm([]);
      dateInput.value = new Date().toISOString().slice(0, 10);
      generateWhatsText();
    });

    copyTextBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(whatsText.value);
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ âœ…");
      } catch (e) {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
      }
    });

    shareWhatsBtn.addEventListener("click", () => {
      const text = encodeURIComponent(whatsText.value);
      const url = "https://wa.me/?text=" + text;
      window.open(url, "_blank");
    });

    exportPdfBtn.addEventListener("click", () => {
      window.print();
    });

    // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    addCustomerBtn.addEventListener("click", () => {
      const name = newCustomerInput.value.trim();
      if (!name) {
        alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      if (!data.customers.includes(name)) {
        data.customers.push(name);
        saveData();
        renderCustomersSelect();
        renderCustomersList();
      }
      newCustomerInput.value = "";
      currentCustomer = name;
      customerSelect.value = name;
      switchToLedgerTab();
      refreshAllForCustomer();
    });

    // ØªØ¨ÙˆÙŠØ¨Ø§Øª
    function switchToLedgerTab() {
      tabLedger.classList.add("active");
      tabCustomers.classList.remove("active");
      document.getElementById("print-area").style.display = "";
      customersSection.style.display = "none";
    }

    function switchToCustomersTab() {
      tabLedger.classList.remove("active");
      tabCustomers.classList.add("active");
      document.getElementById("print-area").style.display = "none";
      customersSection.style.display = "";
    }

    tabLedger.addEventListener("click", switchToLedgerTab);
    tabCustomers.addEventListener("click", switchToCustomersTab);

    // ===== Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª (PWA) =====
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.removeAttribute("disabled");
      installBtn.textContent = "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“±";
    });

    installBtn.addEventListener("click", async () => {
      if (!deferredPrompt) {
        alert(
          "Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ Ø§Ø®ØªÙŠØ§Ø± 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'."
        );
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === "accepted") {
        installBtn.setAttribute("disabled", "true");
        installBtn.textContent = "ØªÙ… Ø·Ù„Ø¨ Ø§Ù„ØªØ«Ø¨ÙŠØª âœ…";
      }
      deferredPrompt = null;
    });

    // ===== Service Worker =====
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch((err) =>
        console.error("SW registration failed:", err)
      );
    }

    // ===== ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© =====
    function init() {
      const today = new Date().toISOString().slice(0, 10);
      dateInput.value = today;
      renderCustomersSelect();
      renderCustomersList();
      setItemsInForm([]);
      refreshAllForCustomer();
    }

    init();
  </script>
</body>
</html>
