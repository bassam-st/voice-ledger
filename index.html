<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#16a34a" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" sizes="192x192" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    .app-wrap {
      max-width: 860px;
      margin: 0 auto;
      padding: 12px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,.08);
      padding: 16px;
      margin-bottom: 12px;
    }
    h1 {
      margin: 12px 0 4px;
      text-align: center;
      color: #15803d;
      font-size: 1.4rem;
    }
    .subtitle {
      text-align: center;
      font-size: .8rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .install-bar {
      text-align: center;
      margin-bottom: 8px;
    }
    .install-btn {
      border: none;
      border-radius: 999px;
      background: #16a34a;
      color: #ffffff;
      padding: 6px 18px;
      font-size: .9rem;
      cursor: pointer;
    }
    .install-btn:active { opacity: .8; }

    .tabs {
      display: flex;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      font-size: .9rem;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #374151;
    }
    .tab.active {
      background: #16a34a;
      color: #ffffff;
    }

    label {
      display: block;
      font-size: .8rem;
      margin-bottom: 4px;
      color: #374151;
    }
    select, input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: .9rem;
    }
    textarea { min-height: 70px; resize: vertical; }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .row > * { flex: 1; }

    .items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: .9rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-green {
      background: #16a34a;
      color: #ffffff;
    }
    .btn-gray {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-red {
      background: #dc2626;
      color: #ffffff;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #374151;
    }
    .btn:active { opacity: .85; }

    .items-container {
      border-radius: 10px;
      border: 1px dashed #d1d5db;
      padding: 8px;
      background: #f9fafb;
      margin-bottom: 8px;
    }
    .item-row {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,0.6fr) minmax(0,0.7fr) minmax(0,1.5fr) auto;
      gap: 6px;
      margin-bottom: 6px;
    }
    @media (max-width: 640px) {
      .item-row {
        grid-template-columns: repeat(2, minmax(0,1fr));
        grid-auto-rows: auto;
      }
      .item-row > button {
        grid-column: 1 / -1;
      }
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: .75rem;
      background: #e5e7eb;
      color: #374151;
    }
    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #16a34a;
    }

    .section-title {
      font-size: .85rem;
      font-weight: 600;
      margin: 10px 0 6px;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .section-title span {
      font-size: 1rem;
    }

    .muted {
      font-size: .75rem;
      color: #6b7280;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .history-item {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      font-size: .8rem;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }
    .history-item-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .chip {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: .7rem;
      background: #e5e7eb;
      color: #374151;
      white-space: nowrap;
    }

    .totals-box {
      background: #ecfdf3;
      border-radius: 10px;
      border: 1px solid #bbf7d0;
      padding: 10px;
      font-size: .8rem;
    }
    .totals-box h3 {
      margin: 0 0 4px;
      font-size: .85rem;
      color: #166534;
    }
    .totals-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      border-top: 1px dashed #bbf7d0;
      padding-top: 4px;
      margin-top: 4px;
    }

    .whatsapp-box {
      background: #f0fdf4;
      border-radius: 10px;
      border: 1px solid #bbf7d0;
      padding: 8px;
      font-size: .8rem;
      white-space: pre-wrap;
    }

    .empty-state {
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed #e5e7eb;
      background: #f9fafb;
      font-size: .8rem;
      color: #6b7280;
      text-align: center;
    }

    .footer-note {
      text-align: center;
      font-size: .7rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    /* Ù†Ø³Ø®Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      body { background: #ffffff; }
      .install-bar, .no-print, .tabs { display: none !important; }
      .card { box-shadow: none; margin: 0; padding: 8px; }
      .app-wrap { max-width: 100%; padding: 0; }
    }
  </style>
</head>
<body>
  <div class="app-wrap">
    <h1>ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    <p class="subtitle">Ø­ÙØ¸ ÙƒØ´ÙˆÙØ§Øª Ø¹Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø­Ø³Ø§Ø¨).</p>

    <div class="install-bar no-print">
      <button id="installButton" class="install-btn">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“±</button>
    </div>

    <div class="card">
      <div class="tabs no-print">
        <button class="tab active" id="tabStatements">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</button>
        <button class="tab" id="tabClients">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
      <div id="screenStatements">
        <div class="row">
          <div>
            <label for="clientSelect">Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input list="clientsList" id="clientInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
            <datalist id="clientsList"></datalist>
          </div>
          <div>
            <label for="dateInput">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="dateInput" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="titleInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
            <input type="text" id="titleInput" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø´Ø­Ù†Ø© Ø¬ÙˆØ§Ù„Ø§Øª..." />
          </div>
        </div>

        <div class="items-header">
          <div class="section-title">
            <span>ğŸ§¾</span>
            <span> Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</span>
          </div>
          <div class="row" style="flex: 0 0 auto; margin:0;">
            <button id="copyItemsBtn" class="btn btn-gray no-print">
              ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù
            </button>
            <button id="addItemBtn" class="btn btn-green no-print">
              + Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
            </button>
          </div>
        </div>

        <p class="muted">
          Ù„ÙƒÙ„ Ø¨Ù†Ø¯ Ø§Ø®ØªØ± (Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡)ØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„ØºØŒ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø©ØŒ Ø«Ù… ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯.
        </p>

        <div id="itemsContainer" class="items-container"></div>

        <div class="row">
          <div>
            <label for="manualTotalInput">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input id="manualTotalInput"
                   type="text"
                   placeholder="Ù…Ø«Ø§Ù„: 3,326,706 ÙŠÙ…Ù†ÙŠ + 2,300 Ø³Ø¹ÙˆØ¯ÙŠ" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="notesInput">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <textarea id="notesInput"
                      placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ´Ù"></textarea>
          </div>
        </div>

        <div class="row no-print">
          <button id="saveStatementBtn" class="btn btn-green" style="flex:2;">
            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
          </button>
          <button id="newWithSameClientBtn" class="btn btn-gray" style="flex:2;">
            + ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)
          </button>
        </div>

        <div class="section-title">
          <span>ğŸ’¬</span>
          <span>Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</span>
        </div>
        <div id="whatsPreview" class="whatsapp-box"></div>

        <div class="row no-print" style="margin-top:6px;">
          <button id="shareWhatsBtn" class="btn btn-green" style="flex:2;">
            ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨
          </button>
          <button id="copyWhatsBtn" class="btn btn-gray" style="flex:1.5;">
            ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ
          </button>
          <button id="printBtn" class="btn btn-outline" style="flex:1.5;">
            ğŸ–¨ Ø­ÙØ¸ / Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ€ PDF
          </button>
        </div>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
      <div id="screenClients" style="display:none;">
        <div class="section-title">
          <span>ğŸ“</span>
          <span>Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
        </div>

        <div id="clientSummaryInfo" class="muted" style="margin-bottom:4px;"></div>
        <div id="historyContainer" class="history-list"></div>

        <div id="historyEmpty" class="empty-state">
          Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„ÙƒØ´ÙˆÙØ§Øª" Ø«Ù… Ø§Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„Ù‡ Ù„ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø³Ø¬Ù„Ù‡ Ø§Ù„ÙƒØ§Ù…Ù„.
        </div>

        <div class="section-title" style="margin-top:10px;">
          <span>ğŸ“Š</span>
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
        </div>
        <div id="totalsContainer" class="totals-box">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.
        </div>
      </div>
    </div>

    <p class="footer-note no-print">
      Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ Ø§Ø®ØªÙŠØ§Ø±
      "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".
    </p>
  </div>

  <script>
    // ===================== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ =====================
    const STORAGE_KEY = "voiceLedgerData_v1";

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { clients: {}, lastItemsTemplate: [] };
        const parsed = JSON.parse(raw);
        if (!parsed.clients) parsed.clients = {};
        if (!parsed.lastItemsTemplate) parsed.lastItemsTemplate = [];
        return parsed;
      } catch (e) {
        console.error("loadData error", e);
        return { clients: {}, lastItemsTemplate: [] };
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
      } catch (e) {
        console.error("saveData error", e);
      }
    }

    let appData = loadData();
    let currentClientName = "";
    let currentEditing = null; // {clientName, statementId} Ø£Ùˆ null

    // ===================== Ø¹Ù†Ø§ØµØ± DOM =====================
    const tabStatements = document.getElementById("tabStatements");
    const tabClients = document.getElementById("tabClients");
    const screenStatements = document.getElementById("screenStatements");
    const screenClients = document.getElementById("screenClients");

    const clientInput = document.getElementById("clientInput");
    const clientsList = document.getElementById("clientsList");
    const dateInput = document.getElementById("dateInput");
    const titleInput = document.getElementById("titleInput");
    const itemsContainer = document.getElementById("itemsContainer");
    const addItemBtn = document.getElementById("addItemBtn");
    const copyItemsBtn = document.getElementById("copyItemsBtn");
    const manualTotalInput = document.getElementById("manualTotalInput");
    const notesInput = document.getElementById("notesInput");
    const saveStatementBtn = document.getElementById("saveStatementBtn");
    const newWithSameClientBtn = document.getElementById("newWithSameClientBtn");
    const whatsPreview = document.getElementById("whatsPreview");
    const shareWhatsBtn = document.getElementById("shareWhatsBtn");
    const copyWhatsBtn = document.getElementById("copyWhatsBtn");
    const printBtn = document.getElementById("printBtn");

    const clientSummaryInfo = document.getElementById("clientSummaryInfo");
    const historyContainer = document.getElementById("historyContainer");
    const historyEmpty = document.getElementById("historyEmpty");
    const totalsContainer = document.getElementById("totalsContainer");

    const installButton = document.getElementById("installButton");

    // ===================== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª / Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =====================
    tabStatements.addEventListener("click", () => {
      tabStatements.classList.add("active");
      tabClients.classList.remove("active");
      screenStatements.style.display = "";
      screenClients.style.display = "none";
    });

    tabClients.addEventListener("click", () => {
      tabClients.classList.add("active");
      tabStatements.classList.remove("active");
      screenClients.style.display = "";
      screenStatements.style.display = "none";
      renderClientScreen(currentClientName);
    });

    // ===================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„ÙŠØ© =====================
    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function populateClientsDatalist() {
      clientsList.innerHTML = "";
      const names = Object.keys(appData.clients).sort();
      for (const name of names) {
        const opt = document.createElement("option");
        opt.value = name;
        clientsList.appendChild(opt);
      }
    }

    function resetForm(keepClient = false) {
      if (!keepClient) {
        clientInput.value = "";
        currentClientName = "";
      }
      dateInput.value = todayISO();
      titleInput.value = "";
      manualTotalInput.value = "";
      notesInput.value = "";
      itemsContainer.innerHTML = "";
      currentEditing = null;
      addItemRow(); // ØµÙ ÙˆØ§Ø­Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
      updateWhatsPreview();
    }

    // ===================== ØµÙ Ø§Ù„Ø¨Ù†ÙˆØ¯ =====================
    function addItemRow(prefill) {
      const row = document.createElement("div");
      row.className = "item-row";

      const dirSelect = document.createElement("select");
      const opt1 = new Option("Ø¹Ù„ÙŠÙ‡", "Ø¹Ù„ÙŠÙ‡");
      const opt2 = new Option("Ù„Ù‡", "Ù„Ù‡");
      dirSelect.appendChild(opt1);
      dirSelect.appendChild(opt2);

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.min = "0";
      amountInput.step = "0.01";
      amountInput.placeholder = "0";

      const curSelect = document.createElement("select");
      ["ÙŠÙ…Ù†ÙŠ","Ø³Ø¹ÙˆØ¯ÙŠ","Ø¯ÙˆÙ„Ø§Ø±","Ø¯Ø±Ù‡Ù…","Ø¹Ù…Ø§Ù†ÙŠ"].forEach(c => {
        curSelect.appendChild(new Option(c, c));
      });

      const descInput = document.createElement("input");
      descInput.type = "text";
      descInput.placeholder = "ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¬ÙˆØ§Ø²ØŒ Ø±Ø³ÙˆÙ…ØŒ Ù†Ù‚Ù„...)";

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "btn btn-red no-print";
      delBtn.textContent = "Ø­Ø°Ù";

      if (prefill) {
        dirSelect.value = prefill.dir || "Ø¹Ù„ÙŠÙ‡";
        curSelect.value = prefill.currency || "ÙŠÙ…Ù†ÙŠ";
        descInput.value = prefill.desc || "";
        // Ø§Ù„Ù…Ø¨Ø§Ù„Øº ØµÙØ± Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ
        amountInput.value = "";
      }

      delBtn.addEventListener("click", () => {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ")) return;
        row.remove();
        updateWhatsPreview();
      });

      [dirSelect, amountInput, curSelect, descInput].forEach(el => {
        el.addEventListener("input", () => updateWhatsPreview());
      });

      row.appendChild(dirSelect);
      row.appendChild(amountInput);
      row.appendChild(curSelect);
      row.appendChild(descInput);
      row.appendChild(delBtn);

      itemsContainer.appendChild(row);
    }

    function getCurrentItems() {
      const rows = Array.from(itemsContainer.querySelectorAll(".item-row"));
      const items = [];
      for (const row of rows) {
        const [dirSelect, amountInput, curSelect, descInput] =
          row.querySelectorAll("select, input");
        const dir = dirSelect.value;
        const currency = curSelect.value;
        const desc = descInput.value.trim();
        const amount = parseFloat(amountInput.value || "0") || 0;
        if (!desc && amount === 0) continue;
        items.push({ dir, amount, currency, desc });
      }
      return items;
    }

    // ===================== Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù =====================
    copyItemsBtn.addEventListener("click", () => {
      if (!currentClientName || !appData.clients[currentClientName] ||
          !appData.clients[currentClientName].statements.length) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù†Ù‡.");
        return;
      }
      const statements = appData.clients[currentClientName].statements;
      const last = statements[statements.length - 1];
      itemsContainer.innerHTML = "";
      last.items.forEach(item => addItemRow(item));
      updateWhatsPreview();
    });

    // ===================== Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ =====================
    function formatNumber(n) {
      return n.toLocaleString("en-US");
    }

    function buildWhatsappText(clientName, dateStr, title, items, manualTotal, notes) {
      if (!clientName) clientName = "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
      if (!dateStr) dateStr = todayISO();

      let lines = [];
      lines.push(clientName);
      lines.push("Ø§Ù„ØªØ§Ø±ÙŠØ®: " + dateStr.split("-").reverse().join("-"));
      lines.push("----------------");

      if (!items.length) {
        lines.push("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù.");
      } else {
        items.forEach((it, i) => {
          lines.push(
            (i + 1) + "- " +
            it.desc + " " +
            formatNumber(it.amount || 0) + " " +
            it.currency + " (" + it.dir + ")"
          );
        });
      }

      if (manualTotal) {
        lines.push("----------------");
        lines.push("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + manualTotal);
      }

      if (notes) {
        lines.push("----------------");
        lines.push(notes);
      }

      return lines.join("\n");
    }

    function updateWhatsPreview() {
      const clientName = clientInput.value.trim();
      const dateStr = dateInput.value || todayISO();
      const title = titleInput.value.trim();
      const items = getCurrentItems();
      const manualTotal = manualTotalInput.value.trim();
      const notes = notesInput.value.trim();
      const text = buildWhatsappText(clientName, dateStr, title, items, manualTotal, notes);
      whatsPreview.textContent = text;
    }

    [clientInput, dateInput, titleInput, manualTotalInput, notesInput]
      .forEach(el => el.addEventListener("input", updateWhatsPreview));

    // ===================== Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù =====================
    function calcTotalsByCurrency(items) {
      const totals = {}; // currency -> {lah, alaih}
      for (const it of items) {
        if (!totals[it.currency]) totals[it.currency] = { lah: 0, alaih: 0 };
        if (it.dir === "Ù„Ù‡") totals[it.currency].lah += it.amount;
        else totals[it.currency].alaih += it.amount;
      }
      return totals;
    }

    saveStatementBtn.addEventListener("click", () => {
      const clientName = clientInput.value.trim();
      if (!clientName) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const dateStr = dateInput.value || todayISO();
      const title = titleInput.value.trim() || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
      const items = getCurrentItems();
      if (!items.length) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
        return;
      }
      const manualTotal = manualTotalInput.value.trim();
      const notes = notesInput.value.trim();

      const totalsByCurrency = calcTotalsByCurrency(items);
      const id = currentEditing?.statementId || Date.now();

      const statement = {
        id,
        date: dateStr,
        title,
        items,
        manualTotal,
        notes,
        totalsByCurrency
      };

      if (!appData.clients[clientName]) {
        appData.clients[clientName] = { statements: [] };
      }

      if (currentEditing && currentEditing.clientName === clientName) {
        // ØªØ¹Ø¯ÙŠÙ„
        const arr = appData.clients[clientName].statements;
        const idx = arr.findIndex(s => s.id === currentEditing.statementId);
        if (idx !== -1) arr[idx] = statement;
      } else {
        appData.clients[clientName].statements.push(statement);
      }

      appData.lastItemsTemplate = items; // Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¥Ù† Ø§Ø­ØªØ¬Ù†Ø§

      currentClientName = clientName;
      currentEditing = null;
      saveData();
      populateClientsDatalist();
      updateWhatsPreview();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø¨Ù†Ø¬Ø§Ø­.");

      renderClientScreen(clientName);
    });

    // ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„
    newWithSameClientBtn.addEventListener("click", () => {
      resetForm(true);
    });

    // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
    addItemBtn.addEventListener("click", () => addItemRow());

    // ===================== Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ù„Ø³Ø¬Ù„ + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª) =====================
    function renderClientScreen(clientName) {
      if (!clientName || !appData.clients[clientName]) {
        clientSummaryInfo.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯.";
        historyContainer.innerHTML = "";
        totalsContainer.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.";
        historyEmpty.style.display = "";
        return;
      }

      const data = appData.clients[clientName];
      const statements = data.statements;
      clientSummaryInfo.textContent =
        "Ø§Ù„Ø¹Ù…ÙŠÙ„: " + clientName + " â€” Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª: " + statements.length;

      if (!statements.length) {
        historyContainer.innerHTML = "";
        historyEmpty.style.display = "";
      } else {
        historyEmpty.style.display = "none";
        historyContainer.innerHTML = "";
        statements
          .slice()
          .sort((a,b) => (a.date || "").localeCompare(b.date))
          .forEach(st => {
            const div = document.createElement("div");
            div.className = "history-item";

            const main = document.createElement("div");
            main.className = "history-item-main";
            const line1 = document.createElement("div");
            line1.textContent =
              (st.date || "").split("-").reverse().join("-") + " â€” " + st.title;
            const line2 = document.createElement("div");
            line2.className = "muted";
            line2.textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯: " + st.items.length;
            main.appendChild(line1);
            main.appendChild(line2);

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn-outline no-print";
            btn.textContent = "ÙØªØ­ / ØªØ¹Ø¯ÙŠÙ„";

            btn.addEventListener("click", () => {
              if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŸ")) return;
              loadStatementIntoForm(clientName, st.id);
              tabStatements.click();
            });

            div.appendChild(main);
            div.appendChild(btn);
            historyContainer.appendChild(div);
          });
      }

      // Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
      const totals = {};
      for (const st of statements) {
        for (const [currency, v] of Object.entries(st.totalsByCurrency || {})) {
          if (!totals[currency]) totals[currency] = { lah: 0, alaih: 0 };
          totals[currency].lah += v.lah || 0;
          totals[currency].alaih += v.alaih || 0;
        }
      }

      if (!Object.keys(totals).length) {
        totalsContainer.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯.";
      } else {
        let html = `<h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„: ${clientName}</h3>`;
        for (const [cur, v] of Object.entries(totals)) {
          const net = (v.lah || 0) - (v.alaih || 0);
          const status =
            net > 0 ? `ØµØ§ÙÙŠ Ù„Ù‡: ${formatNumber(Math.abs(net))} ${cur}` :
            net < 0 ? `ØµØ§ÙÙŠ Ø¹Ù„ÙŠÙ‡: ${formatNumber(Math.abs(net))} ${cur}` :
            "ØµØ§ÙÙŠ: ØµÙØ±";
          html += `
            <div class="totals-row">
              <div><strong>${cur}:</strong></div>
              <div style="text-align:left;">
                Ù„Ù‡: ${formatNumber(v.lah || 0)}<br/>
                Ø¹Ù„ÙŠÙ‡: ${formatNumber(v.alaih || 0)}<br/>
                <span style="color:#166534;">${status}</span>
              </div>
            </div>`;
        }
        totalsContainer.innerHTML = html;
      }
    }

    function loadStatementIntoForm(clientName, statementId) {
      const data = appData.clients[clientName];
      if (!data) return;
      const st = data.statements.find(s => s.id === statementId);
      if (!st) return;

      currentClientName = clientName;
      currentEditing = { clientName, statementId };

      clientInput.value = clientName;
      dateInput.value = st.date || todayISO();
      titleInput.value = st.title || "";
      manualTotalInput.value = st.manualTotal || "";
      notesInput.value = st.notes || "";

      itemsContainer.innerHTML = "";
      st.items.forEach(item => {
        // Ù‡Ù†Ø§ Ù†Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const row = { ...item };
        addItemRow({ dir: row.dir, currency: row.currency, desc: row.desc });
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¯ÙˆÙŠÙ‹Ø§
        const lastRow = itemsContainer.lastElementChild;
        const amountInput = lastRow.querySelector('input[type="number"]');
        amountInput.value = row.amount;
      });

      updateWhatsPreview();
    }

    // ===================== ÙˆØ§ØªØ³Ø§Ø¨ Ùˆ PDF =====================
    shareWhatsBtn.addEventListener("click", () => {
      const text = whatsPreview.textContent || "";
      if (!text.trim()) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡.");
        return;
      }
      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    });

    copyWhatsBtn.addEventListener("click", async () => {
      const text = whatsPreview.textContent || "";
      if (!text.trim()) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù†Ø³Ø®Ù‡.");
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.");
      } catch {
        alert("Ù„Ù… ØªÙ†Ø¬Ø­ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø®ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
      }
    });

    printBtn.addEventListener("click", () => {
      window.print();
    });

    // ===================== PWA: Ø§Ù„ØªØ«Ø¨ÙŠØª Ùˆ Service Worker =====================
    let deferredPrompt = null;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Ø§Ù„Ø²Ø± Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ØŒ Ù„ÙƒÙ† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø¯Ø« Ù„Ùˆ Ù…ØªÙˆÙØ±
    });

    installButton.addEventListener("click", async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      } else {
        alert("Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®ÙŠØ§Ø± \"Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\" Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­.");
      }
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js").catch(console.error);
      });
    }

    // ===================== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø© =====================
    document.addEventListener("DOMContentLoaded", () => {
      populateClientsDatalist();
      resetForm();
      if (Object.keys(appData.clients).length) {
        // Ø§Ø®ØªØ± Ø£ÙˆÙ„ Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ùˆ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª
        currentClientName = Object.keys(appData.clients)[0];
        renderClientScreen(currentClientName);
      }
    });
  </script>
</body>
</html>
