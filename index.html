<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .app-shell {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }

    h1 {
      text-align: center;
      font-size: 1.4rem;
      margin: 0 0 12px;
      color: #047857;
    }

    h2 {
      font-size: 1.1rem;
      margin: 0 0 8px;
      color: #064e3b;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: #374151;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      outline: none;
      background: #ffffff;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.2);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .row > .col {
      flex: 1 1 0;
      min-width: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: #16a34a;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.35);
    }

    .btn-primary:hover {
      background: #15803d;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #ef4444;
      color: #ffffff;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #166534;
      font-size: 0.8rem;
      border: 1px solid #bbf7d0;
      margin-inline-start: 6px;
    }

    .tabs {
      display: flex;
      margin-bottom: 12px;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 4px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
      border: none;
      background: transparent;
      color: #374151;
    }

    .tab.active {
      background: #16a34a;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(22,163,74,0.35);
    }

    .items-list {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px;
      background: #f9fafb;
      max-height: 280px;
      overflow-y: auto;
    }

    .item-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 6px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      margin-bottom: 6px;
      align-items: center;
    }

    .item-row input[type="text"] {
      min-width: 160px;
      flex: 2 1 160px;
    }

    .item-row input[type="number"] {
      flex: 1 1 80px;
    }

    .item-row select {
      flex: 0 0 90px;
    }

    .item-row .btn-danger {
      flex: 0 0 auto;
    }

    .totals {
      margin-top: 4px;
      font-size: 0.9rem;
      color: #065f46;
    }

    .totals span {
      display: inline-block;
      margin-inline-end: 6px;
    }

    .section-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .muted {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .statements-list {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      max-height: 240px;
      overflow-y: auto;
    }

    .statement-item {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
      background: #ffffff;
      font-size: 0.9rem;
    }

    .statement-item:last-child {
      border-bottom: none;
    }

    .statement-item:hover {
      background: #f3f4f6;
    }

    .statement-item-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 2px;
    }

    .statement-item-title {
      font-weight: 600;
    }

    .statement-item-meta {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .badge-editing {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.8rem;
      border: 1px solid #facc15;
    }

    .json-panel {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px dashed #d1d5db;
      padding: 8px;
      background: #f9fafb;
    }

    .json-panel textarea {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      direction: ltr;
      text-align: left;
      min-height: 180px;
      font-size: 0.8rem;
      background: #111827;
      color: #e5e7eb;
      border-radius: 10px;
    }

    @media (max-width: 640px) {
      .card {
        border-radius: 0;
        margin: 0 -8px 12px;
      }

      .app-shell {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="card">
      <h1>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>

      <!-- ØªØ¨ÙˆÙŠØ¨ Ø¨Ø³ÙŠØ· (Ø§Ù„Ø¢Ù† ØªØ¨ÙˆÙŠØ¨ ÙˆØ§Ø­Ø¯ Ù„Ù„ÙƒØ´ÙˆÙØ§Øª ÙÙ‚Ø·ØŒ Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
      <div class="tabs" style="margin-bottom: 16px;">
        <button class="tab active" type="button">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</button>
        <button class="tab" type="button" disabled style="opacity:0.4; cursor:default;">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ù„Ø§Ø­Ù‚Ø§Ù‹)</button>
      </div>

      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® -->
      <div class="row">
        <div class="col">
          <label for="clientSelect">Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
          <select id="clientSelect"></select>
        </div>
        <div class="col">
          <label for="dateInput">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
          <input id="dateInput" type="date">
        </div>
      </div>

      <!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ -->
      <div class="row" style="margin-bottom:12px;">
        <div class="col">
          <label for="newClientName">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:</label>
          <input id="newClientName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø¯ÙŠØ§Ù†ØŒ Ù‚Ø§Ø·Ø±Ø© Ø²ÙƒÙŠØŒ ...">
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button id="addClientBtn" class="btn btn-secondary btn-sm" type="button">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
        </div>
      </div>

      <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù -->
      <div style="margin-bottom: 10px;">
        <label for="titleInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
        <input id="titleInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† Ø´Ø­Ù†Ø© Ø´Ø§Ø´Ø§Øª Ù…Ù† Ø´Ø­Ù†">
      </div>

      <!-- Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© -->
      <div style="margin-bottom: 8px;">
        <div class="section-title-row">
          <h2 style="margin:0;">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h2>
          <div>
            <button id="addItemBtn" class="btn btn-secondary btn-sm" type="button">+ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
            <button id="copyLastItemsBtn" class="btn btn-secondary btn-sm" type="button">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù</button>
          </div>
        </div>
        <div class="muted">ÙƒÙ„ Ø¨Ù†Ø¯ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ù…Ù„Ø© Ù…Ø®ØªÙ„ÙØ© (ÙŠÙ…Ù†ÙŠØŒ Ø³Ø¹ÙˆØ¯ÙŠØŒ Ø¯Ø±Ù‡Ù…ØŒ Ø¯ÙˆÙ„Ø§Ø±ØŒ Ø¹Ù…Ø§Ù†ÙŠ ...)</div>
      </div>

      <div id="itemsContainer" class="items-list"></div>

      <div id="totalsDisplay" class="totals"></div>

      <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
      <div style="margin-top:10px;">
        <label for="notesInput">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <textarea id="notesInput" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¶ÙŠÙÙŠ ÙˆØ­Ø¯Ø© Ø±ÙƒØ§Ø¨ØŒ Ø¯ÙØ¹Øª Ù„Ù„Ø³ÙˆØ§Ù‚ Ø¹Ø±Ø¨ÙˆÙ†..."></textarea>
      </div>

      <!-- ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ + Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ -->
      <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
        <button id="saveStatementBtn" class="btn btn-primary" type="button">
          ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
        </button>
        <button id="newStatementSameClientBtn" class="btn btn-secondary btn-sm" type="button">
          + ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)
        </button>
        <span id="editingBadge" class="badge-editing" style="display:none;">
          ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ ÙƒØ´Ù Ù…Ø­ÙÙˆØ¸
        </span>
      </div>
    </div>

    <!-- Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ -->
    <div class="card">
      <div class="section-title-row">
        <h2 style="margin:0;">Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</h2>
        <span class="muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
      </div>
      <textarea id="whatsAppText" readonly></textarea>
      <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <button id="copyWhatsAppTextBtn" class="btn btn-secondary btn-sm" type="button">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
        <span class="muted">Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„.</span>
      </div>
    </div>

    <!-- Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙƒØ´ÙˆÙ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    <div class="card">
      <div class="section-title-row">
        <h2 style="margin:0;">Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <span class="muted">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ÙƒØ´Ù Ù„ØªØ­Ù…ÙŠÙ„Ù‡ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡</span>
      </div>
      <div id="statementsList" class="statements-list"></div>
    </div>

    <!-- Ù„ÙˆØ­Ø© JSON -->
    <div class="card">
      <div class="section-title-row">
        <h2 style="margin:0;">Ø¨ÙŠØ§Ù†Ø§Øª JSON (Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²)</h2>
        <span class="muted">Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø£Ùˆ Ø§Ù„Ù†Ø³Ø® ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</span>
      </div>
      <div class="json-panel">
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px;">
          <button id="toggleJsonBtn" class="btn btn-secondary btn-sm" type="button">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª JSON</button>
          <button id="copyJsonBtn" class="btn btn-secondary btn-sm" type="button">ğŸ“‹ Ù†Ø³Ø® JSON</button>
          <span class="muted">Ù„Ø§ ÙŠØªÙ… Ø±ÙØ¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙŠ Ø®Ø§Ø¯Ù…ØŒ ÙƒÙ„Ù‡Ø§ Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ localStorage Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­.</span>
        </div>
        <textarea id="jsonText" style="display:none;"></textarea>
      </div>
    </div>
  </div>

  <script>
    // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© =====
    const STORAGE_KEY = 'kashf_ledger_v1';

    const CURRENCIES = [
      { code: 'YER', label: 'ÙŠÙ…Ù†ÙŠ' },
      { code: 'SAR', label: 'Ø³Ø¹ÙˆØ¯ÙŠ' },
      { code: 'AED', label: 'Ø¯Ø±Ù‡Ù…' },
      { code: 'USD', label: 'Ø¯ÙˆÙ„Ø§Ø±' },
      { code: 'OMR', label: 'Ø¹Ù…Ø§Ù†ÙŠ' }
    ];

    function formatNumber(n) {
      if (n == null || isNaN(n)) return '0';
      return new Intl.NumberFormat('ar-EG').format(n);
    }

    function currencyLabel(code) {
      const c = CURRENCIES.find(c => c.code === code);
      return c ? c.label : code;
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„: Ø¹Ù…ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙˆØ§Ø­Ø¯
        const initial = {
          clients: [
            { id: 'badyan', name: 'Ø¨Ø§Ø¯ÙŠØ§Ù†' }
          ],
          statements: []
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(initial));
        return initial;
      }
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.error('Error parsing stored JSON', e);
        return { clients: [], statements: [] };
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      refreshJsonPanelIfVisible();
    }

    let state = loadState();

    // ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =====
    const clientSelect = document.getElementById('clientSelect');
    const dateInput = document.getElementById('dateInput');
    const titleInput = document.getElementById('titleInput');
    const itemsContainer = document.getElementById('itemsContainer');
    const totalsDisplay = document.getElementById('totalsDisplay');
    const notesInput = document.getElementById('notesInput');
    const saveStatementBtn = document.getElementById('saveStatementBtn');
    const newStatementSameClientBtn = document.getElementById('newStatementSameClientBtn');
    const editingBadge = document.getElementById('editingBadge');
    const whatsAppText = document.getElementById('whatsAppText');
    const copyWhatsAppTextBtn = document.getElementById('copyWhatsAppTextBtn');
    const statementsList = document.getElementById('statementsList');
    const addItemBtn = document.getElementById('addItemBtn');
    const copyLastItemsBtn = document.getElementById('copyLastItemsBtn');
    const newClientNameInput = document.getElementById('newClientName');
    const addClientBtn = document.getElementById('addClientBtn');

    const toggleJsonBtn = document.getElementById('toggleJsonBtn');
    const copyJsonBtn = document.getElementById('copyJsonBtn');
    const jsonText = document.getElementById('jsonText');

    let currentEditingStatementId = null;

    // ===== ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© =====
    function init() {
      renderClientOptions();
      setTodayDateIfEmpty();
      ensureAtLeastOneItemRow();
      refreshStatementsListForSelectedClient();
      updateTotalsAndWhatsApp();
    }

    function renderClientOptions() {
      clientSelect.innerHTML = '';
      state.clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        clientSelect.appendChild(option);
      });
      if (!state.clients.length) return;

      // Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø§Ù„ÙŠØŒ Ø§Ø®ØªØ± Ø§Ù„Ø£ÙˆÙ„
      if (!clientSelect.value) {
        clientSelect.value = state.clients[0].id;
      }
    }

    function setTodayDateIfEmpty() {
      if (!dateInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
      }
    }

    function ensureAtLeastOneItemRow() {
      if (itemsContainer.children.length === 0) {
        addItemRow();
      }
    }

    // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ =====
    function createItemRow(item = {}) {
      const row = document.createElement('div');
      row.className = 'item-row';

      const descInput = document.createElement('input');
      descInput.type = 'text';
      descInput.placeholder = 'ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† ÙˆØªØ­Ø³ÙŠÙ†ØŒ Ø§Ù„Ø­Ù…Ù„Ø§Ù†ØŒ Ø§Ù„Ø¬ÙˆØ§Ø²...)';
      descInput.value = item.description || '';

      const amountInput = document.createElement('input');
      amountInput.type = 'number';
      amountInput.placeholder = 'Ø§Ù„Ù…Ø¨Ù„Øº';
      amountInput.value = item.amount != null ? item.amount : '';

      const currencySelect = document.createElement('select');
      CURRENCIES.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.code;
        opt.textContent = c.label;
        currencySelect.appendChild(opt);
      });
      currencySelect.value = item.currency || 'YER';

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn btn-danger btn-sm';
      deleteBtn.textContent = 'Ø­Ø°Ù';

      deleteBtn.addEventListener('click', () => {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) return;
        row.remove();
        if (itemsContainer.children.length === 0) {
          addItemRow();
        }
        updateTotalsAndWhatsApp();
      });

      [descInput, amountInput, currencySelect].forEach(el => {
        el.addEventListener('input', () => updateTotalsAndWhatsApp());
      });

      row.appendChild(descInput);
      row.appendChild(amountInput);
      row.appendChild(currencySelect);
      row.appendChild(deleteBtn);

      return row;
    }

    function addItemRow(item) {
      const row = createItemRow(item);
      itemsContainer.appendChild(row);
    }

    addItemBtn.addEventListener('click', () => {
      addItemRow();
      updateTotalsAndWhatsApp();
    });

    copyLastItemsBtn.addEventListener('click', () => {
      const clientId = clientSelect.value;
      if (!clientId) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      const clientStatements = state.statements
        .filter(s => s.clientId === clientId)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      if (!clientStatements.length) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù†Ù‡.');
        return;
      }
      const last = clientStatements[clientStatements.length - 1];
      if (!last.items || !last.items.length) {
        alert('Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ù†ÙˆØ¯.');
        return;
      }

      if (!confirm('Ø³ÙŠØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø­Ø§Ù„ÙŠ.\nØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ø³Ø®ØŸ')) {
        return;
      }

      itemsContainer.innerHTML = '';
      last.items.forEach(item => addItemRow({
        description: item.description,
        amount: item.amount,
        currency: item.currency
      }));
      updateTotalsAndWhatsApp();
    });

    function getItemsFromDom() {
      const items = [];
      const rows = itemsContainer.querySelectorAll('.item-row');
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        const description = inputs[0].value.trim();
        const amountStr = inputs[1].value.trim();
        const currency = inputs[2].value;
        if (!description && !amountStr) return;
        const amount = amountStr ? Number(amountStr) : 0;
        items.push({ description, amount, currency });
      });
      return items;
    }

    function calculateTotals(items) {
      const totals = {};
      items.forEach(item => {
        if (!item.currency) return;
        const amount = Number(item.amount) || 0;
        if (!totals[item.currency]) totals[item.currency] = 0;
        totals[item.currency] += amount;
      });
      return totals;
    }

    function updateTotalsAndWhatsApp() {
      const items = getItemsFromDom();
      const totals = calculateTotals(items);

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
      if (Object.keys(totals).length === 0) {
        totalsDisplay.textContent = '';
      } else {
        const parts = Object.entries(totals).map(
          ([code, value]) => `${formatNumber(value)} ${currencyLabel(code)}`
        );
        totalsDisplay.innerHTML = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + parts.map(p => `<span>${p}</span>`).join(' + ');
      }

      // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
      updateWhatsAppText(items, totals);
    }

    // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =====
    addClientBtn.addEventListener('click', () => {
      const name = newClientNameInput.value.trim();
      if (!name) {
        alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }

      // Ø¥Ù†Ø´Ø§Ø¡ id Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„Ø§Ø³Ù…
      const idBase = name.replace(/\s+/g, '_').replace(/[^\w]/g, '').toLowerCase() || 'client';
      let id = idBase;
      let suffix = 1;
      while (state.clients.some(c => c.id === id)) {
        id = `${idBase}_${suffix++}`;
      }

      state.clients.push({ id, name });
      saveState();
      renderClientOptions();
      clientSelect.value = id;
      newClientNameInput.value = '';
      refreshStatementsListForSelectedClient();
      updateWhatsAppText(getItemsFromDom(), calculateTotals(getItemsFromDom()));
      alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„.');
    });

    clientSelect.addEventListener('change', () => {
      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ù†Ø®Ø±Ø¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆÙ†ÙØ±Ù‘Øº Ø§Ù„Ø¨Ù†ÙˆØ¯
      exitEditingMode();
      itemsContainer.innerHTML = '';
      ensureAtLeastOneItemRow();
      notesInput.value = '';
      titleInput.value = '';
      refreshStatementsListForSelectedClient();
      updateTotalsAndWhatsApp();
    });

    // ===== Ø­ÙØ¸ / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ´ÙˆÙ =====
    function generateStatementId() {
      return 'st_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
    }

    function getClientNameById(id) {
      const c = state.clients.find(c => c.id === id);
      return c ? c.name : '';
    }

    function saveOrUpdateStatement() {
      const clientId = clientSelect.value;
      if (!clientId) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }

      const items = getItemsFromDom();
      if (!items.length) {
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§.');
        return;
      }

      const date = dateInput.value || '';
      const title = titleInput.value.trim();
      const notes = notesInput.value.trim();
      const totals = calculateTotals(items);
      const now = new Date().toISOString();

      if (currentEditingStatementId) {
        // ØªØ¹Ø¯ÙŠÙ„
        const stIndex = state.statements.findIndex(s => s.id === currentEditingStatementId);
        if (stIndex === -1) {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù.');
          exitEditingMode();
          return;
        }

        const ok = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´ÙØŸ');
        if (!ok) return;

        const old = state.statements[stIndex];
        state.statements[stIndex] = {
          ...old,
          clientId,
          date,
          title,
          notes,
          items,
          totalByCurrency: totals,
          updatedAt: now
        };

        saveState();
        refreshStatementsListForSelectedClient();
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
      } else {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
        const newStatement = {
          id: generateStatementId(),
          clientId,
          date,
          title,
          notes,
          items,
          totalByCurrency: totals,
          createdAt: now,
          updatedAt: now
        };
        state.statements.push(newStatement);
        saveState();
        refreshStatementsListForSelectedClient();
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯.');
      }

      exitEditingMode();
    }

    saveStatementBtn.addEventListener('click', saveOrUpdateStatement);

    newStatementSameClientBtn.addEventListener('click', () => {
      exitEditingMode();
      // Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆÙ†ÙØ±Øº Ø§Ù„Ø¨Ø§Ù‚ÙŠ
      titleInput.value = '';
      notesInput.value = '';
      itemsContainer.innerHTML = '';
      ensureAtLeastOneItemRow();
      updateTotalsAndWhatsApp();
    });

    function enterEditingMode(statementId) {
      currentEditingStatementId = statementId;
      editingBadge.style.display = 'inline-flex';
      saveStatementBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù';
    }

    function exitEditingMode() {
      currentEditingStatementId = null;
      editingBadge.style.display = 'none';
      saveStatementBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„';
    }

    // ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ´ÙˆÙ Ù„Ù„Ø¹Ù…ÙŠÙ„ =====
    function refreshStatementsListForSelectedClient() {
      const clientId = clientSelect.value;
      statementsList.innerHTML = '';
      if (!clientId) return;

      const list = state.statements
        .filter(s => s.clientId === clientId)
        .sort((a, b) => {
          const ad = a.date || '';
          const bd = b.date || '';
          if (ad === bd) return (a.createdAt || '').localeCompare(b.createdAt || '');
          return ad.localeCompare(bd);
        });

      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'statement-item';
        empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
        statementsList.appendChild(empty);
        return;
      }

      list.forEach(st => {
        const item = document.createElement('div');
        item.className = 'statement-item';

        const header = document.createElement('div');
        header.className = 'statement-item-header';

        const titleSpan = document.createElement('div');
        titleSpan.className = 'statement-item-title';
        titleSpan.textContent = st.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';

        const dateSpan = document.createElement('div');
        dateSpan.className = 'statement-item-meta';
        dateSpan.textContent = st.date || '';

        header.appendChild(titleSpan);
        header.appendChild(dateSpan);

        const totalsSpan = document.createElement('div');
        totalsSpan.className = 'statement-item-meta';

        const totals = st.totalByCurrency || calculateTotals(st.items || []);
        const parts = Object.entries(totals).map(
          ([code, value]) => `${formatNumber(value)} ${currencyLabel(code)}`
        );
        totalsSpan.textContent = parts.join(' + ');

        item.appendChild(header);
        item.appendChild(totalsSpan);

        item.addEventListener('click', () => {
          loadStatementIntoForm(st.id);
        });

        statementsList.appendChild(item);
      });
    }

    function loadStatementIntoForm(statementId) {
      const st = state.statements.find(s => s.id === statementId);
      if (!st) return;

      clientSelect.value = st.clientId;
      dateInput.value = st.date || '';
      titleInput.value = st.title || '';
      notesInput.value = st.notes || '';

      itemsContainer.innerHTML = '';
      (st.items || []).forEach(item => addItemRow(item));
      ensureAtLeastOneItemRow();

      enterEditingMode(statementId);
      updateTotalsAndWhatsApp();
    }

    // ===== Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ =====
    function updateWhatsAppText(items, totals) {
      const clientId = clientSelect.value;
      const clientName = getClientNameById(clientId) || 'Ø¹Ù…ÙŠÙ„';
      const dateStr = dateInput.value || '';
      const title = titleInput.value.trim();
      const notes = notesInput.value.trim();

      let lines = [];
      lines.push(`ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙŠÙˆÙ…ÙŠ â€” ${clientName}`);
      if (dateStr) lines.push(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateStr}`);
      if (title) lines.push(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${title}`);
      lines.push('--------------------------');

      if (!items.length) {
        lines.push('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø¨Ø¹Ø¯.');
      } else {
        items.forEach((item, idx) => {
          const n = idx + 1;
          const amt = formatNumber(item.amount || 0);
          const cur = currencyLabel(item.currency || 'YER');
          const desc = item.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ';
          lines.push(`${n}- ${desc}: ${amt} ${cur}`);
        });
      }

      lines.push('--------------------------');
      if (totals && Object.keys(totals).length) {
        const totalParts = Object.entries(totals).map(
          ([code, value]) => `${formatNumber(value)} ${currencyLabel(code)}`
        );
        lines.push('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + totalParts.join(' + '));
      } else {
        lines.push('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0');
      }

      if (notes) {
        lines.push('--------------------------');
        lines.push('Ù…Ù„Ø§Ø­Ø¸Ø§Øª:');
        lines.push(notes);
      }

      whatsAppText.value = lines.join('\n');
    }

    copyWhatsAppTextBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(whatsAppText.value);
        alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© âœ…');
      } catch (e) {
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ‘Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹.');
      }
    });

    // ===== Ù„ÙˆØ­Ø© JSON =====
    function refreshJsonPanelIfVisible() {
      if (jsonText.style.display !== 'none') {
        jsonText.value = JSON.stringify(state, null, 2);
      }
    }

    toggleJsonBtn.addEventListener('click', () => {
      if (jsonText.style.display === 'none') {
        jsonText.style.display = 'block';
        jsonText.value = JSON.stringify(state, null, 2);
        toggleJsonBtn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª JSON';
      } else {
        jsonText.style.display = 'none';
        toggleJsonBtn.textContent = 'Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª JSON';
      }
    });

    copyJsonBtn.addEventListener('click', async () => {
      if (jsonText.style.display === 'none') {
        jsonText.value = JSON.stringify(state, null, 2);
      }
      try {
        await navigator.clipboard.writeText(jsonText.value);
        alert('ØªÙ… Ù†Ø³Ø® JSON Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© âœ…');
      } catch (e) {
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
      }
    });

    // ===== ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
    init();
  </script>
</body>
</html>
