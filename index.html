<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#16a34a" />

  <style>
    * { box-sizing: border-box; }
    :root {
      --green: #16a34a;
      --green-dark: #15803d;
      --red: #dc2626;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius-lg: 14px;
      --radius-md: 10px;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    .app-shell {
      max-width: 950px;
      margin: 0 auto;
      padding: 16px 10px 40px;
    }
    h1 {
      text-align: center;
      font-size: 1.3rem;
      margin: 8px 0 4px;
    }
    .subtitle {
      text-align: center;
      font-size: .8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .install-bar { text-align: center; margin-bottom: 10px; }
    #installButton {
      display: none;
      background: #0f172a;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: .8rem;
      cursor: pointer;
    }

    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 3px;
      margin-bottom: 12px;
    }
    .tab {
      text-align: center;
      padding: 8px 4px;
      border-radius: 999px;
      cursor: pointer;
      font-size: .9rem;
    }
    .tab.active { background: var(--green); color: #fff; }

    .card {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 12px;
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
      border: 1px solid var(--border);
      margin-bottom: 14px;
    }

    label { display: block; font-size: .8rem; color: var(--text-muted); margin-bottom: 3px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .row > * { flex: 1; }

    input, select, textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: .85rem;
    }
    textarea { border-radius: var(--radius-md); min-height: 48px; resize: vertical; }
    input:focus, select:focus, textarea:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 1px rgba(34,197,94,.35);
      background: #fff;
      outline: none;
    }

    .entries { display: flex; flex-direction: column; gap: 6px; }
    .entry-row { display: flex; gap: 6px; align-items: center; }
    .entry-desc { flex: 4; }
    .entry-amount { flex: 2.5; }
    .entry-curr { flex: 1.2; }
    .entry-dir { flex: 1.2; }
    .entry-del { flex: 0; }

    @media (max-width: 640px) {
      .entry-row { flex-wrap: wrap; }
      .entry-desc { flex: 1 1 100%; }
      .entry-amount { flex: 1 1 45%; }
      .entry-curr { flex: 1 1 25%; }
      .entry-dir { flex: 1 1 25%; }
    }

    .pill-btn { border-radius: 999px; border: none; cursor: pointer; padding: 7px 14px; font-size: .8rem; }
    .pill-green { background: var(--green); color:#fff; }
    .pill-red   { background: var(--red);   color:#fff; }
    .pill-gray  { background:#e5e7eb; }
    .pill-dark  { background:#0f172a; color:#fff; }

    /* Ø²Ø± Ø§Ù„ØµÙˆØª Ù„ÙƒÙ„ Ø¨Ù†Ø¯ */
    .entry-voice-btn {
      background: var(--green-dark);
      color: #fff;
      padding: 6px 10px;
      font-size: .75rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }

    .section-title { font-size:.9rem; font-weight:600; margin-bottom:6px; }
    .muted { color:var(--text-muted); font-size:.78rem; }

    .whatsapp-box {
      width:100%; min-height:90px; border-radius:var(--radius-md);
      padding:8px; font-size:.8rem; border:1px dashed var(--border);
      background:#f9fafb; white-space:pre-wrap;
    }

    .saved-list { max-height:220px; overflow-y:auto; }
    .saved-item {
      background:#ecfdf3; border-radius:999px; padding:6px 10px; margin-bottom:4px;
      display:flex; justify-content:space-between; align-items:center; cursor:pointer;
      border:1px solid #bbf7d0; font-size:.8rem;
    }

    /* Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø§Ù„ÙƒØ´ÙˆÙØ§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡) */
    .saved-item .delete-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
      padding: 0 4px;
      color: var(--text-muted);
    }
    .saved-item .delete-btn:hover {
      color: var(--red);
    }

    .totals-box {
      background:#f0fdf4; border-radius:var(--radius-md);
      border:1px solid #bbf7d0; padding:8px 10px; white-space:pre-wrap;
      font-size:.8rem;
    }

    .footer-hint { text-align:center; font-size:.7rem; color:var(--text-muted); }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.78rem;
      border-radius:999px;
      padding:4px 10px;
      background:#e5e7eb;
      color:#374151;
      white-space:nowrap;
    }
    .badge.locked { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .badge.unlocked { background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }

    .search-input {
      border-radius:999px;
      padding-inline-start:30px;
      position:relative;
    }
    .search-wrapper { position:relative; }
    .search-wrapper span {
      position:absolute;
      inset-inline-start:10px;
      top:50%;
      transform:translateY(-50%);
      font-size:.8rem;
      color:var(--text-muted);
    }

    .report-box {
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:#f9fafb;
      padding:10px;
      font-size:.8rem;
      white-space:normal;
    }

    .report-box table {
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:.8rem;
    }
    .report-box th,
    .report-box td {
      border:1px solid #ddd;
      padding:4px 6px;
      text-align:center;
    }
    .report-box th {
      background:#e5e7eb;
      font-weight:600;
    }

    /* Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù ÙÙŠ ØªÙ‚Ø±ÙŠØ± "Ù…Ù„Ø®Øµ Ù„ÙƒÙ„ ÙƒØ´Ù" */
    .report-box .col-date {
      white-space: nowrap;
      width: 14%;
    }
    .report-box .col-title {
      width: 32%;
    }

    /* Ù…Ø¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù‚ÙÙ„ */
    .locked-mask {
      opacity: .65;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <h1>ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    <p class="subtitle">Ø­ÙØ¸ ÙƒØ´ÙˆÙØ§Øª Ø¹Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø­Ø³Ø§Ø¨).</p>

    <!-- Ø²Ø± Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„ØµÙˆØªÙŠ -->
    <div style="text-align:center; margin:15px 0;">
      <button id="voiceAssistantBtn"
              style="background:#15803d; color:white; padding:12px 22px;
                     border:none; border-radius:50px; font-size:1.1rem;">
          ğŸ¤ Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„ØµÙˆØªÙŠ
      </button>
    </div>

    <div class="install-bar">
      <button id="installButton">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“±</button>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabStatements">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</div>
      <div class="tab" id="tabClients">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
      <div class="tab" id="tabReports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
    <div id="screenStatements">

      <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù‚ÙÙ„ -->
      <div class="card">
        <div class="row" style="align-items:center;">
          <div style="flex:2;">
            <span id="lockBadge" class="badge unlocked">ğŸ”“ Ø§Ù„ÙƒØ´Ù Ù…ÙØªÙˆØ­ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</span>
            <div class="muted" id="lockHint" style="margin-top:4px;">
              Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø³ÙŠØªÙ… Ù‚ÙÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ù„ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø§Ø¶ØºØ· Ø²Ø± "ÙØªØ­ Ø§Ù„Ù‚ÙÙ„".
            </div>
          </div>
          <div style="flex:1; display:flex; gap:8px;">
            <button class="pill-btn pill-dark" id="unlockBtn" style="flex:1;">ğŸ”“ ÙØªØ­ Ø§Ù„Ù‚ÙÙ„</button>
            <button class="pill-btn pill-gray" id="lockNowBtn" style="flex:1;">ğŸ”’ Ù‚ÙÙ„ Ø§Ù„Ø¢Ù†</button>
          </div>
        </div>
      </div>

      <div class="card" id="editCard">

        <div class="row">
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input type="text" id="clientName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="statementDate">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
            <input type="text" id="statementTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† Ø´Ø­Ù†Ø©ØŒ ØªØ³ÙˆÙŠØ© Ø­Ø³Ø§Ø¨...">
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‚Ø§Ø·Ø±Ø©:</label>
            <input type="text" id="truckNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚Ø§Ø·Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù†:</label>
            <input type="text" id="statementNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          </div>
        </div>

        <label class="section-title">ğŸ§¾ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</label>
        <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ¯ (Ø¹Ù„ÙŠÙ‡ / Ù„Ù‡) ÙˆØ§Ù„Ø¹Ù…Ù„Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº.</p>

        <div class="row" id="entriesButtonsRow">
          <button class="pill-btn pill-green" id="addEntryBtn">+ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
          <button class="pill-btn pill-gray" id="copyLastEntriesBtn">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù</button>
          <button class="pill-btn pill-gray" id="copyFromOldEntriesBtn">ğŸ—‚ï¸ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† ÙƒØ´Ù Ø³Ø§Ø¨Ù‚</button>
        </div>

        <div id="entriesContainer" class="entries"></div>

        <div class="row">
          <div>
            <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="text" id="manualTotal" placeholder="Ù…Ø«Ø§Ù„: 2,300 Ø³Ø¹ÙˆØ¯ÙŠ + 3,326,706 ÙŠÙ…Ù†ÙŠ">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <textarea id="extraNotes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ´Ù"></textarea>
          </div>
        </div>

        <div class="row">
          <button class="pill-btn pill-green" id="saveStatementBtn" style="flex:1;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù</button>
          <button class="pill-btn pill-gray" id="newStatementSameClientBtn" style="flex:1;">+ ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        </div>

      </div>

      <div class="card">
        <label class="section-title">ğŸ’¬ Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨:</label>
        <div id="whatsAppText" class="whatsapp-box"></div>

        <div class="row">
          <button class="pill-btn pill-gray" id="copyTextBtn" style="flex:1;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
          <button class="pill-btn pill-green" id="shareWhatsappBtn" style="flex:1;">ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>

        <div class="row" style="margin-top:6px;">
          <button class="pill-btn pill-gray" id="printPdfBtn" style="flex:1;">ğŸ–¨ï¸ Ø­ÙØ¸ / Ø·Ø¨Ø§Ø¹Ø© PDF</button>
          <button class="pill-btn pill-green" id="sharePdfBtn" style="flex:1;">ğŸ“„ Ù…Ø´Ø§Ø±ÙƒØ© PDF</button>
        </div>
      </div>

      <div class="card">
        <label class="section-title">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª:</label>
        <p class="muted">Ø§Ø¶ØºØ· Ù„ÙØªØ­ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ (Ø³ÙŠÙÙØªØ­ Ù…Ù‚ÙÙˆÙ„ Ù„Ù„Ø­Ù…Ø§ÙŠØ©). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø§Ø·Ø±Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.</p>

        <div class="row">
          <div class="search-wrapper">
            <span>ğŸ”</span>
            <input id="statementsSearchInput" class="search-input" type="text"
                   placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø§Ø·Ø±Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
          </div>
        </div>

        <div class="row" style="margin-top:4px;">
          <label style="display:flex; align-items:center; gap:6px; font-size:.8rem;">
            <input type="checkbox" id="multiSelectToggle" style="width:16px;height:16px;margin:0;">
            ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø© ÙƒØ´ÙˆÙ
          </label>
          <button class="pill-btn pill-green" id="shareMultiPdfBtn" style="flex:1;">ğŸ“‘ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙƒØ´ÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© PDF</button>
        </div>

        <p class="muted" id="multiSelectHint" style="display:none; margin-top:4px;">
          Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ´ÙˆÙ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ (âœ”)ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø²Ø± "Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙƒØ´ÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© PDF".
        </p>

        <div id="statementsList" class="saved-list"></div>
      </div>

      <div class="card">
        <label class="section-title">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <div id="totalsBox" class="totals-box">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„Ù„Ø¹Ù…ÙŠÙ„.
        </div>
      <div class="card" id="accountMovementsCard">
        <label class="section-title">ğŸ’° Ø­Ø±ÙƒØ§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø¬Ø± (Ø­ÙˆØ§Ù„Ø§Øª/Ø³Ø¯Ø§Ø¯/Ù…ØµØ±ÙˆÙ)</label>
        <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù…Ø³ØªÙ‚Ù„Ø© Ø¹Ù† Ø§Ù„ÙƒØ´ÙˆÙØ§Øª. Ù„ÙƒÙ„ Ø­Ø±ÙƒØ© ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯Ù‡Ø§ (Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø©).</p>
        <div class="row">
          <div style="flex:2;">
            <label>Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±:</label>
            <input id="movClientName" type="text" list="clientsDatalist" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±" />
          </div>
          <div style="display:flex;align-items:flex-end;">
            <button class="pill-btn pill-dark" id="movLoadBtn" type="button" style="height:42px;">ğŸ”„ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±ÙƒØ§Øª</button>
          </div>
        </div>


        <div class="row">
          <div style="flex:2;">
            <label>Ø§Ù„Ø¨Ù†Ø¯ / Ø§Ù„ÙˆØµÙ:</label>
            <input id="mvDesc" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø­ÙˆØ§Ù„Ø© Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± / Ø³Ø¯Ø§Ø¯ / Ù…ØµØ±ÙˆÙ..." />
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø¨Ù„Øº:</label>
            <input id="mvAmount" type="tel" inputmode="numeric" placeholder="0" />
          </div>
          <div>
            <label>Ø§Ù„Ø¹Ù…Ù„Ø©:</label>
            <select id="mvCurr">
              <option value="ÙŠÙ…Ù†ÙŠ">ÙŠÙ…Ù†ÙŠ</option>
              <option value="Ø³Ø¹ÙˆØ¯ÙŠ">Ø³Ø¹ÙˆØ¯ÙŠ</option>
              <option value="Ø¯Ø±Ù‡Ù…">Ø¯Ø±Ù‡Ù…</option>
              <option value="Ø¯ÙˆÙ„Ø§Ø±">Ø¯ÙˆÙ„Ø§Ø±</option>
              <option value="Ø¹Ù…Ø§Ù†ÙŠ">Ø¹Ù…Ø§Ù†ÙŠ</option>
            </select>
          </div>
          <div>
            <label>Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡:</label>
            <select id="mvDir">
              <option value="Ù„Ù‡">Ù„Ù‡</option>
              <option value="Ø¹Ù„ÙŠÙ‡">Ø¹Ù„ÙŠÙ‡</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input id="mvDate" type="date" />
          </div>
        </div>

        <div class="row">
          <button class="pill-btn pill-green" id="addMovementBtn" style="flex:1;">â• Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</button>
          <button class="pill-btn pill-gray" id="clearMovementsForClientBtn" style="flex:1;">ğŸ§¹ Ù…Ø³Ø­ Ø­Ø±ÙƒØ§Øª Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±</button>
        </div>

        <div id="movementsSummaryBox" class="totals-box" style="margin-top:8px;">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯.
        </div>

        <div id="movementsTable" class="report-box" style="margin-top:10px;">
          <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </div>
      </div>


      </div>

      <div class="card">
        <label class="section-title">ğŸ—„ï¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
        <p class="muted">ØªØ³ØªØ·ÙŠØ¹ ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª ÙÙŠ Ù…Ù„Ù JSON Ø«Ù… Ø­ÙØ¸Ù‡ ÙÙŠ Google Drive Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù†ÙØ³ÙƒØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡.</p>
        <div class="row">
          <button class="pill-btn pill-green" id="exportBackupBtn" style="flex:1;">ğŸ“¤ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
          <button class="pill-btn pill-gray" id="importBackupBtn" style="flex:1;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        </div>
        <input type="file" id="backupFileInput" accept="application/json" style="display:none;">

        <hr style="border:none;border-top:1px solid var(--border); margin:12px 0;">

        <label class="section-title">â° Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙŠÙˆÙ…ÙŠØ© (12:00)</label>
        <p class="muted">
          Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ØªÙØ­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø²ÙŠÙ„ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù…Ù„Ù JSON ÙˆÙ‚Øª Ù…Ø§ ØªØ±ÙŠØ¯.
        </p>

        <div class="row">
          <div>
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:</label>
            <select id="autoBackupToggle">
              <option value="on">Ù…ÙØ¹Ù„ âœ…</option>
              <option value="off">Ù…ÙˆÙ‚Ù âŒ</option>
            </select>
          </div>
          <div>
            <label>Ø¢Ø®Ø± Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:</label>
            <div id="autoBackupStatus" class="totals-box" style="min-height:auto; white-space:normal;">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯.
            </div>
          </div>
        </div>

        <div class="row">
          <button class="pill-btn pill-green" id="downloadLastAutoBackupBtn" style="flex:1;">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</button>
          <button class="pill-btn pill-gray" id="clearAutoBackupsBtn" style="flex:1;">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</button>
        </div>
      </div>

      <div class="footer-hint">
        Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ Ø§Ø³ØªØ®Ø¯Ù… "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div id="screenClients" style="display:none;">
      <div class="card">
        <label class="section-title">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</label>
        <p class="muted">Ø¥Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù„Ø¹Ø±Ø¶ ÙƒØ´ÙˆÙØ§ØªÙ‡ Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù….</p>

        <div class="row">
          <div class="search-wrapper">
            <span>ğŸ”</span>
            <input id="clientsSearchInput" class="search-input" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
          </div>
        </div>

        <div id="clientsList" class="saved-list"></div>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="screenReports" style="display:none;">
      <div class="card">
        <label class="section-title">ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„</label>
        <p class="muted">
          Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ­Ø¯Ù‘Ø¯ ÙØªØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§) Ù„Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡ ÙˆØ§Ù„ØµØ§ÙÙŠ Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø©ØŒ
          Ø£Ùˆ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ù„ÙƒÙ„ ÙƒØ´Ù Ø¹Ù„Ù‰ Ø­Ø¯Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø¬Ø¯ÙˆÙ„.
        </p>

        <div class="row">
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <select id="reportClientSelect">
              <option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="date" id="reportFrom">
          </div>
          <div>
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="date" id="reportTo">
          </div>
        </div>

        <div class="row">
          <button class="pill-btn pill-green" id="buildReportBtn" style="flex:1;">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø©</button>
          <button class="pill-btn pill-gray" id="buildDetailedReportBtn" style="flex:1;">ğŸ“‘ ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ù„ÙƒÙ„ ÙƒØ´Ù (Ø¬Ø¯ÙˆÙ„)</button>
        </div>

        <div id="reportBox" class="report-box">
          Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ø¨Ø¹Ø¯. Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.
        </div>

        <div class="row" style="margin-top:6px;">
          <button class="pill-btn pill-gray" id="copyReportBtn" style="flex:1;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button class="pill-btn pill-green" id="shareReportWhatsappBtn" style="flex:1;">ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>

        <div class="row" style="margin-top:6px;">
          <button class="pill-btn pill-gray" id="printReportPdfBtn" style="flex:1;">ğŸ–¨ï¸ Ø­ÙØ¸ / Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Ø­Ø§ÙˆÙŠØ§Øª Ù…Ø®ÙÙŠØ© Ù„ØªÙˆÙ„ÙŠØ¯ PDF -->
  <div id="singlePdfContainer" style="position:fixed; left:-99999px; top:0; width:800px; background:#ffffff;"></div>
  <div id="multiPdfContainer"  style="position:fixed; left:-99999px; top:0; width:800px; background:#ffffff;"></div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª ØªÙˆÙ„ÙŠØ¯ PDF (Ù…Ø¬Ø§Ù†ÙŠØ©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Ù…Ù„Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ -->
  <script src="voice.js"></script>

  <script>
    const STORAGE_KEY = "voiceLedgerData_v1";

    // Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    const AUTO_BACKUPS_KEY = "voiceLedgerAutoBackups_v1";
    const AUTO_BACKUP_PREF_KEY = "voiceLedgerAutoBackupPref_v1";
    const AUTO_BACKUP_LASTRUN_KEY = "voiceLedgerAutoBackupLastRun_v1";

    // ===== Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø­ÙˆØ§Ù„Ø§Øª/Ø³Ø¯Ø§Ø¯...) Ù„ÙƒÙ„ ØªØ§Ø¬Ø± =====
    const MOVEMENTS_KEY = "voiceLedgerMovements_v1";


    const state = {
      data:{clients:{}},
      currentClient:"",
      currentStatementId:null,
      currentStatementLocked:false,
      deferredPrompt:null,
      multiSelectEnabled:false,
      selectedStatements:[]
    };

    function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw) state.data = JSON.parse(raw);
      }catch(e){ console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†",e); }
    }
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }

    function getAutoBackups(){
      try{
        return JSON.parse(localStorage.getItem(AUTO_BACKUPS_KEY) || "[]");
      }catch(_){ return []; }
    }
    function setAutoBackups(arr){
      localStorage.setItem(AUTO_BACKUPS_KEY, JSON.stringify(arr));
    }

    

    // ===== Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨: ØªØ®Ø²ÙŠÙ† Ù…Ø³ØªÙ‚Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ STORAGE_KEY Ø§Ù„Ù‚Ø¯ÙŠÙ… =====
    function loadMovementsStore(){
      try{
        return JSON.parse(localStorage.getItem(MOVEMENTS_KEY) || "{}");
      }catch(_){
        return {};
      }
    }
    function saveMovementsStore(obj){
      localStorage.setItem(MOVEMENTS_KEY, JSON.stringify(obj));
    }

    function getMovementsForClient(name){
      const store = loadMovementsStore();
      const arr = store[name];
      return Array.isArray(arr) ? arr : [];
    }

    function setMovementsForClient(name, arr){
      const store = loadMovementsStore();
      store[name] = Array.isArray(arr) ? arr : [];
      saveMovementsStore(store);
    }

    function addMovementForClient(name, mv){
      const arr = getMovementsForClient(name);
      arr.push(mv);
      // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø«Ù… ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø¶Ù…Ø§Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ ØµØ­ÙŠØ­
      arr.sort((a,b)=>{
        const da = (a.date || "");
        const db = (b.date || "");
        if (da && db) {
          const cmp = da.localeCompare(db); // ØªØµØ§Ø¹Ø¯ÙŠ: Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹
          if (cmp !== 0) return cmp;
        } else if (db) return -1;
        else if (da) return 1;
        return (a.ts||0) - (b.ts||0);
      });
      setMovementsForClient(name, arr);
    }

    function deleteMovementForClient(name, ts){
      const arr = getMovementsForClient(name).filter(m => (m.ts||0) !== ts);
      setMovementsForClient(name, arr);
    }

    function clearMovementsForClient(name){
      setMovementsForClient(name, []);
    }

    function filterByDateRange(items, fromDate, toDate){
      if(!fromDate && !toDate) return items.slice();
      const from = fromDate ? new Date(fromDate) : null;
      const to   = toDate   ? new Date(toDate)   : null;

      return items.filter(m=>{
        const d = m.date ? new Date(m.date) : null;
        if(!d) return true; // Ù„Ùˆ Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® Ù†Ø®Ù„ÙŠÙ‡ ÙŠØ¸Ù‡Ø±
        if(from && d < from) return false;
        if(to && d > to) return false;
        return true;
      });
    }

    function computeMovementTotalsPerCurrency(movements){
      const t = {};
      movements.forEach(m=>{
        const c = m.currency || "";
        if(!t[c]) t[c] = {lah:0, alaih:0, balance:0};
        const amt = Number(m.amount||0) || 0;
        if(m.direction === "Ù„Ù‡"){
          t[c].lah += amt;
          t[c].balance += amt;
        }else{
          t[c].alaih += amt;
          t[c].balance -= amt;
        }
      });
      return t;
    }

    function renderMovementsForClient(name){
      const tableEl = document.getElementById("movementsTable");
      const sumEl   = document.getElementById("movementsSummaryBox");
      if(!tableEl || !sumEl) return;

      if(!name){
        sumEl.textContent = "Ø§Ø®ØªØ±/Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£ÙˆÙ„Ø§Ù‹.";
        tableEl.innerHTML = "";
        return;
      }

      const arr = getMovementsForClient(name);
      if(!arr.length){
        sumEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯.";
        tableEl.innerHTML = "";
        return;
      }

      // Ù…Ù„Ø®Øµ
      const totals = computeMovementTotalsPerCurrency(arr);
      let s = "";
      Object.keys(totals).forEach(c=>{
        const x = totals[c];
        s += `${c}:\nÙ„Ù‡: ${x.lah}\nØ¹Ù„ÙŠÙ‡: ${x.alaih}\nØ§Ù„Ø±ØµÙŠØ¯: ${x.balance}\n\n`;
      });
      sumEl.textContent = s.trim() || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯.";

      // Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø±ØµÙŠØ¯ ØªØ±Ø§ÙƒÙ…ÙŠ Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø©
      const running = {};
      let html = `
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø¨Ù†Ø¯</th>
              <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
              <th>Ù„Ù‡</th>
              <th>Ø¹Ù„ÙŠÙ‡</th>
              <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody>`;

      arr.forEach(m=>{
        const c = m.currency || "";
        if(running[c] == null) running[c] = 0;
        const amt = Number(m.amount||0) || 0;
        const lah  = (m.direction === "Ù„Ù‡") ? amt : 0;
        const alaih= (m.direction === "Ø¹Ù„ÙŠÙ‡") ? amt : 0;
        running[c] += (m.direction === "Ù„Ù‡") ? amt : -amt;

        const safeDesc = (m.desc || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        html += `
          <tr>
            <td class="col-date">${m.date || ""}</td>
            <td style="text-align:right;">${safeDesc || "Ø­Ø±ÙƒØ©"}</td>
            <td>${c}</td>
            <td>${lah || ""}</td>
            <td>${alaih || ""}</td>
            <td>${running[c]}</td>
            <td><button class="pill-btn pill-red" style="padding:4px 10px;" onclick="window.__delMv('${name.replace(/'/g,"\\'")}', ${m.ts||0})">ğŸ—‘ï¸</button></td>
          </tr>`;
      });

      html += `</tbody></table>`;
      tableEl.innerHTML = html;
    }

const tabStatements = document.getElementById("tabStatements");
    const tabClients    = document.getElementById("tabClients");
    const tabReports    = document.getElementById("tabReports");
    const screenStatements = document.getElementById("screenStatements");
    const screenClients    = document.getElementById("screenClients");
    const screenReports    = document.getElementById("screenReports");

    tabStatements.onclick = () => showScreen("s");
    tabClients.onclick    = () => showScreen("c");
    tabReports.onclick    = () => showScreen("r");

    function showScreen(t){
      if(t==="s"){
        screenStatements.style.display = "";
        screenClients.style.display    = "none";
        screenReports.style.display    = "none";
        tabStatements.classList.add("active");
        tabClients.classList.remove("active");
        tabReports.classList.remove("active");
      } else if(t==="c"){
        screenStatements.style.display = "none";
        screenClients.style.display    = "";
        screenReports.style.display    = "none";
        tabStatements.classList.remove("active");
        tabClients.classList.add("active");
        tabReports.classList.remove("active");
        renderClientsList();
      } else {
        screenStatements.style.display = "none";
        screenClients.style.display    = "none";
        screenReports.style.display    = "";
        tabStatements.classList.remove("active");
        tabClients.classList.remove("active");
        tabReports.classList.add("active");
        renderReportsClientOptions();
      renderClientsDatalist();

      // âœ… ØªØ±Ø­ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      showScreen("reports");
      reportClientSelect.value = name;
      buildDetailedReport();


    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
    if (mvDateInput) mvDateInput.value = new Date().toISOString().slice(0,10);
    renderMovementsForClient(clientNameInput.value.trim());

      }
    }

    const clientNameInput      = document.getElementById("clientName");
    const dateInput            = document.getElementById("statementDate");
    const titleInput           = document.getElementById("statementTitle");
    const truckNumberInput     = document.getElementById("truckNumber");
    const statementNumberInput = document.getElementById("statementNumber");
    const entriesContainer     = document.getElementById("entriesContainer");
    const manualTotalInput     = document.getElementById("manualTotal");
    const extraNotesInput      = document.getElementById("extraNotes");
    const whatsAppBox          = document.getElementById("whatsAppText");
    const statementsListEl     = document.getElementById("statementsList");
    const totalsBoxEl          = document.getElementById("totalsBox");
    const clientsListEl        = document.getElementById("clientsList");
    const clientsSearchInput   = document.getElementById("clientsSearchInput");
    const statementsSearchInput= document.getElementById("statementsSearchInput");

    const multiSelectToggle = document.getElementById("multiSelectToggle");
    const shareMultiPdfBtn  = document.getElementById("shareMultiPdfBtn");
    const multiSelectHint   = document.getElementById("multiSelectHint");
    const singlePdfContainer= document.getElementById("singlePdfContainer");
    const multiPdfContainer = document.getElementById("multiPdfContainer");

    const voiceAssistantBtnEl = document.getElementById("voiceAssistantBtn");

    // Ø¹Ù†Ø§ØµØ± Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
    const mvDescInput  = document.getElementById("mvDesc");
    const mvAmountInput= document.getElementById("mvAmount");
    const mvCurrSelect = document.getElementById("mvCurr");
    const mvDirSelect  = document.getElementById("mvDir");
    const mvDateInput  = document.getElementById("mvDate");
    const movClientNameInput = document.getElementById("movClientName");
    const movLoadBtn        = document.getElementById("movLoadBtn");
    const addMovementBtn = document.getElementById("addMovementBtn");
    const clearMovementsForClientBtn = document.getElementById("clearMovementsForClientBtn");



    // Ù‚ÙÙ„
    const lockBadge   = document.getElementById("lockBadge");
    const unlockBtn   = document.getElementById("unlockBtn");
    const lockNowBtn  = document.getElementById("lockNowBtn");
    const editCard    = document.getElementById("editCard");
    const entriesButtonsRow = document.getElementById("entriesButtonsRow");

    // Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const autoBackupToggle = document.getElementById("autoBackupToggle");
    const autoBackupStatus = document.getElementById("autoBackupStatus");
    const downloadLastAutoBackupBtn = document.getElementById("downloadLastAutoBackupBtn");
    const clearAutoBackupsBtn = document.getElementById("clearAutoBackupsBtn");

    document.getElementById("addEntryBtn").onclick              = () => addEntryRow();
    document.getElementById("copyLastEntriesBtn").onclick       = copyLastEntries;
    document.getElementById("copyFromOldEntriesBtn").onclick    = copyEntriesFromPreviousStatement;

    document.getElementById("saveStatementBtn").onclick         = saveCurrentStatement;
    document.getElementById("newStatementSameClientBtn").onclick= () => resetForm(clientNameInput.value);

    document.getElementById("copyTextBtn").onclick              = () => navigator.clipboard.writeText(whatsAppBox.textContent || "");
    document.getElementById("shareWhatsappBtn").onclick         = () => window.open("https://wa.me/?text="+encodeURIComponent(whatsAppBox.textContent || ""));
    document.getElementById("printPdfBtn").onclick              = printAsPdf;
    document.getElementById("sharePdfBtn").onclick              = () => sharePdf();

    // ===== Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨: Ø¥Ø¶Ø§ÙØ©/Ù…Ø³Ø­ =====
    if (mvDateInput) mvDateInput.value = new Date().toISOString().slice(0,10);

    function normalizeNumericInput(el){
      if(!el) return;
      el.addEventListener("input", ()=>{
        let raw = (el.value || "").replace(/[^\d]/g,"");
        el.value = raw ? Number(raw).toLocaleString("en-US") : "";
      });
    }
    normalizeNumericInput(mvAmountInput);

    if (addMovementBtn) addMovementBtn.onclick = () => {
      const name = (movClientNameInput && movClientNameInput.value.trim()) || clientNameInput.value.trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£ÙˆÙ„Ø§Ù‹"); return; }

      const amountRaw = (mvAmountInput.value || "").replace(/,/g,"");
      const amount = +amountRaw || 0;
      if(!amount){ alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­"); return; }

      const mv = {
        ts: Date.now(),
        date: mvDateInput.value || new Date().toISOString().slice(0,10),
        desc: (mvDescInput.value || "").trim() || "Ø­Ø±ÙƒØ©",
        currency: mvCurrSelect.value,
        direction: mvDirSelect.value, // Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡
        amount: amount
      };

      addMovementForClient(name, mv);
      mvDescInput.value = "";
      mvAmountInput.value = "";
      renderMovementsForClient(name);
    };

    // Ø¯Ø§Ù„Ø© Ø­Ø°Ù ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    window.__delMv = (name, ts) => {
      if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ")) {
        deleteMovementForClient(name, ts);
        renderMovementsForClient(name);
      }
    };

    if (clearMovementsForClientBtn) clearMovementsForClientBtn.onclick = () => {
      const name = (movClientNameInput && movClientNameInput.value.trim()) || clientNameInput.value.trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£ÙˆÙ„Ø§Ù‹"); return; }
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ø±ÙƒØ§Øª Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")){
        clearMovementsForClient(name);
        renderMovementsForClient(name);
      }
    };



    clientsSearchInput.addEventListener("input", renderClientsList);
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±
    clientNameInput.addEventListener("input", ()=>{
      renderMovementsForClient(clientNameInput.value.trim());
    });

    // âœ… Ø§Ø®ØªÙŠØ§Ø±/ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù…Ø³ØªÙ‚Ù„ Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„ÙƒØ´ÙˆÙ)
    if(movClientNameInput){
      movClientNameInput.addEventListener("input", ()=>{
        renderMovementsForClient(movClientNameInput.value.trim());
      });
    }
    if(movLoadBtn){
      movLoadBtn.onclick = ()=>{
        const n = (movClientNameInput && movClientNameInput.value.trim()) || clientNameInput.value.trim();
        renderMovementsForClient(n);
      };
    }


    statementsSearchInput.addEventListener("input", renderStatementsList);

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    const reportClientSelect       = document.getElementById("reportClientSelect");
    const reportFromInput          = document.getElementById("reportFrom");
    const reportToInput            = document.getElementById("reportTo");
    const reportBox                = document.getElementById("reportBox");
    const buildDetailedReportBtn   = document.getElementById("buildDetailedReportBtn");

    document.getElementById("buildReportBtn").onclick          = buildReport;
    buildDetailedReportBtn.onclick                             = buildDetailedReport;
    document.getElementById("copyReportBtn").onclick           = () => navigator.clipboard.writeText(reportBox.textContent || "");
    document.getElementById("shareReportWhatsappBtn").onclick  = () => window.open("https://wa.me/?text="+encodeURIComponent(reportBox.textContent || ""));
    document.getElementById("printReportPdfBtn").onclick       = printReportPdf;

    multiSelectToggle.addEventListener("change", () => {
      state.multiSelectEnabled = multiSelectToggle.checked;
      state.selectedStatements = [];
      multiSelectHint.style.display = state.multiSelectEnabled ? "block" : "none";
      renderStatementsList();
    });

    shareMultiPdfBtn.onclick = () => shareSelectedStatementsPdf();

    // ====== Ø§Ù„Ù‚ÙÙ„ ======
    unlockBtn.onclick = () => {
      if (!state.currentStatementId) {
        // ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…Ø­ÙÙˆØ¸: Ù†Ø¹ØªØ¨Ø±Ù‡ Ù…ÙØªÙˆØ­ Ø¯Ø§Ø¦Ù…Ø§Ù‹
        state.currentStatementLocked = false;
        applyLockUI();
        return;
      }
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŸ")) {
        state.currentStatementLocked = false;
        applyLockUI();
      }
    };

    lockNowBtn.onclick = () => {
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚ÙÙ„ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø¢Ù†ØŸ")) {
        state.currentStatementLocked = true;
        // Ù†Ø®Ø²Ù† Ø§Ù„Ù‚ÙÙ„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„ÙƒØ´Ù Ù…Ø­ÙÙˆØ¸
        persistLockToCurrentStatement(true);
        applyLockUI();
      }
    };

    function applyLockUI(){
      const locked = !!state.currentStatementLocked;

      // Badge
      if (locked) {
        lockBadge.className = "badge locked";
        lockBadge.textContent = "ğŸ”’ Ø§Ù„ÙƒØ´Ù Ù…Ù‚ÙÙˆÙ„ (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙ‚Ø·)";
        editCard.classList.add("locked-mask");
      } else {
        lockBadge.className = "badge unlocked";
        lockBadge.textContent = "ğŸ”“ Ø§Ù„ÙƒØ´Ù Ù…ÙØªÙˆØ­ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„";
        editCard.classList.remove("locked-mask");
      }

      // Ù…Ù†Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      const disable = locked;

      // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      [
        clientNameInput, dateInput, titleInput, truckNumberInput, statementNumberInput,
        manualTotalInput, extraNotesInput
      ].forEach(el => { if(el) el.disabled = disable; });

      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯
      if (entriesButtonsRow) {
        entriesButtonsRow.style.display = locked ? "none" : "";
      }

      // Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø§Ù„Ø¨Ù†ÙˆØ¯ + Ø²Ø± Ø§Ù„ØµÙˆØª Ù„Ù„Ø¨Ù†Ø¯ (ÙƒÙ…Ø§Ù† Ù†Ø®ÙÙŠÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù‚ÙÙ„)
      [...entriesContainer.querySelectorAll(".entry-del, .entry-voice-btn")].forEach(btn=>{
        btn.style.display = locked ? "none" : "";
      });

      // Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙˆØ¯
      [...entriesContainer.querySelectorAll("input, select, textarea")].forEach(el=>{
        el.disabled = disable;
      });

      // Ø²Ø± Ø§Ù„Ø­ÙØ¸ (Ù†Ø®ÙÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ù‚ÙÙ„ Ù„Ù…Ù†Ø¹ Ø­ÙØ¸ Ø¨Ø§Ù„ØºÙ„Ø·)
      document.getElementById("saveStatementBtn").style.display = locked ? "none" : "";
    }

    function persistLockToCurrentStatement(locked){
      const name = clientNameInput.value.trim();
      if (!name) return;
      const client = state.data.clients[name];
      if (!client || !client.statements) return;
      const st = client.statements.find(s => s.id === state.currentStatementId);
      if (!st) return;
      st.locked = !!locked;
      saveData();
    }

    // ====== Ø§Ù„Ø¨Ù†Ø¯ ======
    function addEntryRow(init){
      if (state.currentStatementLocked) {
        alert("Ø§Ù„ÙƒØ´Ù Ù…Ù‚ÙÙˆÙ„. Ø§ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯.");
        return;
      }

      const row = document.createElement("div");
      row.className = "entry-row";

      const desc = input("text","ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯");
      desc.className = "entry-desc";

      const amount = document.createElement("input");
      amount.type = "tel";
      amount.inputMode = "numeric";
      amount.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº";
      amount.className = "entry-amount";
      amount.addEventListener("input", () => {
        let raw = amount.value.replace(/[^\d]/g,"");
        if(raw){
          amount.value = Number(raw).toLocaleString("en-US");
        }else{
          amount.value = "";
        }
        updatePreviewText();
      });

      const curr = select(["ÙŠÙ…Ù†ÙŠ","Ø³Ø¹ÙˆØ¯ÙŠ","Ø¯Ø±Ù‡Ù…","Ø¯ÙˆÙ„Ø§Ø±","Ø¹Ù…Ø§Ù†ÙŠ"]);
      curr.className = "entry-curr";

      const dir  = select(["Ø¹Ù„ÙŠÙ‡","Ù„Ù‡"]);
      dir.className = "entry-dir";

      // Ø²Ø± Ø§Ù„ØµÙˆØª Ù„ÙƒÙ„ Ø¨Ù†Ø¯
      const voiceBtn = button("ğŸ¤","pill-btn entry-voice-btn");
      voiceBtn.type = "button";
      voiceBtn.title = "Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø³Ù‘Ø§Ù… Ø§Ù„ØµÙˆØªÙŠ Ù„Ù„Ø¨Ù†Ø¯";
      voiceBtn.onclick = () => {
        if (state.currentStatementLocked) return;
        desc.focus();
        if (voiceAssistantBtnEl) voiceAssistantBtnEl.click();
      };

      const del  = button("Ø­Ø°Ù","pill-btn pill-red entry-del");
      del.onclick = () => {
        if (state.currentStatementLocked) return;
        confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ") && row.remove();
        updatePreviewText();
      };

      if(init){
        desc.value   = init.desc || "";
        amount.value = init.amount ? Number(init.amount).toLocaleString("en-US") : "";
        curr.value   = init.currency;
        dir.value    = init.direction;
      }

      [desc,curr,dir].forEach(e => e.addEventListener("input", updatePreviewText));

      row.append(desc,amount,curr,dir,voiceBtn,del);
      entriesContainer.appendChild(row);

      applyLockUI();
    }

    function input(t,p){ const e=document.createElement("input"); e.type=t; e.placeholder=p; return e; }
    function select(arr){ const s=document.createElement("select"); arr.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v;s.append(o)}); return s; }
    function button(t,c){ const b=document.createElement("button"); b.textContent=t; b.className=c; return b; }

    function getEntries(){
      return [...entriesContainer.querySelectorAll(".entry-row")].map(r=>{
        const amountRaw = (r.querySelector(".entry-amount").value || "").replace(/,/g,"");
        return {
          desc:      r.querySelector(".entry-desc").value.trim(),
          amount:    +amountRaw || 0,
          currency:  r.querySelector(".entry-curr").value,
          direction: r.querySelector(".entry-dir").value
        };
      }).filter(e=>e.desc || e.amount);
    }

    function ensureClient(n){
      if(!state.data.clients[n]) state.data.clients[n] = {statements:[]};
    }

    // âœ… Ø­ÙØ¸ + Ù‚ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    function saveCurrentStatement(){
      const name = clientNameInput.value.trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"); return; }
      ensureClient(name);

      if (state.currentStatementLocked){
        alert("Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù…Ù‚ÙÙˆÙ„. Ø§ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø«Ù… Ø§Ø­ÙØ¸.");
        return;
      }

      const st = {
        id: state.currentStatementId || ("st_"+Date.now()),
        date: dateInput.value,
        title: titleInput.value.trim(),
        truckNumber: truckNumberInput.value.trim(),
        statementNumber: statementNumberInput.value.trim(),
        entries: getEntries(),
        manualTotal: manualTotalInput.value.trim(),
        extraNotes: extraNotesInput.value.trim(),
        locked: true
      };

      if(!st.entries.length){ alert("Ø£Ø¶Ù Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }

      const list = state.data.clients[name].statements;
      const idx  = list.findIndex(s => s.id === st.id);

      if(idx >= 0) list[idx] = st;
      else list.unshift(st);

      saveData();

      state.currentClient = name;
      state.currentStatementId = st.id;

      // âœ… Ø§Ù‚ÙÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
      state.currentStatementLocked = true;

      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù âœ… ÙˆØªÙ… Ø¥Ù‚ÙØ§Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ğŸ”’");

      renderStatementsList();
      renderTotalsForCurrentClient();
      updatePreviewText();
      renderReportsClientOptions();
      renderClientsDatalist();

      // âœ… ØªØ±Ø­ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      showScreen("reports");
      reportClientSelect.value = name;
      buildDetailedReport();


    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
    if (mvDateInput) mvDateInput.value = new Date().toISOString().slice(0,10);
    renderMovementsForClient(clientNameInput.value.trim());

      applyLockUI();
      refreshDailyBackupUI();
      renderMovementsForClient(name);

    }

    function resetForm(keepName){
      state.currentStatementId = null;

      // âœ… ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ ÙŠÙƒÙˆÙ† Ù…ÙØªÙˆØ­
      state.currentStatementLocked = false;

      if(keepName) clientNameInput.value = keepName;
      dateInput.value        = new Date().toISOString().slice(0,10);
      titleInput.value       = "";
      truckNumberInput.value = "";
      statementNumberInput.value = "";
      manualTotalInput.value = "";
      extraNotesInput.value  = "";
      entriesContainer.innerHTML = "";
      addEntryRow();
      updatePreviewText();
      renderStatementsList();
      renderTotalsForCurrentClient();
      applyLockUI();
    
      renderMovementsForClient(clientNameInput.value.trim());
}

    function copyLastEntries(){
      if (state.currentStatementLocked) {
        alert("Ø§ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù†Ø³Ø®.");
        return;
      }

      const name = clientNameInput.value.trim();
      const c    = state.data.clients[name];
      if(!c || !c.statements.length){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚"); return; }

      entriesContainer.innerHTML = "";
      c.statements[0].entries.forEach(e =>
        addEntryRow({desc:e.desc,amount:0,currency:e.currency,direction:e.direction})
      );
      updatePreviewText();
    }

    // âœ… Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„Ø£Ø±Ù‚Ø§Ù…/ID
    function copyEntriesFromPreviousStatement(){
      if (state.currentStatementLocked) {
        alert("Ø§ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù†Ø³Ø®.");
        return;
      }

      const name = clientNameInput.value.trim();
      const c = state.data.clients[name];
      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
      if(!c || !c.statements || !c.statements.length){
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙ Ø³Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");
        return;
      }

      const sortedStatements = (c.statements || []).slice().sort((a, b) => {
        const da = a.date || "";
        const db = b.date || "";
        if (da && db) {
          const cmp = db.localeCompare(da);
          if (cmp !== 0) return cmp;
        } else if (db) return -1;
        else if (da) return 1;
        return (b.id || "").localeCompare(a.id || "");
      });

      const maxShow = Math.min(20, sortedStatements.length);
      let msg = "Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„ÙƒØ´Ù Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù†Ù‡:\n";
      msg += "(Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù† Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ØªØ±ÙŠØ¯Ù‡)\n\n";

      for(let i=0;i<maxShow;i++){
        const st = sortedStatements[i];
        const t  = st.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
        const d  = st.date || "";
        const sn = st.statementNumber ? ` | Ø¨:${st.statementNumber}` : "";
        const tr = st.truckNumber ? ` | Ù‚:${st.truckNumber}` : "";
        msg += `${i+1}) ${d} â€” ${t}${sn}${tr}\n`;
      }

      const ans = prompt(msg, "1");
      if(ans === null) return;
      const inputVal = (ans || "").trim();
      if(!inputVal) return;

      let picked = null;
      const asNum = parseInt(inputVal, 10);
      if(!Number.isNaN(asNum) && asNum >= 1 && asNum <= maxShow){
        picked = sortedStatements[asNum - 1];
      } else {
        picked = sortedStatements.find(s => (s.statementNumber || "").trim() === inputVal);
      }

      if(!picked){
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨. Ø¬Ø±Ù‘Ø¨ Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù† Ø§Ù„ØµØ­ÙŠØ­.");
        return;
      }
      if(!picked.entries || !picked.entries.length){
        alert("Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¨Ù†ÙˆØ¯.");
        return;
      }

      // âœ… ÙÙ‚Ø· Ø§Ù„Ø¨Ù†ÙˆØ¯ØŒ Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„ØªØ§Ø±ÙŠØ®/ID
      entriesContainer.innerHTML = "";
      picked.entries.forEach(e => {
        addEntryRow({ desc: e.desc, amount: 0, currency: e.currency, direction: e.direction });
      });
      updatePreviewText();
      alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø§Ù„ÙƒØ´Ù Ø§Ù„Ù…Ø®ØªØ§Ø± âœ…");
    }

    /* === Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù…Ø¹ Ø²Ø± Ø§Ù„Ø­Ø°Ù === */
    function renderStatementsList(){
      const name = clientNameInput.value.trim();
      statementsListEl.innerHTML = "";
      const c = state.data.clients[name];
      if(!c || !c.statements.length){
        statementsListEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª";
        return;
      }

      const q = (statementsSearchInput.value || "").trim().toLowerCase();
      const multiMode   = state.multiSelectEnabled;
      const selectedIds = new Set(state.selectedStatements);

      const sortedStatements = (c.statements || []).slice().sort((a, b) => {
        const da = a.date || "";
        const db = b.date || "";
        if (da && db) {
          const cmp = db.localeCompare(da);
          if (cmp !== 0) return cmp;
        } else if (db) return -1;
        else if (da) return 1;
        return (b.id || "").localeCompare(a.id || "");
      });

      sortedStatements
        .filter(st=>{
          if(!q) return true;
          const haystack = [
            st.title || "",
            st.date || "",
            st.truckNumber || "",
            st.statementNumber || ""
          ].join(" ").toLowerCase();
          return haystack.includes(q);
        })
        .forEach(st=>{
          const d = document.createElement("div");
          d.className = "saved-item";

          const titleSpan = document.createElement("span");
          const labelExtra = [
            st.truckNumber ? `Ù‚:${st.truckNumber}` : "",
            st.statementNumber ? `Ø¨:${st.statementNumber}` : "",
            st.locked ? "ğŸ”’" : "ğŸ”“"
          ].filter(Boolean).join(" â€¢ ");

          titleSpan.textContent =
            (st.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†") + (labelExtra ? " â€” " + labelExtra : "");

          const dateSpan = document.createElement("span");
          dateSpan.className = "date";
          dateSpan.textContent = st.date || "";

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "ğŸ—‘ï¸";
          deleteBtn.title = "Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù";
          deleteBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) {
              deleteStatementForCurrentClient(st.id);
            }
          });

          if (multiMode) {
            const leftWrap = document.createElement("div");
            leftWrap.style.display = "flex";
            leftWrap.style.alignItems = "center";
            leftWrap.style.gap = "6px";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.style.margin = "0";
            checkbox.checked = selectedIds.has(st.id);

            checkbox.addEventListener("click", (ev) => {
              ev.stopPropagation();
              toggleStatementSelection(st.id, checkbox.checked);
              d.style.background = checkbox.checked ? "#bbf7d0" : "#ecfdf3";
            });

            leftWrap.appendChild(checkbox);
            leftWrap.appendChild(titleSpan);

            const rightWrap = document.createElement("div");
            rightWrap.style.display = "flex";
            rightWrap.style.alignItems = "center";
            rightWrap.style.gap = "6px";
            rightWrap.appendChild(dateSpan);
            rightWrap.appendChild(deleteBtn);

            d.appendChild(leftWrap);
            d.appendChild(rightWrap);

            if (checkbox.checked) d.style.background = "#bbf7d0";

            d.onclick = () => {
              const newVal = !checkbox.checked;
              checkbox.checked = newVal;
              toggleStatementSelection(st.id, newVal);
              d.style.background = newVal ? "#bbf7d0" : "#ecfdf3";
            };
          } else {
            const rightWrap = document.createElement("div");
            rightWrap.style.display = "flex";
            rightWrap.style.alignItems = "center";
            rightWrap.style.gap = "6px";
            rightWrap.appendChild(dateSpan);
            rightWrap.appendChild(deleteBtn);

            d.appendChild(titleSpan);
            d.appendChild(rightWrap);

            d.onclick = () => {
              if (confirm("ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´ÙØŸ Ø³ÙŠØªÙ… ÙØªØ­Ù‡ Ù…Ù‚ÙÙˆÙ„ Ù„Ù„Ø­Ù…Ø§ÙŠØ©.")) loadStatement(name, st.id);
            };
          }

          statementsListEl.appendChild(d);
        });

      if(!statementsListEl.childElementCount){
        statementsListEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø­Ø«Ùƒ.";
      }
    }

    function toggleStatementSelection(id, isSelected){
      const arr = state.selectedStatements;
      const idx = arr.indexOf(id);
      if (isSelected) {
        if (idx === -1) arr.push(id);
      } else {
        if (idx !== -1) arr.splice(idx, 1);
      }
    }

    function deleteStatementForCurrentClient(statementId){
      const name = clientNameInput.value.trim();
      if (!name) return;
      const client = state.data.clients[name];
      if (!client || !Array.isArray(client.statements)) return;

      const idx = client.statements.findIndex(s => s.id === statementId);
      if (idx === -1) return;

      client.statements.splice(idx, 1);

      const selIdx = state.selectedStatements.indexOf(statementId);
      if (selIdx !== -1) state.selectedStatements.splice(selIdx, 1);

      if (state.currentStatementId === statementId) {
        state.currentStatementId = null;
        state.currentStatementLocked = false;
        resetForm(name);
      }

      saveData();
      renderStatementsList();
      renderTotalsForCurrentClient();
      updatePreviewText();
      renderReportsClientOptions();
      renderClientsDatalist();

      // âœ… ØªØ±Ø­ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      showScreen("reports");
      reportClientSelect.value = name;
      buildDetailedReport();


    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
    if (mvDateInput) mvDateInput.value = new Date().toISOString().slice(0,10);
    renderMovementsForClient(clientNameInput.value.trim());

      refreshDailyBackupUI();
    }

    function deleteClient(name){
      if (!state.data.clients[name]) return;

      delete state.data.clients[name];

      if (clientNameInput.value.trim() === name) {
        clientNameInput.value = "";
        resetForm("");
        totalsBoxEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
      }

      saveData();
      renderClientsList();
      renderStatementsList();
      renderReportsClientOptions();
      renderClientsDatalist();

      // âœ… ØªØ±Ø­ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      showScreen("reports");
      reportClientSelect.value = name;
      buildDetailedReport();


    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
    if (mvDateInput) mvDateInput.value = new Date().toISOString().slice(0,10);
    renderMovementsForClient(clientNameInput.value.trim());

      updatePreviewText();
      refreshDailyBackupUI();
    }

    function loadStatement(name,id){
      const st = state.data.clients[name].statements.find(s=>s.id===id);
      if(!st) return;

      state.currentClient = name;
      state.currentStatementId = id;

      clientNameInput.value      = name;
      dateInput.value            = st.date;
      titleInput.value           = st.title;
      truckNumberInput.value     = st.truckNumber || "";
      statementNumberInput.value = st.statementNumber || "";
      manualTotalInput.value     = st.manualTotal || "";
      extraNotesInput.value      = st.extraNotes || "";

      entriesContainer.innerHTML = "";
      st.entries.forEach(e => addEntryRow(e));

      // âœ… Ø§ÙØªØ­ Ø§Ù„ÙƒØ´Ù Ù…Ù‚ÙÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
      state.currentStatementLocked = (st.locked !== false);

      updatePreviewText();
      renderStatementsList();
      renderTotalsForCurrentClient();
      applyLockUI();
      renderMovementsForClient(name);

    }

    function renderClientsList(){
      clientsListEl.innerHTML = "";
      const names = Object.keys(state.data.clients);

      if (!names.length){
        clientsListEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯";
        return;
      }

      const search = (clientsSearchInput.value || "").trim().toLowerCase();

      names
        .filter(n => !search || n.toLowerCase().includes(search))
        .sort((a,b)=>a.localeCompare(b,"ar"))
        .forEach(n=>{
          const d = document.createElement("div");
          d.className = "saved-item";

          const last = state.data.clients[n].statements[0];

          const nameSpan = document.createElement("span");
          nameSpan.textContent = n;

          const dateSpan = document.createElement("span");
          dateSpan.className = "date";
          dateSpan.textContent = last ? (last.date || "") : "";

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "ğŸ—‘ï¸";
          deleteBtn.title = "Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙ";
          deleteBtn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${n}" Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.`)) {
              deleteClient(n);
            }
          });

          const rightWrap = document.createElement("div");
          rightWrap.style.display = "flex";
          rightWrap.style.alignItems = "center";
          rightWrap.style.gap = "6px";
          rightWrap.appendChild(dateSpan);
          rightWrap.appendChild(deleteBtn);

          d.appendChild(nameSpan);
          d.appendChild(rightWrap);

          d.onclick = () => {
            if (last) {
              showScreen("s");
              loadStatement(n, last.id);
            }
          };

          clientsListEl.appendChild(d);
        });
    }

    function computeTotalsForClient(name, fromDate, toDate){
      const c = state.data.clients[name]; if(!c) return {};
      const t = {};
      const from = fromDate ? new Date(fromDate) : null;
      const to   = toDate   ? new Date(toDate)   : null;

      c.statements.forEach(s=>{
        if(from || to){
          const sd = s.date ? new Date(s.date) : null;
          if(sd){
            if(from && sd < from) return;
            if(to   && sd > to)   return;
          }
        }
        s.entries.forEach(e=>{
          if(!t[e.currency]) t[e.currency] = {lah:0,alaih:0};
          if(e.direction==="Ù„Ù‡")  t[e.currency].lah   += e.amount;
          else                    t[e.currency].alaih += e.amount;
        });
      });
      return t;
    }

    function renderTotalsForCurrentClient(){
      const n = clientNameInput.value.trim();
      if(!state.data.clients[n]){ totalsBoxEl.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"; return; }
      const t = computeTotalsForClient(n);
      let txt = "";
      Object.keys(t).forEach(c=>{
        const diff = t[c].lah - t[c].alaih;
        txt += `${c}:\nÙ„Ù‡: ${t[c].lah}\nØ¹Ù„ÙŠÙ‡: ${t[c].alaih}\nØ§Ù„ØµØ§ÙÙŠ: ${diff}\n\n`;
      });
      totalsBoxEl.textContent = txt || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
    }

    function updatePreviewText(){
      const n   = clientNameInput.value.trim() || "Ø§Ù„Ø¹Ù…ÙŠÙ„";
      const d   = dateInput.value || "";
      const ti  = titleInput.value || "";
      const trk = truckNumberInput.value.trim();
      const stn = statementNumberInput.value.trim();

      let txt = `${n}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${d}\n----------------\n${ti}`;
      if(trk) txt += `\nØ±Ù‚Ù… Ø§Ù„Ù‚Ø§Ø·Ø±Ø©: ${trk}`;
      if(stn) txt += `\nØ±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù†: ${stn}`;
      txt += "\n";

      getEntries().forEach((e,i)=>
        txt += `\n${i+1}- ${e.desc} ${e.amount.toLocaleString("en-US")} ${e.currency} (${e.direction})`
      );
      if(manualTotalInput.value)
        txt += `\n----------------\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${manualTotalInput.value}`;
      if(extraNotesInput.value)
        txt += `\n\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª:\n${extraNotesInput.value}`;
      whatsAppBox.textContent = txt;
    }

    // ====== Ø¨Ù†Ø§Ø¡ Ø¨Ù„ÙˆÙƒ HTML Ù„ÙƒØ´Ù ÙˆØ§Ø­Ø¯ (Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ PDF) ======
    function buildStatementHtmlBlock(st, name){
      const entries = st.entries || [];

      const totalsPerCurrency = {};
      entries.forEach(e=>{
        if (!totalsPerCurrency[e.currency]) {
          totalsPerCurrency[e.currency] = { lah:0, alaih:0 };
        }
        if (e.direction === "Ù„Ù‡") totalsPerCurrency[e.currency].lah += e.amount;
        else                      totalsPerCurrency[e.currency].alaih += e.amount;
      });

      let totalsRows = "";
      Object.keys(totalsPerCurrency).forEach(c=>{
        const t = totalsPerCurrency[c];
        const diff = t.lah - t.alaih;
        const dir = diff > 0 ? "Ù„Ù‡" : (diff < 0 ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ø§ Ø´ÙŠØ¡");
        totalsRows += `
          <tr>
            <td style="border:1px solid #ddd; padding:3px; text-align:center;">${c}</td>
            <td style="border:1px solid #ddd; padding:3px; text-align:center;">${t.lah.toLocaleString("en-US")}</td>
            <td style="border:1px solid #ddd; padding:3px; text-align:center;">${t.alaih.toLocaleString("en-US")}</td>
            <td style="border:1px solid #ddd; padding:3px; text-align:center;">${Math.abs(diff).toLocaleString("en-US")} (${dir})</td>
          </tr>`;
      });

      const notesHtml = (st.extraNotes || "").replace(/\n/g,"<br>");

      return `
        <div style="width:100%; padding:16px 24px; box-sizing:border-box; font-family:system-ui,-apple-system,'Segoe UI',Tahoma,sans-serif; color:#111827; direction:rtl; page-break-after:always;">
          <h2 style="text-align:center; margin:0 0 6px;">ÙƒØ´Ù Ø­Ø³Ø§Ø¨</h2>
          <div style="margin:2px 0;">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${name}</div>
          <div style="margin:2px 0;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${st.date || ""}</div>
          <div style="margin:2px 0;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${st.title || ""}</div>
          ${st.truckNumber ? `<div style="margin:2px 0;">Ø±Ù‚Ù… Ø§Ù„Ù‚Ø§Ø·Ø±Ø©: ${st.truckNumber}</div>` : ""}
          ${st.statementNumber ? `<div style="margin:2px 0;">Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØ§Ù†: ${st.statementNumber}</div>` : ""}

          <table style="width:100%; border-collapse:collapse; margin-top:8px;">
            <thead>
              <tr>
                <th style="border:1px solid #ddd; padding:4px; background:#f3f4f6;">#</th>
                <th style="border:1px solid #ddd; padding:4px; background:#f3f4f6;">Ø§Ù„ÙˆØµÙ</th>
                <th style="border:1px solid #ddd; padding:4px; background:#f3f4f6;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th style="border:1px solid #ddd; padding:4px; background:#f3f4f6;">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th style="border:1px solid #ddd; padding:4px; background:#f3f4f6;">Ù„Ù‡/Ø¹Ù„ÙŠÙ‡</th>
              </tr>
            </thead>
            <tbody>
              ${entries.map((e,i)=>`
                <tr>
                  <td style="border:1px solid #ddd; padding:3px; text-align:center;">${i+1}</td>
                  <td style="border:1px solid #ddd; padding:3px; text-align:right;">${e.desc}</td>
                  <td style="border:1px solid #ddd; padding:3px; text-align:center;">${e.amount.toLocaleString("en-US")}</td>
                  <td style="border:1px solid #ddd; padding:3px; text-align:center;">${e.currency}</td>
                  <td style="border:1px solid #ddd; padding:3px; text-align:center;">${e.direction}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>

          <div style="margin-top:8px; font-size:0.9rem;">
            <strong>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù:</strong>
            <table style="width:100%; border-collapse:collapse; margin-top:4px;">
              <thead>
                <tr>
                  <th style="border:1px solid #ddd; padding:3px; background:#f3f4f6;">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                  <th style="border:1px solid #ddd; padding:3px; background:#f3f4f6;">Ø¥Ø¬Ù…Ø§Ù„ Ù„Ù‡</th>
                  <th style="border:1px solid #ddd; padding:3px; background:#f3f4f6;">Ø¥Ø¬Ù…Ø§Ù„ Ø¹Ù„ÙŠÙ‡</th>
                  <th style="border:1px solid #ddd; padding:3px; background:#f3f4f6;">Ø§Ù„ØµØ§ÙÙŠ</th>
                </tr>
              </thead>
              <tbody>
                ${totalsRows || `<tr><td colspan="4" style="border:1px solid #ddd; padding:3px; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>`}
              </tbody>
            </table>
          </div>

          ${notesHtml ? `<div style="margin-top:8px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:<br>${notesHtml}</div>` : ""}
        </div>
      `;
    }

    // ====== Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù ÙˆØ§Ø­Ø¯ PDF Ø¹Ø¨Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØªØµÙØ­ ======
    function printAsPdf(){
      const name    = clientNameInput.value.trim() || "Ø§Ù„Ø¹Ù…ÙŠÙ„";
      const st = {
        date: dateInput.value || new Date().toISOString().slice(0,10),
        title: titleInput.value || "",
        truckNumber: truckNumberInput.value.trim(),
        statementNumber: statementNumberInput.value.trim(),
        entries: getEntries(),
        extraNotes: extraNotesInput.value
      };

      const html = buildStatementHtmlBlock(st, name);

      const w = window.open("", "_blank");
      w.document.write(`
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>ÙƒØ´Ù - ${name}</title>
<style>
  @page { size:A4; margin:10mm; }
  body { margin:0; padding:0; background:#ffffff; }
</style>
</head>
<body>
  ${html}
  <datalist id="clientsDatalist"></datalist>
</body>
</html>`);
      w.document.close();
      w.focus();
      w.onload = function () {
        try { this.print(); } catch(e) {}
      };
    }

    // ====== Ù…Ø´Ø§Ø±ÙƒØ© ÙƒØ´Ù ÙˆØ§Ø­Ø¯ PDF ÙƒÙ…Ù„Ù ======
    async function sharePdf(){
      const name = clientNameInput.value.trim() || "Ø§Ù„Ø¹Ù…ÙŠÙ„";
      const st = {
        date: dateInput.value || new Date().toISOString().slice(0,10),
        title: titleInput.value || "",
        truckNumber: truckNumberInput.value.trim(),
        statementNumber: statementNumberInput.value.trim(),
        entries: getEntries(),
        extraNotes: extraNotesInput.value
      };
      if (!st.entries.length){
        alert("Ø£Ø¶Ù Ø¨Ù†ÙˆØ¯Ù‹Ø§ Ù„Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }

      singlePdfContainer.innerHTML = buildStatementHtmlBlock(st, name);
      singlePdfContainer.style.display = "block";

      const canvas = await html2canvas(singlePdfContainer, { scale: 2 });
      const imgData = canvas.toDataURL("image/jpeg", 1.0);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");
      const pageWidth  = 210;
      const pageHeight = 297;
      const imgWidth   = pageWidth;
      const imgHeight  = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let position   = 0;

      pdf.addImage(imgData, "JPEG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "JPEG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      singlePdfContainer.style.display = "none";

      const pdfBlob = pdf.output("blob");
      const pdfFile = new File(
        [pdfBlob],
        `statement-${name}-${new Date().toISOString().slice(0,10)}.pdf`,
        { type: "application/pdf" }
      );

      if (navigator.canShare && navigator.canShare({ files:[pdfFile] })) {
        navigator.share({
          title: "ÙƒØ´Ù Ø­Ø³Ø§Ø¨ PDF",
          text: "ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„.",
          files: [pdfFile]
        }).catch(()=>{});
      } else {
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = pdfFile.name;
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    // ====== Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¯Ø© ÙƒØ´ÙˆÙ PDF ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ ======
    async function shareSelectedStatementsPdf(){
      const name = clientNameInput.value.trim();
      if (!name) {
        alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      if (!state.multiSelectEnabled || !state.selectedStatements.length) {
        alert("ÙØ¹Ù‘Ù„ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø© ÙƒØ´ÙˆÙ Ø«Ù… Ø§Ø®ØªØ± ÙƒØ´ÙˆÙ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");
        return;
      }

      const client = state.data.clients[name];
      if (!client) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");
        return;
      }

      multiPdfContainer.innerHTML = "";
      multiPdfContainer.style.display = "block";

      state.selectedStatements.forEach((id) => {
        const st = client.statements.find(s => s.id === id);
        if (!st) return;
        multiPdfContainer.insertAdjacentHTML("beforeend", buildStatementHtmlBlock(st, name));
      });

      const canvas = await html2canvas(multiPdfContainer, { scale: 2 });
      const imgData = canvas.toDataURL("image/jpeg", 1.0);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");
      const pageWidth  = 210;
      const pageHeight = 297;
      const imgWidth   = pageWidth;
      const imgHeight  = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let position   = 0;

      pdf.addImage(imgData, "JPEG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "JPEG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      multiPdfContainer.style.display = "none";

      const pdfBlob = pdf.output("blob");
      const pdfFile = new File(
        [pdfBlob],
        `statements-${name}-${new Date().toISOString().slice(0,10)}.pdf`,
        { type: "application/pdf" }
      );

      if (navigator.canShare && navigator.canShare({ files:[pdfFile] })) {
        navigator.share({
          title: "Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ´ÙˆÙ Ø­Ø³Ø§Ø¨ PDF",
          text: "Ø§Ù„ÙƒØ´ÙˆÙ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.",
          files: [pdfFile]
        }).catch(()=>{});
      } else {
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = pdfFile.name;
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    // ====== ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø©ØŒ Ø¬Ø¯ÙˆÙ„) ======
    
    function renderClientsDatalist(){
      const dl = document.getElementById("clientsDatalist");
      if(!dl) return;
      const names = Object.keys(state.data.clients || {}).sort((a,b)=>a.localeCompare(b,"ar"));
      dl.innerHTML = names.map(n=>`<option value="${escapeHtml(n)}"></option>`).join("");
    }

function renderReportsClientOptions(){
      while (reportClientSelect.options.length > 1) {
        reportClientSelect.remove(1);
      }
      const names = Object.keys(state.data.clients);
      names.sort((a,b)=>a.localeCompare(b,"ar")).forEach(n=>{
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        reportClientSelect.appendChild(opt);
      });
    }

    function buildReport(){
      const name = reportClientSelect.value;
      if(!name){ alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }
      const from = reportFromInput.value;
      const to   = reportToInput.value;
      const totals = computeTotalsForClient(name, from, to);
      if(!Object.keys(totals).length){
        reportBox.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.";
        return;
      }
      let headerHtml = `<h3 style="margin-top:0;">ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${name}</h3>`;
      if(from || to){
        headerHtml += `<p>Ø§Ù„ÙØªØ±Ø©: ${from || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"} Ø¥Ù„Ù‰ ${to || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>`;
      }

      let tableHtml = `
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ Ù„Ù‡</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ Ø¹Ù„ÙŠÙ‡</th>
              <th>Ø§Ù„ØµØ§ÙÙŠ</th>
            </tr>
          </thead>
          <tbody>`;

      Object.keys(totals).forEach(c=>{
        const lah   = totals[c].lah;
        const alaih = totals[c].alaih;
        const diff  = lah - alaih;
        const dir   = diff>0 ? "Ù„Ù‡" : (diff<0 ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ø§ Ø´ÙŠØ¡");
        tableHtml += `
          <tr>
            <td>${c}</td>
            <td>${lah}</td>
            <td>${alaih}</td>
            <td>${Math.abs(diff)} (${dir})</td>
          </tr>`;
      });

      tableHtml += `</tbody></table>`;
      
      // ===== Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª + ØªÙØ§ØµÙŠÙ„Ù‡Ø§ (Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø­Ø±ÙƒØ©) =====
      const allMovements = getMovementsForClient(name);
      const movementsInRange = filterByDateRange(allMovements, from, to);

      if (movementsInRange.length) {
        const mtot = computeMovementTotalsPerCurrency(movementsInRange);

        let mSummaryHtml = `<h4 style="margin-top:14px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡ / Ø§Ù„Ø±ØµÙŠØ¯):</h4>`;
        mSummaryHtml += `
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ù„Ù‡</th>
                <th>Ø¹Ù„ÙŠÙ‡</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
              </tr>
            </thead>
            <tbody>`;

        Object.keys(mtot).forEach(c=>{
          const t = mtot[c];
          mSummaryHtml += `
            <tr>
              <td>${c}</td>
              <td>${t.lah}</td>
              <td>${t.alaih}</td>
              <td>${t.balance}</td>
            </tr>`;
        });

        mSummaryHtml += `</tbody></table>`;

        // âœ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ø§Ù„ÙƒØ´ÙˆÙ + Ø§Ù„Ø­Ø±ÙƒØ§Øª)
        const finalCurrencies = new Set([...Object.keys(totals), ...Object.keys(mtot)]);
        let finalHtml = `<h4 style="margin-top:14px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ§Øª:</h4>`;
        finalHtml += `
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù‡</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù„ÙŠÙ‡</th>
                <th>Ø§Ù„ØµØ§ÙÙŠ</th>
              </tr>
            </thead>
            <tbody>`;
        Array.from(finalCurrencies).forEach(c=>{
          const sLah = (totals[c]?.lah || 0);
          const sAl  = (totals[c]?.alaih || 0);
          const mLah = (mtot[c]?.lah || 0);
          const mAl  = (mtot[c]?.alaih || 0);
          const fLah = sLah + mLah;
          const fAl  = sAl  + mAl;
          const fNet = fLah - fAl;
          const dir  = fNet>0 ? "Ù„Ù‡" : (fNet<0 ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ø§ Ø´ÙŠØ¡");
          finalHtml += `
            <tr>
              <td>${c}</td>
              <td>${fLah}</td>
              <td>${fAl}</td>
              <td>${Math.abs(fNet)} (${dir})</td>
            </tr>`;
        });
        finalHtml += `</tbody></table>`;



        // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª ÙƒØ³Ø·ÙˆØ± (Ù…Ø¹ Ø±ØµÙŠØ¯ ØªØ±Ø§ÙƒÙ…ÙŠ Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø©)
        const running = {};
        let mDetailsHtml = `<h4 style="margin-top:14px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø­Ø±ÙƒØ©):</h4>`;
        mDetailsHtml += `
          <table>
            <thead>
              <tr>
                <th class="col-date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¨Ù†Ø¯</th>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ù„Ù‡</th>
                <th>Ø¹Ù„ÙŠÙ‡</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
              </tr>
            </thead>
            <tbody>`;

        movementsInRange.forEach(m=>{
          const c = m.currency || "";
          if (running[c] == null) running[c] = 0;
          const amt = Number(m.amount||0) || 0;
          const lah  = (m.direction === "Ù„Ù‡") ? amt : 0;
          const alaih= (m.direction === "Ø¹Ù„ÙŠÙ‡") ? amt : 0;
          running[c] += (m.direction === "Ù„Ù‡") ? amt : -amt;

          mDetailsHtml += `
            <tr>
              <td class="col-date">${m.date || ""}</td>
              <td style="text-align:right;">${(m.desc || "Ø­Ø±ÙƒØ©")}</td>
              <td>${c}</td>
              <td>${lah || ""}</td>
              <td>${alaih || ""}</td>
              <td>${running[c]}</td>
            </tr>`;
        });

        mDetailsHtml += `</tbody></table>`;

        tableHtml += mSummaryHtml + mDetailsHtml;
      }

      reportBox.innerHTML = headerHtml + tableHtml + mSummaryHtml + finalHtml + mDetailsHtml;
    }

    function computeTotalsForStatement(st){
      const totals = {};
      (st.entries || []).forEach(e => {
        if (!totals[e.currency]) totals[e.currency] = { lah:0, alaih:0 };
        if (e.direction === "Ù„Ù‡") totals[e.currency].lah += e.amount;
        else                      totals[e.currency].alaih += e.amount;
      });
      return totals;
    }

    function buildDetailedReport(){
      const name = reportClientSelect.value;
      if (!name){
        alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }
      const client = state.data.clients[name];
      if (!client || !client.statements || !client.statements.length){
        reportBox.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.";
        return;
      }
const grandTotals = {};
      const statements = (client.statements || []).slice().sort((a, b) => {
  const da = a.date || "";
  const db = b.date || "";

  // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ®ÙŠÙ†
  if (da && db) {
    const cmp = da.localeCompare(db); // YYYY-MM-DD
    if (cmp !== 0) return cmp;
  } else if (db) {
    return 1;   // Ø§Ù„Ù„ÙŠ Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® ÙŠØ¬ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ù„ÙŠ Ù…Ø¹Ù‡ ØªØ§Ø±ÙŠØ®
  } else if (da) {
    return -1;
  }

  // ÙƒØ³Ø± Ø§Ù„ØªØ¹Ø§Ø¯Ù„: Ø§Ù„Ø£Ø­Ø¯Ø« Ø­Ø³Ø¨ id/ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
  return (a.id || "").localeCompare(b.id || "");
});
      let html = `<h3 style="margin-top:0;">ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ù„ÙƒÙ„ ÙƒØ´Ù Ù„Ù„Ø¹Ù…ÙŠÙ„: ${name}</h3>`;
      html += `
        <table>
          <thead>
            <tr>
              <th class="col-date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th class="col-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù</th>
              <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ Ù„Ù‡</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ Ø¹Ù„ÙŠÙ‡</th>
              <th>Ø§Ù„ØµØ§ÙÙŠ (Ù„Ù‡/Ø¹Ù„ÙŠÙ‡)</th>
            </tr>
          </thead>
          <tbody>`;

      statements.forEach((st) => {
        const totals = computeTotalsForStatement(st);
        if (!Object.keys(totals).length){
          return;
        }

        Object.keys(totals).forEach(c => {
          const t = totals[c];
          const diff = t.lah - t.alaih;
          const dir  = diff > 0 ? "Ù„Ù‡" : (diff < 0 ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ø§ Ø´ÙŠØ¡");

          html += `
            <tr>
              <td class="col-date">${st.date || ""}</td>
              <td class="col-title">${st.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</td>
              <td>${c}</td>
              <td>${t.lah}</td>
              <td>${t.alaih}</td>
              <td>${Math.abs(diff)} (${dir})</td>
            </tr>`;

          if (!grandTotals[c]) grandTotals[c] = { lah:0, alaih:0 };
          grandTotals[c].lah   += t.lah;
          grandTotals[c].alaih += t.alaih;
        });
      });

      html += `</tbody></table>`;

      if (Object.keys(grandTotals).length){
        html += `<h4 style="margin-top:14px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ´ÙˆÙ:</h4>`;
        html += `
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ Ù„Ù‡</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ Ø¹Ù„ÙŠÙ‡</th>
                <th>Ø§Ù„ØµØ§ÙÙŠ (Ù„Ù‡/Ø¹Ù„ÙŠÙ‡)</th>
              </tr>
            </thead>
            <tbody>`;

        Object.keys(grandTotals).forEach(c => {
          const t   = grandTotals[c];
          const diff= t.lah - t.alaih;
          const dir = diff > 0 ? "Ù„Ù‡" : (diff < 0 ? "Ø¹Ù„ÙŠÙ‡" : "Ù„Ø§ Ø´ÙŠØ¡");
          html += `
            <tr>
              <td>${c}</td>
              <td>${t.lah}</td>
              <td>${t.alaih}</td>
              <td>${Math.abs(diff)} (${dir})</td>
            </tr>`;
        });

        html += `</tbody></table>`;
      }

      
      // ===== Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª + ØªÙØ§ØµÙŠÙ„Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± =====
      const allMovements = getMovementsForClient(name);
      if (allMovements.length) {
        const mtot = computeMovementTotalsPerCurrency(allMovements);

        html += `<h4 style="margin-top:14px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡ / Ø§Ù„Ø±ØµÙŠØ¯):</h4>`;
        html += `
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ù„Ù‡</th>
                <th>Ø¹Ù„ÙŠÙ‡</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
              </tr>
            </thead>
            <tbody>`;

        Object.keys(mtot).forEach(c=>{
          const t = mtot[c];
          html += `
            <tr>
              <td>${c}</td>
              <td>${t.lah}</td>
              <td>${t.alaih}</td>
              <td>${t.balance}</td>
            </tr>`;
        });

        html += `</tbody></table>`;

        const running = {};
        html += `<h4 style="margin-top:14px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø­Ø±ÙƒØ©):</h4>`;
        html += `
          <table>
            <thead>
              <tr>
                <th class="col-date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¨Ù†Ø¯</th>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ù„Ù‡</th>
                <th>Ø¹Ù„ÙŠÙ‡</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
              </tr>
            </thead>
            <tbody>`;

        allMovements.forEach(m=>{
          const c = m.currency || "";
          if (running[c] == null) running[c] = 0;
          const amt = Number(m.amount||0) || 0;
          const lah  = (m.direction === "Ù„Ù‡") ? amt : 0;
          const alaih= (m.direction === "Ø¹Ù„ÙŠÙ‡") ? amt : 0;
          running[c] += (m.direction === "Ù„Ù‡") ? amt : -amt;

          html += `
            <tr>
              <td class="col-date">${m.date || ""}</td>
              <td style="text-align:right;">${(m.desc || "Ø­Ø±ÙƒØ©")}</td>
              <td>${c}</td>
              <td>${lah || ""}</td>
              <td>${alaih || ""}</td>
              <td>${running[c]}</td>
            </tr>`;
        });

        html += `</tbody></table>`;
      }

      reportBox.innerHTML = html;
    }

    function printReportPdf(){
      const htmlContent = reportBox.innerHTML.trim();
      const name = reportClientSelect.value || "Ø§Ù„Ø¹Ù…ÙŠÙ„";
      if(!htmlContent){
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.");
        return;
      }

      const w = window.open("", "_blank");
      w.document.write(`
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>ØªÙ‚Ø±ÙŠØ± - ${name}</title>
<style>
body{
  font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
  margin:20px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
  font-size:.85rem;
}
th,td{
  border:1px solid #ddd;
  padding:4px 6px;
  text-align:center;
}
th{
  background:#f3f4f6;
}
table .col-date{ white-space:nowrap; width:14%; }
table .col-title{ width:32%; }
</style>
</head>
<body>
${htmlContent}
  <datalist id="clientsDatalist"></datalist>
</body>
</html>`);
      w.document.close();
      w.focus();
      w.onload = function () {
        try { this.print(); } catch(e) {}
      };
    }

    // ====== Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© ======
    const exportBtn   = document.getElementById("exportBackupBtn");
    const importBtn   = document.getElementById("importBackupBtn");
    const backupInput = document.getElementById("backupFileInput");

    exportBtn.onclick = exportBackup;
    importBtn.onclick = () => backupInput.click();

    backupInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const obj = JSON.parse(ev.target.result);
          if (!obj.clients) throw new Error("bad format");
          state.data = obj;
          saveData();
          alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.");
          renderStatementsList();
          renderClientsList();
          renderTotalsForCurrentClient();
          updatePreviewText();
          renderReportsClientOptions();
      renderClientsDatalist();

      // âœ… ØªØ±Ø­ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      showScreen("reports");
      reportClientSelect.value = name;
      buildDetailedReport();


    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
    if (mvDateInput) mvDateInput.value = new Date().toISOString().slice(0,10);
    renderMovementsForClient(clientNameInput.value.trim());

          refreshDailyBackupUI();
        } catch (err) {
          console.error(err);
          alert("Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­.");
        }
      };
      reader.readAsText(file, "utf-8");
    });

    function exportBackup() {
      try {
        const raw  = localStorage.getItem(STORAGE_KEY) || JSON.stringify(state.data);
        const blob = new Blob([raw], { type: "application/json" });
        const fileName = "voice-ledger-backup-" + new Date().toISOString().slice(0,10) + ".json";

        const url = URL.createObjectURL(blob);
        const a   = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Google Drive Ø£Ùˆ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†.");
      } catch (e) {
        console.error(e);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.");
      }
    }

    // ====== Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ ======
    function isAutoBackupEnabled(){
      const pref = localStorage.getItem(AUTO_BACKUP_PREF_KEY);
      return (pref === null) ? true : (pref === "on");
    }
    function setAutoBackupEnabled(on){
      localStorage.setItem(AUTO_BACKUP_PREF_KEY, on ? "on" : "off");
    }

    autoBackupToggle.addEventListener("change", ()=>{
      const v = autoBackupToggle.value;
      setAutoBackupEnabled(v === "on");
      refreshDailyBackupUI();
    });

    downloadLastAutoBackupBtn.onclick = () => {
      const arr = getAutoBackups();
      if (!arr.length) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯."); return; }
      const last = arr[0];
      const blob = new Blob([JSON.stringify(last.data)], { type: "application/json" });
      const fileName = `voice-ledger-auto-backup-${last.date}.json`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    clearAutoBackupsBtn.onclick = () => {
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ")) {
        setAutoBackups([]);
        refreshDailyBackupUI();
      }
    };

    function refreshDailyBackupUI(){
      autoBackupToggle.value = isAutoBackupEnabled() ? "on" : "off";
      const arr = getAutoBackups();
      if (!arr.length) {
        autoBackupStatus.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯.";
        return;
      }
      const last = arr[0];
      autoBackupStatus.textContent = `Ø¢Ø®Ø± Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: ${last.date}\nØ¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: ${arr.length}`;
    }

    function performAutoBackupIfDue(){
      if (!isAutoBackupEnabled()) return;

      // Ù†Ø­ØªØ§Ø¬ ØªØ¹Ù…Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø¹Ù†Ø¯ 00:00
      const now = new Date();
      const todayKey = now.toISOString().slice(0,10); // YYYY-MM-DD
      const lastRun = localStorage.getItem(AUTO_BACKUP_LASTRUN_KEY) || "";

      // Ù†ÙØ° ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ (Ø£Ùˆ Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„ Ù„Ù„ÙŠÙˆÙ…) ÙˆÙ„Ù… ÙŠÙ†ÙØ° Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯
      if (lastRun === todayKey) return;

      // Ø´Ø±Ø·: Ø¥Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª ØµØ§Ø± Ø¨Ø¹Ø¯ 00:00 (Ø·Ø¨Ø¹Ø§Ù‹ Ø¯Ø§Ø¦Ù…)
      // Ù†Ø¹Ù…Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¢Ù† Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠÙØªØ­ ÙÙŠÙ‡Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø®Ù„Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…
      try{
        const dataObj = JSON.parse(localStorage.getItem(STORAGE_KEY) || JSON.stringify(state.data));
        const arr = getAutoBackups();

        // Ø®Ø²Ù‘Ù† Ø¢Ø®Ø± 30 Ù†Ø³Ø®Ø© ÙÙ‚Ø·
        arr.unshift({
          date: todayKey,
          ts: Date.now(),
          data: dataObj
        });
        const trimmed = arr.slice(0, 30);
        setAutoBackups(trimmed);

        localStorage.setItem(AUTO_BACKUP_LASTRUN_KEY, todayKey);
        refreshDailyBackupUI();
      }catch(e){
        console.error("auto backup error", e);
      }
    }

    // ====== PWA / ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ======
    const installButton = document.getElementById("installButton");

    window.addEventListener("beforeinstallprompt", e=>{
      e.preventDefault();
      state.deferredPrompt = e;
      installButton.style.display = "inline-flex";
    });

    installButton.onclick = async () => {
      if(!state.deferredPrompt) return;
      state.deferredPrompt.prompt();
      state.deferredPrompt = null;
      installButton.style.display = "none";
    };

    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js");
    }

    // ====== ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© ======
    const hadDataBefore = !!localStorage.getItem(STORAGE_KEY);

    loadData();
    dateInput.value = new Date().toISOString().slice(0,10);
    addEntryRow();
    updatePreviewText();
    renderStatementsList();
    renderClientsList();
    renderClientsDatalist();
    renderTotalsForCurrentClient();
    renderReportsClientOptions();
      renderClientsDatalist();

      // âœ… ØªØ±Ø­ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      showScreen("reports");
      reportClientSelect.value = name;
      buildDetailedReport();


    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
    if (mvDateInput) mvDateInput.value = new Date().toISOString().slice(0,10);
    renderMovementsForClient(clientNameInput.value.trim());


    // Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©: ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù…ÙØªÙˆØ­
    state.currentStatementLocked = false;
    applyLockUI();

    refreshDailyBackupUI();
    performAutoBackupIfDue();

    // Ù†ÙØ­Øµ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ù„Ùˆ ØªØ±Ùƒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙØªÙˆØ­)
    setInterval(performAutoBackupIfDue, 60 * 1000);

    if (!hadDataBefore) {
      setTimeout(() => {
        if (confirm("Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© ÙˆØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø§Ù„Ø¢Ù†ØŸ")) {
          backupInput.click();
        }
      }, 800);
    }

    // ØªØ¹Ø±ÙŠØ¶ Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ù…Ø«Ù„ app.js
    window.copyEntriesFromPreviousStatement = copyEntriesFromPreviousStatement;
  </script>
  <datalist id="clientsDatalist"></datalist>
</body>
</html>
