<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Manifest + PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#16a34a" />

  <style>
    * { box-sizing: border-box; }
    :root {
      --green: #16a34a;
      --green-dark: #15803d;
      --red: #dc2626;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --radius-lg: 14px;
      --radius-md: 10px;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    .app-shell {
      max-width: 950px;
      margin: 0 auto;
      padding: 16px 10px 40px;
    }
    h1 {
      text-align: center;
      font-size: 1.3rem;
      margin: 8px 0 4px;
    }
    .subtitle {
      text-align: center;
      font-size: .8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    /* Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
    .install-bar {
      text-align: center;
      margin-bottom: 10px;
    }
    #installButton {
      display: none; /* Ù†Ø¸Ù‡Ø±Ù‡ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ */
      background: #0f172a;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: .8rem;
      cursor: pointer;
    }

    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 3px;
      margin-bottom: 12px;
    }
    .tab {
      text-align: center;
      padding: 8px 4px;
      font-size: .85rem;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: background .15s, color .15s;
    }
    .tab.active {
      background: var(--green);
      color: #fff;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 12px;
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
      border: 1px solid var(--border);
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: .8rem;
      color: var(--text-muted);
      margin-bottom: 3px;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .row > * {
      flex: 1 1 0;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 7px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: .85rem;
      outline: none;
      background: #f9fafb;
    }
    textarea {
      border-radius: var(--radius-md);
      min-height: 48px;
      resize: vertical;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--green);
      box-shadow: 0 0 0 1px rgba(34,197,94,.35);
      background: #fff;
    }

    /* ØµÙ Ø§Ù„Ø¨Ù†Ø¯ */
    .entries {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
    }
    .entry-row {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      align-items: center;
    }
    .entry-desc   { flex: 4 1 40%; }
    .entry-amount { flex: 2.5 1 22%; }
    .entry-curr   { flex: 1.2 1 14%; }
    .entry-dir    { flex: 1.2 1 14%; }
    .entry-del    { flex: 0 0 auto; }

    @media (max-width: 640px) {
      .entry-row {
        flex-wrap: wrap;
      }
      .entry-desc   { flex: 1 1 100%; }
      .entry-amount { flex: 1 1 45%; }
      .entry-curr   { flex: 1 1 25%; }
      .entry-dir    { flex: 1 1 25%; }
    }

    .pill-btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: .8rem;
      padding: 7px 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }
    .pill-green {
      background: var(--green);
      color: #fff;
    }
    .pill-green:hover { background: var(--green-dark); }
    .pill-gray {
      background: #e5e7eb;
      color: #111827;
    }
    .pill-red {
      background: var(--red);
      color: #fff;
    }

    .section-title {
      font-size: .9rem;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title span.icon {
      font-size: 1.1rem;
    }

    .muted {
      font-size: .78rem;
      color: var(--text-muted);
    }

    .whatsapp-box {
      width: 100%;
      min-height: 90px;
      border-radius: var(--radius-md);
      padding: 8px;
      font-size: .8rem;
      border: 1px dashed var(--border);
      background: #f9fafb;
      white-space: pre-wrap;
    }

    .saved-list {
      max-height: 180px;
      overflow-y: auto;
      margin-top: 6px;
    }
    .saved-item {
      background: #ecfdf3;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .8rem;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid #bbf7d0;
    }
    .saved-item span.date {
      color: var(--text-muted);
      font-size: .75rem;
    }

    .totals-box {
      background: #f0fdf4;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      font-size: .8rem;
      border: 1px solid #bbf7d0;
      white-space: pre-wrap;
    }

    .footer-hint {
      font-size: .7rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <h1>ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    <p class="subtitle">Ø­ÙØ¸ ÙƒØ´ÙˆÙØ§Øª Ø¹Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø­Ø³Ø§Ø¨).</p>

    <!-- Ø´Ø±ÙŠØ· ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div class="install-bar">
      <button id="installButton">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“±</button>
    </div>

    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tabs">
      <div class="tab active" id="tabStatements">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</div>
      <div class="tab" id="tabClients">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
    <div id="screenStatements">
      <div class="card">
        <div class="row">
          <div>
            <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input type="text" id="clientName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="statementDate" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
            <input type="text" id="statementTitle"
                   placeholder="Ù…Ø«Ø§Ù„: ØªØ³ÙˆÙŠØ© Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø¨ÙŠØ§Ù† Ø£Ø¬Ø±Ø© Ø´Ø­Ù†Ø©..." />
          </div>
        </div>

        <label class="section-title">
          <span class="icon">ğŸ§¾</span> Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
        </label>
        <p class="muted" style="margin-bottom:6px;">
          ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ &quot;Ù„Ù‡&quot; Ø£Ùˆ &quot;Ø¹Ù„ÙŠÙ‡&quot; ÙˆØ§Ù„Ø¹Ù…Ù„Ø© Ù„ÙƒÙ„ Ø¨Ù†Ø¯.
        </p>

        <div class="row">
          <button class="pill-btn pill-green" id="addEntryBtn">+ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
          <button class="pill-btn pill-gray" id="copyLastEntriesBtn">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù</button>
        </div>

        <div id="entriesContainer" class="entries"></div>

        <div class="row">
          <div>
            <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="text" id="manualTotal"
                   placeholder="Ù…Ø«Ø§Ù„: 3,326,706 ÙŠÙ…Ù†ÙŠ + 2,300 Ø³Ø¹ÙˆØ¯ÙŠ" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <textarea id="extraNotes"
                      placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ´Ù"></textarea>
          </div>
        </div>

        <div class="row">
          <button class="pill-btn pill-green" id="saveStatementBtn" style="flex:1;">
            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
          </button>
          <button class="pill-btn pill-gray" id="newStatementSameClientBtn" style="flex:1;">
            + ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)
          </button>
        </div>
      </div>

      <!-- Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ + PDF -->
      <div class="card">
        <label class="section-title">
          <span class="icon">ğŸ’¬</span> Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:
        </label>
        <div id="whatsAppText" class="whatsapp-box"></div>

        <div class="row" style="margin-top:8px;">
          <button class="pill-btn pill-gray" id="copyTextBtn" style="flex:1;">
            ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ
          </button>
          <button class="pill-btn pill-green" id="shareWhatsappBtn" style="flex:1;">
            ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨
          </button>
        </div>

        <div class="row" style="margin-top:6px;">
          <button class="pill-btn pill-gray" id="printPdfBtn" style="flex:1;">
            ğŸ–¨ï¸ Ø­ÙØ¸ / Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ€ PDF
          </button>
        </div>
      </div>

      <!-- Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <div class="card">
        <label class="section-title">
          <span class="icon">ğŸ“</span> Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:
        </label>
        <p class="muted">
          Ø§Ø®ØªØ± ÙƒØ´ÙÙ‹Ø§ Ù„Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ù‡. (ÙŠØªÙ… Ø­ÙØ¸ Ø£Ø­Ø¯Ø« ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø¹Ø¯ Ø­ÙØ¸Ù‡ Ø¨Ù†Ø¬Ø§Ø­.)
        </p>
        <div id="statementsList" class="saved-list"></div>
      </div>

      <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <div class="card">
        <label class="section-title">
          <span class="icon">ğŸ“Š</span> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
        </label>
        <div id="totalsBox" class="totals-box">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙŠØ¸Ù‡Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‡Ù†Ø§.
        </div>
      </div>

      <div class="footer-hint">
        Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ &quot;Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©&quot;.
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div id="screenClients" style="display:none;">
      <div class="card">
        <label class="section-title">
          <span class="icon">ğŸ‘¥</span> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
        </label>
        <p class="muted">
          ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ø¨Ø§Ø³Ù…Ù‡. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙØªØ­ ÙƒØ´ÙˆÙØ§ØªÙ‡.
        </p>
        <div id="clientsList" class="saved-list"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =========
    const STORAGE_KEY = "voiceLedgerData_v1";
    const state = {
      data: { clients: {} },
      currentClient: "",
      currentStatementId: null,
      deferredPrompt: null
    };

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) state.data = JSON.parse(raw);
      } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:", e);
      }
    }
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
    }

    // ========= ØªØ¨ÙˆÙŠØ¨Ø§Øª =========
    const tabStatements = document.getElementById("tabStatements");
    const tabClients = document.getElementById("tabClients");
    const screenStatements = document.getElementById("screenStatements");
    const screenClients = document.getElementById("screenClients");

    function showScreen(name) {
      if (name === "statements") {
        tabStatements.classList.add("active");
        tabClients.classList.remove("active");
        screenStatements.style.display = "";
        screenClients.style.display = "none";
      } else {
        tabClients.classList.add("active");
        tabStatements.classList.remove("active");
        screenClients.style.display = "";
        screenStatements.style.display = "none";
        renderClientsList();
      }
    }
    tabStatements.onclick = () => showScreen("statements");
    tabClients.onclick = () => showScreen("clients");

    // ========= Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ =========
    const clientNameInput = document.getElementById("clientName");
    const dateInput = document.getElementById("statementDate");
    const titleInput = document.getElementById("statementTitle");
    const entriesContainer = document.getElementById("entriesContainer");
    const manualTotalInput = document.getElementById("manualTotal");
    const extraNotesInput = document.getElementById("extraNotes");
    const whatsAppBox = document.getElementById("whatsAppText");
    const statementsListEl = document.getElementById("statementsList");
    const totalsBoxEl = document.getElementById("totalsBox");
    const clientsListEl = document.getElementById("clientsList");

    document.getElementById("addEntryBtn").onclick = () => addEntryRow();
    document.getElementById("copyLastEntriesBtn").onclick = copyLastEntries;
    document.getElementById("saveStatementBtn").onclick = saveCurrentStatement;
    document.getElementById("newStatementSameClientBtn").onclick = () => {
      const name = clientNameInput.value.trim();
      resetForm(name);
    };
    document.getElementById("copyTextBtn").onclick = () => {
      navigator.clipboard.writeText(whatsAppBox.textContent || "")
        .then(() => alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØµØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨."))
        .catch(() => alert("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø¬Ø±Ù‘Ø¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§."));
    };
    document.getElementById("shareWhatsappBtn").onclick = () => {
      const txt = encodeURIComponent(whatsAppBox.textContent || "");
      window.open("https://wa.me/?text=" + txt, "_blank");
    };
    document.getElementById("printPdfBtn").onclick = printAsPdf;

    // ========= Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¨Ù†Ø¯ =========
    function addEntryRow(initial) {
      const row = document.createElement("div");
      row.className = "entry-row";

      const desc = document.createElement("input");
      desc.type = "text";
      desc.placeholder = "ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù†ØŒ ØªØµØ±ÙŠØ­ØŒ Ø§Ù„Ø­Ù…Ø§Ù„ÙŠÙ†...)";
      desc.className = "entry-desc";

      const amount = document.createElement("input");
      amount.type = "number";
      amount.min = "0";
      amount.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº";
      amount.className = "entry-amount";

      const curr = document.createElement("select");
      curr.className = "entry-curr";
      ["ÙŠÙ…Ù†ÙŠ","Ø³Ø¹ÙˆØ¯ÙŠ","Ø¯Ø±Ù‡Ù…","Ø¯ÙˆÙ„Ø§Ø±","Ø¹Ù…Ø§Ù†ÙŠ"].forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        curr.appendChild(opt);
      });

      const dir = document.createElement("select");
      dir.className = "entry-dir";
      ["Ù„Ù‡","Ø¹Ù„ÙŠÙ‡"].forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        dir.appendChild(opt);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.textContent = "Ø­Ø°Ù";
      delBtn.className = "pill-btn pill-red entry-del";
      delBtn.onclick = () => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ")) {
          row.remove();
          updatePreviewText();
        }
      };

      if (initial) {
        if (initial.desc) desc.value = initial.desc;
        if (initial.amount != null) amount.value = initial.amount;
        if (initial.currency) curr.value = initial.currency;
        if (initial.direction) dir.value = initial.direction;
      }

      [desc, amount, curr, dir].forEach(el => {
        el.addEventListener("input", updatePreviewText);
        el.addEventListener("change", updatePreviewText);
      });

      row.append(desc, amount, curr, dir, delBtn);
      entriesContainer.appendChild(row);
    }

    function getEntriesFromForm() {
      const rows = Array.from(entriesContainer.querySelectorAll(".entry-row"));
      return rows.map(row => {
        return {
          desc: row.querySelector(".entry-desc").value.trim(),
          amount: parseFloat(row.querySelector(".entry-amount").value || "0") || 0,
          currency: row.querySelector(".entry-curr").value,
          direction: row.querySelector(".entry-dir").value
        };
      }).filter(e => e.desc || e.amount);
    }

    // ========= Ø­ÙØ¸ / ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù =========
    function ensureClient(name) {
      if (!state.data.clients[name]) {
        state.data.clients[name] = { statements: [] };
      }
    }

    function saveCurrentStatement() {
      const name = clientNameInput.value.trim();
      if (!name) {
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const date = dateInput.value || new Date().toISOString().slice(0,10);
      const title = titleInput.value.trim() || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
      const entries = getEntriesFromForm();
      if (!entries.length) {
        alert("Ø£Ø¶ÙÙ Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.");
        return;
      }

      const statement = {
        id: state.currentStatementId || ("st_" + Date.now()),
        date,
        title,
        entries,
        manualTotal: manualTotalInput.value.trim(),
        extraNotes: extraNotesInput.value.trim()
      };

      ensureClient(name);
      const list = state.data.clients[name].statements;
      const existingIndex = list.findIndex(s => s.id === statement.id);
      if (existingIndex >= 0) list[existingIndex] = statement;
      else list.unshift(statement);

      saveData();
      state.currentClient = name;
      state.currentStatementId = statement.id;

      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");
      renderStatementsList();
      renderTotalsForCurrentClient();
      updatePreviewText();
    }

    function loadStatement(name, id) {
      const client = state.data.clients[name];
      if (!client) return;
      const st = client.statements.find(s => s.id === id);
      if (!st) return;

      state.currentClient = name;
      state.currentStatementId = id;

      clientNameInput.value = name;
      dateInput.value = st.date;
      titleInput.value = st.title;
      manualTotalInput.value = st.manualTotal || "";
      extraNotesInput.value = st.extraNotes || "";

      entriesContainer.innerHTML = "";
      st.entries.forEach(e => addEntryRow(e));

      updatePreviewText();
      renderStatementsList();
      renderTotalsForCurrentClient();
    }

    function resetForm(keepClientName) {
      state.currentStatementId = null;
      if (keepClientName) clientNameInput.value = keepClientName;
      dateInput.value = new Date().toISOString().slice(0,10);
      titleInput.value = "";
      entriesContainer.innerHTML = "";
      manualTotalInput.value = "";
      extraNotesInput.value = "";
      addEntryRow();
      updatePreviewText();
      renderStatementsList();
      renderTotalsForCurrentClient();
    }

    function copyLastEntries() {
      const name = clientNameInput.value.trim();
      if (!name) {
        alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù Ù„Ù‡.");
        return;
      }
      const client = state.data.clients[name];
      if (!client || !client.statements.length) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");
        return;
      }
      const last = client.statements[0];
      entriesContainer.innerHTML = "";
      last.entries.forEach(e => {
        // Ù†Ù†Ø³Ø® Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ø¹Ù…Ù„Ø© ÙˆØ§Ù„Ø§ØªØ¬Ø§Ù‡ ÙÙ‚Ø·ØŒ ÙˆÙ†ØªØ±Ùƒ Ø§Ù„Ù…Ø¨Ù„Øº ØµÙØ±
        addEntryRow({ desc: e.desc, amount: 0, currency: e.currency, direction: e.direction });
      });
      updatePreviewText();
    }

    // ========= Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª / Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =========
    function renderStatementsList() {
      const name = clientNameInput.value.trim();
      statementsListEl.innerHTML = "";
      if (!name || !state.data.clients[name] || !state.data.clients[name].statements.length) {
        statementsListEl.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯.</div>';
        return;
      }
      state.currentClient = name;
      state.data.clients[name].statements.forEach(st => {
        const item = document.createElement("div");
        item.className = "saved-item";
        const titleSpan = document.createElement("span");
        titleSpan.textContent = st.title;
        const dateSpan = document.createElement("span");
        dateSpan.className = "date";
        dateSpan.textContent = st.date;
        item.append(titleSpan, dateSpan);
        item.onclick = () => {
          if (confirm("ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© / Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŸ")) {
            loadStatement(name, st.id);
          }
        };
        statementsListEl.appendChild(item);
      });
    }

    function renderClientsList() {
      clientsListEl.innerHTML = "";
      const names = Object.keys(state.data.clients || {});
      if (!names.length) {
        clientsListEl.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯. Ø§Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù‡Ù†Ø§.</div>';
        return;
      }
      names.forEach(name => {
        const div = document.createElement("div");
        div.className = "saved-item";
        const left = document.createElement("span");
        left.textContent = name;
        const right = document.createElement("span");
        right.className = "date";
        const last = state.data.clients[name].statements[0];
        right.textContent = last ? last.date : "";
        div.append(left, right);
        div.onclick = () => {
          showScreen("statements");
          loadStatement(name, state.data.clients[name].statements[0].id);
        };
        clientsListEl.appendChild(div);
      });
    }

    // ========= Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª =========
    function computeTotalsForClient(name) {
      const client = state.data.clients[name];
      if (!client) return {};
      const totals = {};
      client.statements.forEach(st => {
        st.entries.forEach(e => {
          if (!e.currency) return;
          if (!totals[e.currency]) totals[e.currency] = { lah: 0, alaih: 0 };
          if (e.direction === "Ù„Ù‡") totals[e.currency].lah += e.amount || 0;
          else totals[e.currency].alaih += e.amount || 0;
        });
      });
      return totals;
    }

    function renderTotalsForCurrentClient() {
      const name = clientNameInput.value.trim();
      if (!name || !state.data.clients[name]) {
        totalsBoxEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø­ÙØ¸ Ø£ÙˆÙ„ ÙƒØ´Ù Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙŠØ¸Ù‡Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‡Ù†Ø§.";
        return;
      }
      const totals = computeTotalsForClient(name);
      if (!Object.keys(totals).length) {
        totalsBoxEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.";
        return;
      }
      let text = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„: " + name + "\n----------------------\n";
      Object.keys(totals).forEach(curr => {
        const t = totals[curr];
        const lah = t.lah.toLocaleString("en-US");
        const alaih = t.alaih.toLocaleString("en-US");
        const diff = t.lah - t.alaih;
        text += `\n${curr}:\n`;
        text += `Ù„Ù‡: ${lah} ${curr}\n`;
        text += `Ø¹Ù„ÙŠÙ‡: ${alaih} ${curr}\n`;
        text += `Ø§Ù„ØµØ§ÙÙŠ: ${diff.toLocaleString("en-US")} ${curr}\n`;
      });
      totalsBoxEl.textContent = text;
    }

    // ========= Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ =========
    function updatePreviewText() {
      const name = clientNameInput.value.trim() || "Ø§Ù„Ø¹Ù…ÙŠÙ„";
      const date = dateInput.value || new Date().toISOString().slice(0,10);
      const title = titleInput.value.trim() || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
      const entries = getEntriesFromForm();
      let text = `${name}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n----------------\n${title}\n`;
      entries.forEach((e, i) => {
        const num = i + 1;
        const amount = e.amount ? e.amount.toLocaleString("en-US") : "0";
        text += `\n${num}- ${e.desc || "Ø¨Ù†Ø¯"} ${amount} ${e.currency} (${e.direction})`;
      });
      if (manualTotalInput.value.trim()) {
        text += `\n----------------\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${manualTotalInput.value.trim()}`;
      }
      if (extraNotesInput.value.trim()) {
        text += `\n\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª:\n${extraNotesInput.value.trim()}`;
      }
      whatsAppBox.textContent = text;
    }

    ["input","change"].forEach(ev => {
      clientNameInput.addEventListener(ev, updatePreviewText);
      dateInput.addEventListener(ev, updatePreviewText);
      titleInput.addEventListener(ev, updatePreviewText);
      manualTotalInput.addEventListener(ev, updatePreviewText);
      extraNotesInput.addEventListener(ev, updatePreviewText);
    });

    // ========= Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ€ PDF =========
    function printAsPdf() {
      const name = clientNameInput.value.trim() || "Ø§Ù„Ø¹Ù…ÙŠÙ„";
      const win = window.open("", "_blank");
      const html = `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ - ${name}</title>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif; margin:20px; }
h1 { font-size: 1.2rem; margin-bottom: 4px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ddd; padding: 4px 6px; font-size: .8rem; text-align: center; }
th { background: #e5e7eb; }
.notes { margin-top: 10px; font-size: .8rem; white-space: pre-wrap; }
</style>
</head>
<body>
<h1>ÙƒØ´Ù Ø­Ø³Ø§Ø¨</h1>
<div>Ø§Ù„Ø¹Ù…ÙŠÙ„: ${name}</div>
<div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateInput.value || ""}</div>
<div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${titleInput.value || ""}</div>
<table>
<thead>
<tr>
  <th>#</th>
  <th>Ø§Ù„ÙˆØµÙ</th>
  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
  <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
  <th>Ù„Ù‡ / Ø¹Ù„ÙŠÙ‡</th>
</tr>
</thead>
<tbody>
${getEntriesFromForm().map((e, i) => `
<tr>
  <td>${i+1}</td>
  <td>${e.desc || ""}</td>
  <td>${e.amount || 0}</td>
  <td>${e.currency || ""}</td>
  <td>${e.direction || ""}</td>
</tr>`).join("")}
</tbody>
</table>
<div class="notes">
<strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</strong> ${manualTotalInput.value || ""}<br>
<strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</strong><br>${(extraNotesInput.value || "").replace(/\n/g,"<br>")}
</div>
</body>
</html>`;
      win.document.write(html);
      win.document.close();
      win.focus();
      win.print();
    }

    // ========= PWA / ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =========
    const installButton = document.getElementById("installButton");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      state.deferredPrompt = e;
      installButton.style.display = "inline-flex";
    });

    installButton.addEventListener("click", async () => {
      if (!state.deferredPrompt) {
        alert('Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®ÙŠØ§Ø± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­.');
        return;
      }
      state.deferredPrompt.prompt();
      const choice = await state.deferredPrompt.userChoice;
      state.deferredPrompt = null;
      installButton.style.display = "none";
      if (choice.outcome === "accepted") {
        console.log("ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚");
      }
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(console.error);
    }

    // ========= ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© =========
    loadData();
    dateInput.value = new Date().toISOString().slice(0,10);
    addEntryRow();
    updatePreviewText();
  </script>
</body>
</html>
