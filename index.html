<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      background: #f5f7f9;
      color: #111827;
    }
    .app {
      max-width: 900px;
      margin: 16px auto 40px;
      background: #ffffff;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    h1 {
      text-align: center;
      margin: 0 0 8px;
      font-size: 22px;
      color: #059669;
    }
    .install-link {
      text-align: center;
      margin-bottom: 12px;
      font-size: 14px;
      color: #111827;
    }
    .install-btn {
      border: none;
      background: none;
      color: #059669;
      font-weight: 600;
      cursor: pointer;
      text-decoration: underline;
      display: none; /* Ù†ÙØ¸Ù‡Ø±Ù‡ Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„ØªØ«Ø¨ÙŠØª */
    }

    .tabs {
      display: flex;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      margin-bottom: 10px;
    }
    .tab {
      flex: 1;
      padding: 8px 0;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      background: #f9fafb;
      color: #111827;
    }
    .tab.active {
      background: #059669;
      color: #ffffff;
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 13px;
      margin: 8px 4px 4px;
      color: #374151;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #059669;
      box-shadow: 0 0 0 2px rgba(5,150,105,.15);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1;
      min-width: 120px;
    }

    .chip-btn, .primary-btn, .danger-btn, .secondary-btn {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .chip-btn {
      background: #10b981;
      color: #ffffff;
      font-weight: 600;
    }
    .secondary-btn {
      background: #e5e7eb;
      color: #111827;
    }
    .primary-btn {
      background: #059669;
      color: #ffffff;
      font-weight: 600;
      width: 100%;
      margin-top: 6px;
    }
    .danger-btn {
      background: #ef4444;
      color: #ffffff;
      font-weight: 600;
    }

    .items-container {
      margin-top: 8px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
    }
    .item-row {
      display: grid;
      grid-template-columns: minmax(0,2fr) minmax(0,1fr) minmax(0,1fr) auto;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfdf5;
      color: #059669;
      margin-right: 6px;
    }

    .section-title {
      margin: 14px 0 6px;
      font-size: 15px;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .history-list, .totals-box {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
      font-size: 13px;
    }
    .history-item {
      padding: 6px 8px;
      border-radius: 10px;
      background: #ecfdf5;
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-item span.title {
      font-weight: 600;
    }
    .history-item small {
      color: #6b7280;
    }

    .muted {
      font-size: 12px;
      color: #6b7280;
    }
    .whats-box {
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
    }

    @media (max-width: 600px) {
      .app { margin: 8px; padding: 12px; }
      .item-row {
        grid-template-columns: minmax(0,2fr) minmax(0,1fr) minmax(0,1fr) 70px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>ğŸ“’ Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    <div class="install-link">
      <button id="installButton" class="install-btn">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“±</button>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabStatements">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</div>
      <div class="tab" id="tabClients">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙƒØ´Ù -->
    <div id="statementsView">
      <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
      <input id="clientInput" list="clientsList" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ø®ØªØ±Ù‡">
      <datalist id="clientsList"></datalist>

      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input id="dateInput" type="date">

      <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
      <input id="titleInput" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† Ù…Ø­Ø¶Ø± Ø´Ø­Ù† Ù…Ù† Ø´Ø­Ù†">

      <div class="row" style="margin-top:6px">
        <button class="chip-btn" id="addItemBtn">+ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
        <button class="secondary-btn" id="copyLastItemsBtn">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù</button>
      </div>

      <div class="items-container" id="itemsContainer">
        <!-- Ø§Ù„Ø¨Ù†ÙˆØ¯ ØªØ¶Ø§Ù Ù‡Ù†Ø§ -->
      </div>

      <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <input id="manualTotalInput" placeholder="Ù…Ø«Ø§Ù„: 3,326,706 ÙŠÙ…Ù†ÙŠ + 2,300 Ø³Ø¹ÙˆØ¯ÙŠ">

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <textarea id="notesInput" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ´Ù"></textarea>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <button class="primary-btn" id="saveRecordBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        </div>
        <div style="flex:1">
          <button class="secondary-btn" id="newRecordSameClientBtn">+ ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)</button>
        </div>
      </div>

      <h3 class="section-title">ğŸ“¨ Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</h3>
      <div class="whats-box">
        <textarea id="whatsText" readonly></textarea>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <button class="secondary-btn" id="copyTextBtn">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
          </div>
          <div style="flex:1">
            <button class="chip-btn" id="shareWhatsappBtn">ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨</button>
          </div>
          <div style="flex:1">
            <button class="secondary-btn" id="sharePdfBtn">ğŸ“ Ù…Ø´Ø§Ø±ÙƒØ© ÙƒÙ€ PDF</button>
          </div>
        </div>
      </div>

      <h3 class="section-title">ğŸ“š Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:</h3>
      <div class="history-list" id="historyList">
        <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.</div>
      </div>

      <h3 class="section-title">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:</h3>
      <div class="totals-box" id="totalsBox">
        <div class="muted">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© ÙƒØ´ÙˆÙØ§Øª.</div>
      </div>

      <p class="muted" style="margin-top:10px">
        Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ Ø§Ø®ØªÙŠØ§Ø±: "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".
      </p>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø¨Ø³ÙŠØ· Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡) -->
    <div id="clientsView" style="display:none">
      <h3 class="section-title">ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
      <div class="history-list" id="clientsListView"></div>
      <p class="muted">Ø§Ø®ØªØ± Ø£ÙŠ Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ ÙƒØ´ÙˆÙØ§ØªÙ‡ ÙˆØªÙØ§ØµÙŠÙ„Ù‡.</p>
    </div>
  </div>

  <!-- jsPDF Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ================== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==================
    const clientInput = document.getElementById('clientInput');
    const dateInput = document.getElementById('dateInput');
    const titleInput = document.getElementById('titleInput');
    const itemsContainer = document.getElementById('itemsContainer');
    const manualTotalInput = document.getElementById('manualTotalInput');
    const notesInput = document.getElementById('notesInput');
    const whatsText = document.getElementById('whatsText');
    const historyList = document.getElementById('historyList');
    const totalsBox = document.getElementById('totalsBox');
    const clientsDatalist = document.getElementById('clientsList');
    const clientsListView = document.getElementById('clientsListView');

    let currentItems = [];
    let allData = loadData();
    let currentClient = '';
    let editingIndex = null; // Ù„Ùˆ Ù†Ø¹Ø¯Ù„ ÙƒØ´Ù Ù‚Ø¯ÙŠÙ…

    // Ø¶Ø¨Ø· ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    dateInput.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset() * 60000;

    // ================== Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ==================
    const tabStatements = document.getElementById('tabStatements');
    const tabClients = document.getElementById('tabClients');
    const statementsView = document.getElementById('statementsView');
    const clientsView = document.getElementById('clientsView');

    tabStatements.onclick = () => {
      tabStatements.classList.add('active');
      tabClients.classList.remove('active');
      statementsView.style.display = '';
      clientsView.style.display = 'none';
    };
    tabClients.onclick = () => {
      tabClients.classList.add('active');
      tabStatements.classList.remove('active');
      statementsView.style.display = 'none';
      clientsView.style.display = '';
      renderClientsView();
    };

    // ================== Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ®Ø²ÙŠÙ† ==================
    function loadData() {
      try {
        const raw = localStorage.getItem('voiceLedgerData');
        return raw ? JSON.parse(raw) : { clients: {} };
      } catch (e) {
        console.error(e);
        return { clients: {} };
      }
    }

    function saveData() {
      localStorage.setItem('voiceLedgerData', JSON.stringify(allData));
      refreshClientsOptions();
    }

    // ================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ ==================
    function renderItems() {
      itemsContainer.innerHTML = '';
      currentItems.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'item-row';

        const desc = document.createElement('input');
        desc.placeholder = 'ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù†ØŒ ØªØµØ±ÙŠØ­ØŒ Ø§Ù„Ø¬ÙˆØ§Ø²...)';
        desc.value = item.description || '';
        desc.oninput = () => { item.description = desc.value; updateWhatsText(); };

        const curr = document.createElement('select');
        ['ÙŠÙ…Ù†ÙŠ','Ø³Ø¹ÙˆØ¯ÙŠ','Ø¯ÙˆÙ„Ø§Ø±','Ø¯Ø±Ù‡Ù…','Ø¹ÙÙ…Ø§Ù†ÙŠ'].forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          if (item.currency === c) opt.selected = true;
          curr.appendChild(opt);
        });
        curr.onchange = () => { item.currency = curr.value; updateTotalsForRecord(); updateWhatsText(); };

        const amount = document.createElement('input');
        amount.type = 'number';
        amount.placeholder = 'Ø§Ù„Ù…Ø¨Ù„Øº';
        amount.value = item.amount ?? '';
        amount.oninput = () => {
          item.amount = parseFloat(amount.value || '0');
          updateTotalsForRecord();
          updateWhatsText();
        };

        const direction = document.createElement('select');
        ['Ù„Ù‡','Ø¹Ù„ÙŠÙ‡'].forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          if (item.direction === d) opt.selected = true;
          direction.appendChild(opt);
        });
        direction.onchange = () => { item.direction = direction.value; updateTotalsForRecord(); updateWhatsText(); };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'danger-btn';
        deleteBtn.textContent = 'Ø­Ø°Ù';
        deleteBtn.onclick = () => {
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) {
            currentItems.splice(idx,1);
            renderItems();
            updateTotalsForRecord();
            updateWhatsText();
          }
        };

        row.appendChild(desc);
        row.appendChild(curr);
        row.appendChild(amount);
        row.appendChild(direction);
        row.appendChild(deleteBtn);

        itemsContainer.appendChild(row);
      });

      if (currentItems.length === 0) {
        const p = document.createElement('div');
        p.className = 'muted';
        p.textContent = 'Ø£Ø¶Ù Ø¨Ù†ÙˆØ¯Ù‹Ø§ Ù„Ù„ÙƒØ´Ù Ø«Ù… Ø§Ø­ÙØ¸Ù‡.';
        itemsContainer.appendChild(p);
      }
    }

    document.getElementById('addItemBtn').onclick = () => {
      currentItems.push({
        description: '',
        currency: 'ÙŠÙ…Ù†ÙŠ',
        amount: 0,
        direction: 'Ù„Ù‡'
      });
      renderItems();
    };

    document.getElementById('copyLastItemsBtn').onclick = () => {
      const client = clientInput.value.trim();
      if (!client || !allData.clients[client] || allData.clients[client].records.length === 0) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù†Ø³Ø® Ø¨Ù†ÙˆØ¯Ù‡ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.');
        return;
      }
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¨Ù†ÙˆØ¯ Ø¢Ø®Ø± ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
      const last = allData.clients[client].records[allData.clients[client].records.length - 1];
      currentItems = last.items.map(it => ({
        description: it.description,
        currency: it.currency,
        amount: 0, // Ù†Ù†Ø³Ø® Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¨Ø§Ù„Øº
        direction: it.direction
      }));
      renderItems();
      updateTotalsForRecord();
      updateWhatsText();
    };

    // ================== Ø­ÙØ¸ ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª ==================
    function getClientData(name) {
      if (!allData.clients[name]) {
        allData.clients[name] = { records: [] };
      }
      return allData.clients[name];
    }

    function saveRecord() {
      const client = clientInput.value.trim();
      if (!client) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      if (currentItems.length === 0) { alert('Ø£Ø¶Ù Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ÙƒØ´Ù'); return; }

      const record = {
        date: dateInput.value || '',
        title: titleInput.value || '',
        items: currentItems.map(it => ({...it})),
        manualTotal: manualTotalInput.value || '',
        notes: notesInput.value || ''
      };

      const clientData = getClientData(client);

      if (editingIndex !== null) {
        // ØªØ¹Ø¯ÙŠÙ„ ÙƒØ´Ù Ù…ÙˆØ¬ÙˆØ¯
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´ÙØŸ')) return;
        clientData.records[editingIndex] = record;
        editingIndex = null;
      } else {
        // Ø¥Ø¶Ø§ÙØ© ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯
        clientData.records.push(record);
      }

      allData.clients[client] = clientData;
      saveData();
      currentClient = client;
      renderHistory(client);
      renderTotals(client);
      updateWhatsText(record);
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    }

    document.getElementById('saveRecordBtn').onclick = saveRecord;

    document.getElementById('newRecordSameClientBtn').onclick = () => {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
      editingIndex = null;
      currentItems = [];
      renderItems();
      manualTotalInput.value = '';
      notesInput.value = '';
      updateWhatsText();
    };

    function renderHistory(client) {
      historyList.innerHTML = '';
      const data = allData.clients[client];
      if (!data || data.records.length === 0) {
        const p = document.createElement('div');
        p.className = 'muted';
        p.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.';
        historyList.appendChild(p);
        totalsBox.innerHTML = '<div class="muted">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© ÙƒØ´ÙˆÙØ§Øª.</div>';
        return;
      }

      data.records.forEach((rec, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';

        const span = document.createElement('span');
        span.className = 'title';
        span.textContent = rec.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';

        const small = document.createElement('small');
        small.textContent = rec.date || '';

        const left = document.createElement('div');
        left.appendChild(span);
        left.appendChild(document.createElement('br'));
        left.appendChild(small);

        const buttons = document.createElement('div');
        buttons.style.display = 'flex';
        buttons.style.gap = '4px';

        const openBtn = document.createElement('button');
        openBtn.className = 'secondary-btn';
        openBtn.textContent = 'ÙØªØ­ / ØªØ¹Ø¯ÙŠÙ„';
        openBtn.style.padding = '4px 8px';
        openBtn.onclick = () => {
          loadRecordIntoForm(client, index);
        };

        const delBtn = document.createElement('button');
        delBtn.className = 'danger-btn';
        delBtn.textContent = 'Ø­Ø°Ù';
        delBtn.style.padding = '4px 8px';
        delBtn.onclick = () => {
          if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')) return;
          allData.clients[client].records.splice(index,1);
          saveData();
          renderHistory(client);
          renderTotals(client);
        };

        buttons.appendChild(openBtn);
        buttons.appendChild(delBtn);

        div.appendChild(left);
        div.appendChild(buttons);
        historyList.appendChild(div);
      });
    }

    function loadRecordIntoForm(client, index) {
      const rec = allData.clients[client].records[index];
      clientInput.value = client;
      dateInput.value = rec.date || '';
      titleInput.value = rec.title || '';
      manualTotalInput.value = rec.manualTotal || '';
      notesInput.value = rec.notes || '';
      currentItems = rec.items.map(it => ({...it}));
      editingIndex = index;
      currentClient = client;
      renderItems();
      updateTotalsForRecord();
      updateWhatsText(rec);
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // ================== Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ ==================
    function renderTotals(client) {
      const data = allData.clients[client];
      if (!data || data.records.length === 0) {
        totalsBox.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ.</div>';
        return;
      }

      const sums = {}; // currency -> { Ù„Ù‡, Ø¹Ù„ÙŠÙ‡ }
      data.records.forEach(rec => {
        rec.items.forEach(it => {
          if (!sums[it.currency]) sums[it.currency] = { Ù„Ù‡:0, Ø¹Ù„ÙŠÙ‡:0 };
          const val = Number(it.amount || 0);
          if (it.direction === 'Ù„Ù‡') sums[it.currency].Ù„Ù‡ += val;
          else sums[it.currency].Ø¹Ù„ÙŠÙ‡ += val;
        });
      });

      let html = `<div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„: ${client}</strong></div><hr>`;
      Object.keys(sums).forEach(curr => {
        const s = sums[curr];
        const net = s.Ù„Ù‡ - s.Ø¹Ù„ÙŠÙ‡;
        html += `
          <div style="margin-top:6px">
            <strong>${curr}:</strong><br>
            Ù„Ù‡: ${s.Ù„Ù‡.toLocaleString()} ${curr}<br>
            Ø¹Ù„ÙŠÙ‡: ${s.Ø¹Ù„ÙŠÙ‡.toLocaleString()} ${curr}<br>
            Ø§Ù„ØµØ§ÙÙŠ: ${net.toLocaleString()} ${curr}
          </div>
        `;
      });
      totalsBox.innerHTML = html;
    }

    function updateTotalsForRecord() {
      // ÙÙ‚Ø· Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ùˆ Ù„ÙŠØ³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„
      updateWhatsText();
    }

    // ================== Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ==================
    function updateWhatsText(recOptional) {
      const client = clientInput.value.trim() || 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
      const date = dateInput.value || '';
      const title = titleInput.value || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
      const rec = recOptional || { items: currentItems };

      let text = `${client}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n--------------\n`;

      rec.items.forEach((it, idx) => {
        if (!it.description && !it.amount) return;
        const amt = it.amount ? it.amount.toLocaleString() : '';
        text += `${idx+1}- ${it.description || ''} ${amt} ${it.currency || ''} (${it.direction || ''})\n`;
      });

      if (manualTotalInput.value) text += `--------------\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${manualTotalInput.value}\n`;
      if (notesInput.value) text += `--------------\n${notesInput.value}\n`;

      whatsText.value = text.trim();
    }

    // Ù†Ø³Ø® Ø§Ù„Ù†Øµ
    document.getElementById('copyTextBtn').onclick = async () => {
      try {
        await navigator.clipboard.writeText(whatsText.value);
        alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ âœ…');
      } catch (e) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
      }
    };

    // Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨
    document.getElementById('shareWhatsappBtn').onclick = () => {
      const encoded = encodeURIComponent(whatsText.value);
      window.open(`https://wa.me/?text=${encoded}`,'_blank');
    };

    // Ù…Ø´Ø§Ø±ÙƒØ© PDF
    document.getElementById('sharePdfBtn').onclick = async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const lines = doc.splitTextToSize(whatsText.value, 180);
      doc.text(lines, 10, 10);
      doc.save('ÙƒØ´Ù-Ø­Ø³Ø§Ø¨.pdf');
    };

    // ================== Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ ==================
    function refreshClientsOptions() {
      clientsDatalist.innerHTML = '';
      const names = Object.keys(allData.clients);
      names.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        clientsDatalist.appendChild(opt);
      });
    }

    function renderClientsView() {
      clientsListView.innerHTML = '';
      const names = Object.keys(allData.clients);
      if (names.length === 0) {
        clientsListView.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯.</div>';
        return;
      }
      names.forEach(name => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.onclick = () => {
          tabStatements.click();
          clientInput.value = name;
          currentClient = name;
          renderHistory(name);
          renderTotals(name);
        };
        const span = document.createElement('span');
        span.className = 'title';
        span.textContent = name;
        const count = allData.clients[name].records.length;
        const small = document.createElement('small');
        small.textContent = `${count} ÙƒØ´Ù`;
        div.appendChild(span);
        div.appendChild(small);
        clientsListView.appendChild(div);
      });
    }

    // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
    clientInput.addEventListener('change', () => {
      const client = clientInput.value.trim();
      currentClient = client;
      if (client && allData.clients[client]) {
        renderHistory(client);
        renderTotals(client);
      } else {
        historyList.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.</div>';
        totalsBox.innerHTML = '<div class="muted">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© ÙƒØ´ÙˆÙØ§Øª.</div>';
      }
      updateWhatsText();
    });

    // Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„
    refreshClientsOptions();
    renderItems();
    updateWhatsText();

    // ================== Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (PWA) ==================
    let deferredPrompt = null;
    const installButton = document.getElementById('installButton');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = 'inline-block';
    });

    installButton.addEventListener('click', async () => {
      if (!deferredPrompt) {
        alert('Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­: Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.');
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        console.log('User accepted install');
      }
      deferredPrompt = null;
      installButton.style.display = 'none';
    });

    // ================== ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ø³ÙŠØ· ==================
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }
  </script>
</body>
</html>
