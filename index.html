// ----- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª -----
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog;
if (SpeechRecognition) {
  recog = new SpeechRecognition();
  recog.lang = "ar-YE";  // Ø¹Ø±Ø¨ÙŠ â€“ Ø¬Ø±Ù‘Ø¨ "ar-SA" Ø£Ùˆ "ar" Ø¥Ø°Ø§ Ù…Ø§ Ø§Ø´ØªØºÙ„
  recog.continuous = false;
}

// Ø²Ø± Ø¨Ø³ÙŠØ· Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ (ØªØ¶ÙŠÙÙ‡ ÙÙŠ Ø§Ù„Ù€ HTML Ù…Ø«Ù„Ø§Ù‹)
const voiceBtn = document.createElement("button");
voiceBtn.textContent = "ğŸ¤ Ø£ÙˆØ§Ù…Ø± ØµÙˆØªÙŠØ©";
voiceBtn.className = "pill-btn pill-gray";
voiceBtn.style.marginTop = "8px";
document.querySelector(".install-bar").appendChild(voiceBtn);

voiceBtn.onclick = () => {
  if (!recog) {
    alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµÙˆØªÙŠØ©");
    return;
  }
  recog.start();
};

// ----- ØªÙ†ÙÙŠØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ -----
function handleVoiceCommand(text) {
  const t = text.trim();
  console.log("Ø³Ù…Ø¹Øª:", t);

  // Ø£Ù…Ø«Ù„Ø© Ø£ÙˆØ§Ù…Ø±:
  if (t.includes("ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯") || t.includes("Ø§ÙØªØ­ ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯")) {
    resetForm(clientNameInput.value);      // Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ
    speak("Ø­Ø§Ø¶Ø± ÙŠØ§ Ø¨Ø³Ø§Ù…ØŒ ÙØªØ­Øª ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„");
  } else if (t.includes("Ø£Ø¶Ù Ø¨Ù†Ø¯") || t.includes("Ø¶ÙŠÙ Ø¨Ù†Ø¯") || t.includes("Ø¶ÙŠÙ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯")) {
    addEntryRow();
    speak("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯");
  } else if (t.startsWith("Ø§Ù„ÙˆØµÙ")) {
    // Ù…Ø«Ø§Ù„: "Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¨ÙŠØ§Ù† ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†"
    const desc = t.replace("Ø§Ù„ÙˆØµÙ", "").trim();
    const lastRow = entriesContainer.querySelector(".entry-row:last-child");
    if (lastRow && desc) {
      lastRow.querySelector(".entry-desc").value = desc;
      updatePreviewText();
      speak("ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØµÙ");
    }
  } else if (t.startsWith("Ø§Ù„Ù…Ø¨Ù„Øº")) {
    // Ù…Ø«Ø§Ù„: "Ø§Ù„Ù…Ø¨Ù„Øº Ù…ÙŠØ© ÙˆØ®Ù…Ø³ÙŠÙ† Ø£Ù„Ù" â†’ Ù‡Ù†Ø§ Ø§Ù„Ø£ÙØ¶Ù„ ØªÙ‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    const raw = t.replace("Ø§Ù„Ù…Ø¨Ù„Øº", "").replace(/[^0-9]/g, "").trim();
    const lastRow = entriesContainer.querySelector(".entry-row:last-child");
    if (lastRow && raw) {
      const n = Number(raw);
      lastRow.querySelector(".entry-amount").value = n.toLocaleString("en-US");
      updatePreviewText();
      speak("ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº");
    }
  } else if (t.includes("Ø§Ù„Ø¹Ù…Ù„Ø© ÙŠÙ…Ù†ÙŠ")) {
    const lastRow = entriesContainer.querySelector(".entry-row:last-child");
    if (lastRow) {
      lastRow.querySelector(".entry-curr").value = "ÙŠÙ…Ù†ÙŠ";
      updatePreviewText();
      speak("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© ÙŠÙ…Ù†ÙŠ");
    }
  } else if (t.includes("Ø§Ù„Ø¹Ù…Ù„Ø© Ø³Ø¹ÙˆØ¯ÙŠ")) {
    const lastRow = entriesContainer.querySelector(".entry-row:last-child");
    if (lastRow) {
      lastRow.querySelector(".entry-curr").value = "Ø³Ø¹ÙˆØ¯ÙŠ";
      updatePreviewText();
      speak("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© Ø³Ø¹ÙˆØ¯ÙŠ");
    }
  } else if (t.includes("Ù„Ù‡")) {
    const lastRow = entriesContainer.querySelector(".entry-row:last-child");
    if (lastRow) {
      lastRow.querySelector(".entry-dir").value = "Ù„Ù‡";
      updatePreviewText();
      speak("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù„Ù‡");
    }
  } else if (t.includes("Ø¹Ù„ÙŠÙ‡")) {
    const lastRow = entriesContainer.querySelector(".entry-row:last-child");
    if (lastRow) {
      lastRow.querySelector(".entry-dir").value = "Ø¹Ù„ÙŠÙ‡";
      updatePreviewText();
      speak("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù„ÙŠÙ‡");
    }
  } else if (t.includes("Ø§Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù") || t.includes("Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù")) {
    saveCurrentStatement();
    speak("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù ÙŠØ§ Ø¨Ø³Ø§Ù…");
  } else {
    speak("Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ù„Ø£Ù…Ø±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
  }
}

// Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø« Ø¨Ø§Ù„Ù€ recognition
if (recog) {
  recog.onresult = (event) => {
    const text = event.results[0][0].transcript;
    handleVoiceCommand(text);
  };
  recog.onerror = (e) => {
    console.error(e);
    speak("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹");
  };
}

// ----- Ø±Ø¯ ØµÙˆØªÙŠ -----
function speak(text) {
  if (!("speechSynthesis" in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "ar-SA";
  window.speechSynthesis.speak(utter);
}
