<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    .app{
      max-width:980px;
      margin:12px auto 32px;
      padding:12px;
    }
    h1{
      margin:0 0 10px;
      font-size:1.35rem;
      text-align:center;
      color:#065f46;
    }
    .card{
      background:#ffffff;
      border-radius:18px;
      border:1px solid #e5e7eb;
      padding:12px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      margin-bottom:12px;
    }
    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:10px;
      background:#f3f4f6;
      padding:4px;
      border-radius:999px;
    }
    .tab-btn{
      flex:1;
      padding:8px;
      border-radius:999px;
      border:none;
      background:transparent;
      color:#6b7280;
      font-size:.9rem;
      cursor:pointer;
    }
    .tab-btn.active{
      background:#10b981;
      color:#ecfdf5;
      font-weight:600;
      box-shadow:0 1px 3px rgba(16,185,129,.4);
    }
    .row{
      display:flex;
      gap:8px;
      margin-bottom:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row label{
      min-width:90px;
      font-size:.85rem;
      color:#4b5563;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea,
    select{
      flex:1;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:#111827;
      font-size:.9rem;
    }
    input[type="number"]{
      max-width:120px;
      text-align:center;
      -moz-appearance:textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }
    textarea{
      min-height:70px;
      resize:vertical;
    }
    small{font-size:.75rem;color:#6b7280}
    .items-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:6px 0 4px;
      font-size:.85rem;
      flex-wrap:wrap;
      gap:6px;
    }
    .items-header-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .items-list{
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:6px;
      background:#f9fafb;
      max-height:260px;
      overflow-y:auto;
    }
    .item-row{
      display:flex;
      gap:6px;
      margin-bottom:4px;
      align-items:center;
      flex-wrap:wrap;
    }
    .item-row input[type="text"]{
      flex:2 1 160px;
    }
    .item-row input[type="number"]{
      flex:0 0 90px;
    }
    .item-row select{
      flex:0 0 80px;
      padding:4px 6px;
      font-size:.75rem;
    }
    .item-row button{
      padding:4px 8px;
      border-radius:999px;
      border:none;
      background:#ef4444;
      color:#fef2f2;
      font-size:.75rem;
      cursor:pointer;
    }
    .pill-btn{
      padding:4px 10px;
      border-radius:999px;
      border:1px dashed #6b7280;
      background:#ffffff;
      color:#065f46;
      font-size:.8rem;
      cursor:pointer;
    }
    .pill-btn:hover{
      background:#ecfdf5;
      border-color:#10b981;
    }
    .pill-btn:active,
    button:active{
      transform:translateY(1px);
      opacity:.95;
    }
    .primary-btn{
      width:100%;
      margin-top:8px;
      padding:9px;
      border-radius:12px;
      border:none;
      background:#10b981;
      color:#ecfdf5;
      font-weight:600;
      font-size:.95rem;
      cursor:pointer;
      box-shadow:0 2px 5px rgba(16,185,129,.35);
    }
    .primary-btn.editing{
      background:#0ea5e9;
      box-shadow:0 2px 5px rgba(14,165,233,.35);
    }
    .secondary-btn{
      width:100%;
      margin-top:6px;
      padding:8px;
      border-radius:12px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:#111827;
      font-size:.85rem;
      cursor:pointer;
    }
    .output textarea{
      width:100%;
      min-height:130px;
      margin-top:6px;
      background:#f9fafb;
    }
    .history-list{
      margin-top:6px;
      border-top:1px dashed #e5e7eb;
      padding-top:6px;
      max-height:180px;
      overflow-y:auto;
    }
    .history-item{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      margin-bottom:4px;
      cursor:pointer;
      font-size:.8rem;
      display:flex;
      justify-content:space-between;
      gap:6px;
      background:#f9fafb;
    }
    .history-item span{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60%;
    }
    .history-item small{
      color:#6366f1;
    }
    .history-item:hover{
      background:#ecfdf5;
      border-color:#10b981;
    }
    .customers-list{
      margin-top:8px;
      max-height:260px;
      overflow-y:auto;
    }
    .customer-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      margin-bottom:4px;
      font-size:.85rem;
      background:#f9fafb;
    }
    .customer-row-buttons button{
      border:none;
      padding:3px 8px;
      border-radius:999px;
      font-size:.75rem;
      cursor:pointer;
      margin-inline-start:4px;
    }
    .btn-small-danger{background:#b91c1c;color:#fee2e2;}
    .btn-small-neutral{background:#ffffff;color:#111827;border:1px solid #d1d5db;}
    @media (min-width:720px){
      .grid-2{
        display:grid;
        grid-template-columns:2.1fr 1.3fr;
        gap:12px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>

    <div class="card">
      <div class="tabs">
        <button id="tabStatements" class="tab-btn active">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</button>
        <button id="tabCustomers" class="tab-btn">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
      </div>

      <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
      <div id="statementsView">
        <div class="grid-2">
          <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙƒØ´Ù -->
          <div>
            <div class="row">
              <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
              <select id="customerSelect"></select>
            </div>
            <div class="row">
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
              <input type="date" id="dateInput">
            </div>
            <div class="row">
              <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
              <input type="text" id="titleInput" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† Ø´Ø­Ù†Ø© Ø´Ø§Ø´Ø§Øª Ù…Ù† Ø´Ø­Ù†">
            </div>

            <div class="items-header">
              <div>Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</div>
              <div class="items-header-actions">
                <button id="btnCloneLast" class="pill-btn">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù</button>
                <button id="btnAddItem" class="pill-btn">+ Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
              </div>
            </div>
            <div id="itemsList" class="items-list"></div>

            <div class="row" style="margin-top:6px;">
              <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</label>
              <input type="text" id="totalDisplay" readonly>
            </div>

            <textarea id="notesInput" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

            <button id="btnSaveStatement" class="primary-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
            <button id="btnNewStatement" class="secondary-btn">â• ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)</button>
          </div>

          <!-- Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² + Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙ -->
          <div>
            <div class="output">
              <small>Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</small>
              <textarea id="outputText" readonly></textarea>
              <button id="btnCopy" class="secondary-btn">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
            </div>

            <div class="history-list" id="historyList">
              <small>Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:</small>
            </div>
          </div>
        </div>
      </div>

      <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
      <div id="customersView" style="display:none;">
        <div class="row">
          <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
          <input type="text" id="customerNameInput" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø¯ÙŠØ§Ù†ØŒ Ù‚Ø§Ø·Ø±Ø© Ø²ÙƒÙŠØŒ ØªØ§Ø¬Ø± Ø§Ù„Ø±ÙŠØ§Ø¶ ...">
        </div>
        <div class="row">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø©:</label>
          <input type="text" id="customerNoteInput" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ø´Ø§ØªØŒ Ø¨Ø·Ø§Ø±ÙŠØ§ØªØŒ Ø´Ø­Ù†Ø§Øª Ø´Ù‡Ø±ÙŠØ© ...">
        </div>
        <button id="btnAddCustomer" class="primary-btn">â• Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ« Ø¹Ù…ÙŠÙ„</button>
        <small>Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªØ­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (localStorage)ØŒ ÙˆÙ„Ù† ØªØ¶ÙŠØ¹ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ù…Ø³Ø­Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.</small>

        <div class="customers-list" id="customersList"></div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_CUSTOMERS = "kashf_customers_v1";
    const STORAGE_STATEMENTS = "kashf_statements_v1";

    const CURRENCIES = [
      {code:"YER", label:"ÙŠÙ…Ù†ÙŠ"},
      {code:"SAR", label:"Ø³Ø¹ÙˆØ¯ÙŠ"},
      {code:"USD", label:"Ø¯ÙˆÙ„Ø§Ø±"},
      {code:"AED", label:"Ø¯Ø±Ù‡Ù…"},
      {code:"OMR", label:"Ø¹Ù…Ø§Ù†ÙŠ"}
    ];
    function currencyLabel(code){
      const c = CURRENCIES.find(x=>x.code===code);
      return c ? c.label : code;
    }

    let customers = [];
    let statements = [];
    let editingCustomerId = null;
    let editingStatementId = null;

    // DOM
    const tabStatements = document.getElementById("tabStatements");
    const tabCustomers = document.getElementById("tabCustomers");
    const statementsView = document.getElementById("statementsView");
    const customersView = document.getElementById("customersView");

    const customerSelect = document.getElementById("customerSelect");
    const dateInput = document.getElementById("dateInput");
    const titleInput = document.getElementById("titleInput");
    const itemsList = document.getElementById("itemsList");
    const totalDisplay = document.getElementById("totalDisplay");
    const notesInput = document.getElementById("notesInput");
    const historyList = document.getElementById("historyList");
    const outputText = document.getElementById("outputText");

    const customerNameInput = document.getElementById("customerNameInput");
    const customerNoteInput = document.getElementById("customerNoteInput");
    const customersListDiv = document.getElementById("customersList");

    const btnAddItem = document.getElementById("btnAddItem");
    const btnCloneLast = document.getElementById("btnCloneLast");
    const btnSaveStatement = document.getElementById("btnSaveStatement");
    const btnNewStatement = document.getElementById("btnNewStatement");
    const btnCopy = document.getElementById("btnCopy");
    const btnAddCustomer = document.getElementById("btnAddCustomer");

    function loadFromStorage() {
      try {
        const c = localStorage.getItem(STORAGE_CUSTOMERS);
        const s = localStorage.getItem(STORAGE_STATEMENTS);
        customers = c ? JSON.parse(c) : [];
        statements = s ? JSON.parse(s) : [];
        statements.forEach(st=>{
          if(Array.isArray(st.items)){
            st.items.forEach(it=>{
              if(!it.currency) it.currency = "YER";
              if(typeof it.amount !== "number"){
                const n = parseFloat(it.amount || "0");
                it.amount = isNaN(n)?0:n;
              }
            });
          }else{
            st.items = [];
          }
        });
      } catch {
        customers = [];
        statements = [];
      }
    }

    function saveCustomers() {
      localStorage.setItem(STORAGE_CUSTOMERS, JSON.stringify(customers));
    }
    function saveStatements() {
      localStorage.setItem(STORAGE_STATEMENTS, JSON.stringify(statements));
    }

    function formatNumber(n) {
      return n.toLocaleString("ar-EG");
    }
    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function formatDateForText(iso) {
      if (!iso) return "";
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    function computeTotalsByCurrency(items){
      const totals = {};
      items.forEach(it=>{
        const cur = it.currency || "YER";
        const amt = it.amount || 0;
        if(!totals[cur]) totals[cur] = 0;
        totals[cur] += amt;
      });
      return totals;
    }

    // ØªØ¨ÙˆÙŠØ¨Ø§Øª
    tabStatements.addEventListener("click", () => {
      tabStatements.classList.add("active");
      tabCustomers.classList.remove("active");
      statementsView.style.display = "";
      customersView.style.display = "none";
    });
    tabCustomers.addEventListener("click", () => {
      tabCustomers.classList.add("active");
      tabStatements.classList.remove("active");
      statementsView.style.display = "none";
      customersView.style.display = "";
    });

    // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    function renderCustomersSelect() {
      customerSelect.innerHTML = "";
      if (customers.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)";
        customerSelect.appendChild(opt);
        return;
      }
      customers.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        customerSelect.appendChild(opt);
      });
    }

    function renderCustomersList() {
      customersListDiv.innerHTML = "";
      if (customers.length === 0) {
        customersListDiv.innerHTML = "<small>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø£ÙˆÙ„ Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</small>";
        return;
      }
      customers.forEach(c => {
        const row = document.createElement("div");
        row.className = "customer-row";

        const info = document.createElement("div");
        info.innerHTML = `<strong>${c.name}</strong>${c.note ? `<div><small>${c.note}</small></div>` : ""}`;

        const btns = document.createElement("div");
        btns.className = "customer-row-buttons";

        const bEdit = document.createElement("button");
        bEdit.className = "btn-small-neutral";
        bEdit.textContent = "ØªØ¹Ø¯ÙŠÙ„";
        bEdit.onclick = () => {
          editingCustomerId = c.id;
          customerNameInput.value = c.name;
          customerNoteInput.value = c.note || "";
          customerNameInput.focus();
        };

        const bDel = document.createElement("button");
        bDel.className = "btn-small-danger";
        bDel.textContent = "Ø­Ø°Ù";
        bDel.onclick = () => {
          if (!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ Ù„Ù† ØªÙØ­Ø°Ù Ø§Ù„ÙƒØ´ÙˆÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.")) return;
          customers = customers.filter(x => x.id !== c.id);
          saveCustomers();
          renderCustomersSelect();
          renderCustomersList();
        };

        btns.appendChild(bEdit);
        btns.appendChild(bDel);

        row.appendChild(info);
        row.appendChild(btns);
        customersListDiv.appendChild(row);
      });
    }

    btnAddCustomer.addEventListener("click", () => {
      const name = customerNameInput.value.trim();
      const note = customerNoteInput.value.trim();
      if (!name) {
        alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      if (editingCustomerId) {
        const c = customers.find(x => x.id === editingCustomerId);
        if (c) {
          c.name = name;
          c.note = note;
        }
        editingCustomerId = null;
      } else {
        const id = "c_" + Date.now();
        customers.push({id, name, note});
      }
      customerNameInput.value = "";
      customerNoteInput.value = "";
      saveCustomers();
      renderCustomersSelect();
      renderCustomersList();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„.");
    });

    // Ø§Ù„Ø¨Ù†ÙˆØ¯
    function addItem(desc = "", amount = "", currency = "YER") {
      const row = document.createElement("div");
      row.className = "item-row";

      const inputDesc = document.createElement("input");
      inputDesc.type = "text";
      inputDesc.placeholder = "ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† ÙˆØªØ­Ø³ÙŠÙ†ØŒ Ø§Ù„Ø­Ù…Ø§Ù„ÙŠÙ†ØŒ Ø§Ù„Ø¬ÙˆØ§Ø² ...)";
      inputDesc.value = desc;

      const inputAmount = document.createElement("input");
      inputAmount.type = "number";
      inputAmount.placeholder = "Ø§Ù„Ù…Ø¨Ù„Øº";
      inputAmount.value = amount;

      const selectCur = document.createElement("select");
      CURRENCIES.forEach(cur=>{
        const opt = document.createElement("option");
        opt.value = cur.code;
        opt.textContent = cur.label;
        selectCur.appendChild(opt);
      });
      selectCur.value = currency || "YER";

      inputAmount.addEventListener("input", updateTotal);
      inputDesc.addEventListener("input", updateOutput);
      selectCur.addEventListener("change", () => { updateTotal(); });

      const btnDel = document.createElement("button");
      btnDel.textContent = "Ø­Ø°Ù";
      btnDel.onclick = () => {
        itemsList.removeChild(row);
        updateTotal();
      };

      row.appendChild(inputDesc);
      row.appendChild(inputAmount);
      row.appendChild(selectCur);
      row.appendChild(btnDel);
      itemsList.appendChild(row);
    }

    btnAddItem.addEventListener("click", () => {
      addItem();
    });

    function getItemsFromUI() {
      const rows = Array.from(itemsList.querySelectorAll(".item-row"));
      return rows.map(row => {
        const inputDesc = row.querySelector('input[type="text"]');
        const inputAmount = row.querySelector('input[type="number"]');
        const selectCur = row.querySelector('select');
        const desc = (inputDesc.value || "").trim();
        const amount = parseFloat(inputAmount.value || "0");
        const currency = selectCur ? selectCur.value : "YER";
        return {
          desc,
          amount: isNaN(amount) ? 0 : amount,
          currency
        };
      }).filter(x => x.desc || x.amount);
    }

    function updateTotal() {
      const items = getItemsFromUI();
      const totals = computeTotalsByCurrency(items);
      const entries = Object.entries(totals).filter(([,v])=>v>0);
      let display = "";
      if(entries.length){
        display = entries
          .map(([code,sum])=>`${currencyLabel(code)}: ${formatNumber(sum)}`)
          .join(" | ");
      }
      totalDisplay.value = display;
      updateOutput();
    }

    function updateOutput() {
      const customerId = customerSelect.value;
      const customer = customers.find(c => c.id === customerId);
      const date = dateInput.value;
      const title = titleInput.value.trim();
      const notes = notesInput.value.trim();
      const items = getItemsFromUI();
      if (!customer && items.length === 0 && !title && !notes) {
        outputText.value = "";
        return;
      }

      const totals = computeTotalsByCurrency(items);
      const lines = [];

      if (customer) lines.push(customer.name);
      if (title) lines.push(title);
      if (date) lines.push("Ø§Ù„ØªØ§Ø±ÙŠØ®: " + formatDateForText(date));
      lines.push("");

      items.forEach((it, idx) => {
        const n = idx+1;
        const amt = formatNumber(it.amount || 0);
        const curLabel = currencyLabel(it.currency || "YER");
        if (it.desc) {
          lines.push(`${n}- ${amt} ${curLabel} - ${it.desc}`);
        } else {
          lines.push(`${n}- ${amt} ${curLabel}`);
        }
      });

      const totalEntries = Object.entries(totals).filter(([,v])=>v>0);
      if (totalEntries.length){
        lines.push("--------------");
        totalEntries.forEach(([code,sum])=>{
          lines.push(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${currencyLabel(code)}: ${formatNumber(sum)}`);
        });
      }

      if (notes) {
        lines.push("");
        lines.push("Ù…Ù„Ø§Ø­Ø¸Ø§Øª:");
        lines.push(notes);
      }

      outputText.value = lines.join("\n");
    }

    // Ø­ÙØ¸ / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ´ÙˆÙ
    function saveCurrentStatement() {
      const customerId = customerSelect.value;
      if (!customerId) {
        alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const customer = customers.find(c => c.id === customerId);
      if (!customer) {
        alert("Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
        return;
      }
      const date = dateInput.value || todayISO();
      const title = titleInput.value.trim();
      const notes = notesInput.value.trim();
      const items = getItemsFromUI();
      if (items.length === 0) {
        if (!confirm("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒØ´ÙØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ Ù…Ø¹ Ø°Ù„ÙƒØŸ")) return;
      }
      const totals = computeTotalsByCurrency(items);
      const totalAll = Object.values(totals).reduce((a,b)=>a+b,0);

      if (editingStatementId) {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´ÙØŸ")) return;
        const idx = statements.findIndex(st=>st.id === editingStatementId);
        if (idx !== -1) {
          const old = statements[idx];
          statements[idx] = {
            ...old,
            customerId,
            date,
            title,
            notes,
            items,
            total: totalAll,
            updatedAt: new Date().toISOString()
          };
        }
        saveStatements();
        editingStatementId = null;
        btnSaveStatement.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„";
        btnSaveStatement.classList.remove("editing");
        renderHistory();
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ´Ù.");
      } else {
        const stmt = {
          id: "s_" + Date.now(),
          customerId,
          date,
          title,
          notes,
          items,
          total: totalAll,
          createdAt: new Date().toISOString()
        };
        statements.push(stmt);
        saveStatements();
        renderHistory();
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù.");
      }
    }

    btnSaveStatement.addEventListener("click", () => {
      updateTotal();
      saveCurrentStatement();
    });

    function renderHistory() {
      const customerId = customerSelect.value;
      historyList.innerHTML = "";
      if (!customerId) {
        historyList.innerHTML = "<small>Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ ÙƒØ´ÙˆÙÙ‡.</small>";
        return;
      }
      const list = statements
        .filter(s => s.customerId === customerId)
        .sort((a,b)=> (b.date || "").localeCompare(a.date || "") || (b.createdAt||"").localeCompare(a.createdAt||""));

      if (list.length === 0) {
        historyList.innerHTML = "<small>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯.</small>";
        return;
      }
      list.forEach(s => {
        const div = document.createElement("div");
        div.className = "history-item";
        const dateText = s.date ? formatDateForText(s.date) : "";
        const totals = computeTotalsByCurrency(s.items || []);
        const entries = Object.entries(totals).filter(([,v])=>v>0);
        let preview = "";
        if(entries.length){
          preview = entries
            .map(([code,sum])=>`${formatNumber(sum)} ${currencyLabel(code)}`)
            .join(" + ");
        }
        div.innerHTML = `<span>${dateText} - ${s.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</span><small>${preview}</small>`;
        div.onclick = () => loadStatementToForm(s);
        historyList.appendChild(div);
      });
    }

    function loadStatementToForm(s) {
      const customerId = s.customerId;
      if (customers.find(c => c.id === customerId)) {
        customerSelect.value = customerId;
      }
      dateInput.value = s.date || todayISO();
      titleInput.value = s.title || "";
      notesInput.value = s.notes || "";
      itemsList.innerHTML = "";
      (s.items || []).forEach(it => addItem(it.desc, it.amount, it.currency || "YER"));
      updateTotal();
      updateOutput();
      editingStatementId = s.id;
      btnSaveStatement.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´Ù";
      btnSaveStatement.classList.add("editing");
      alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ´Ù ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª.");
    }

    btnNewStatement.addEventListener("click", () => {
      const currentCustomer = customerSelect.value;
      titleInput.value = "";
      notesInput.value = "";
      itemsList.innerHTML = "";
      addItem();
      dateInput.value = todayISO();
      if (currentCustomer) customerSelect.value = currentCustomer;
      updateTotal();
      updateOutput();
      editingStatementId = null;
      btnSaveStatement.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„";
      btnSaveStatement.classList.remove("editing");
    });

    // Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù
    btnCloneLast.addEventListener("click", () => {
      const customerId = customerSelect.value;
      if(!customerId){
        alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const list = statements
        .filter(s => s.customerId === customerId)
        .sort((a,b)=> (b.date || "").localeCompare(a.date || "") || (b.createdAt||"").localeCompare(a.createdAt||""));
      if(!list.length){
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù†Ù‡.");
        return;
      }
      const last = list[0];
      if(!last.items || !last.items.length){
        alert("Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ù†ÙˆØ¯.");
        return;
      }
      if(!confirm("Ù†Ø³Ø® Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¨Ø§Ù„Øº)ØŸ")) return;

      itemsList.innerHTML = "";
      last.items.forEach(it=> addItem(it.desc, "", it.currency || "YER"));
      updateTotal();
      updateOutput();
      editingStatementId = null;
      btnSaveStatement.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„";
      btnSaveStatement.classList.remove("editing");
    });

    // Ù†Ø³Ø® Ø§Ù„Ù†Øµ
    btnCopy.addEventListener("click", () => {
      const text = outputText.value;
      if (!text) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù†Ø³Ø®Ù‡.");
        return;
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(()=>{
          alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØµØŒ Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.");
        }).catch(()=>{
          outputText.select();
          document.execCommand("copy");
          alert("Ø­Ø§ÙˆÙ„Ù†Ø§ Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ‘Ù„.");
        });
      } else {
        outputText.select();
        document.execCommand("copy");
        alert("Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ‘Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.");
      }
    });

    // ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    customerSelect.addEventListener("change", () => {
      renderHistory();
      updateOutput();
      editingStatementId = null;
      btnSaveStatement.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„";
      btnSaveStatement.classList.remove("editing");
    });
    dateInput.addEventListener("change", updateOutput);
    titleInput.addEventListener("input", updateOutput);
    notesInput.addEventListener("input", updateOutput);

    // ØªÙ‡ÙŠØ¦Ø©
    function init() {
      loadFromStorage();
      if (customers.length === 0) {
        const def = {id:"c_default", name:"Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…", note:"ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯"};
        customers.push(def);
        saveCustomers();
      }
      renderCustomersSelect();
      renderCustomersList();
      dateInput.value = todayISO();
      addItem();
      updateTotal();
      renderHistory();
    }

    init();
  </script>
</body>
</html>
