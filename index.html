<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Ø±Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª ÙƒÙ€ PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#16a34a">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 480px;
      background: #020617;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid #1f2937;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 22px;
      text-align: center;
      margin: 0 0 12px;
      color: #f9fafb;
    }
    .tabs {
      display: flex;
      margin-bottom: 12px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
    }
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 14px;
    }
    .tab.active {
      background: #16a34a;
      color: #ffffff;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #d1d5db;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 11px;
      margin-bottom: 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #f9fafb;
      font-size: 14px;
    }
    textarea {
      border-radius: 12px;
      min-height: 70px;
      resize: vertical;
    }
    input::placeholder, textarea::placeholder {
      color: #6b7280;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .row > * {
      flex: 1;
    }
    .row .amount {
      max-width: 130px;
    }
    .row .currency {
      max-width: 110px;
    }
    .row .delete-btn {
      max-width: 90px;
      flex: 0 0 auto;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-main {
      background: #16a34a;
      color: #ffffff;
      width: 100%;
      margin-top: 8px;
    }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
      width: 100%;
    }
    .btn-small {
      font-size: 13px;
      padding-inline: 10px;
    }
    .items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0 4px;
      font-size: 13px;
    }
    .items-header span {
      color: #d1d5db;
    }
    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .preview-box {
      background: #020617;
      border: 1px dashed #374151;
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      white-space: pre-wrap;
      min-height: 60px;
    }
    .list {
      margin-top: 8px;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid #1f2937;
    }
    .list-item {
      padding: 8px 10px;
      font-size: 13px;
      border-bottom: 1px solid #111827;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .list-item button {
      padding: 5px 10px;
      font-size: 12px;
    }
    .badge {
      background: #111827;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      color: #9ca3af;
    }
    .install-btn {
      background: #16a34a;
      color: #fff;
      width: 100%;
      margin: 8px 0 0;
    }
    .install-hint {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      margin-top: 4px;
    }
    @media (prefers-color-scheme: light) {
      body { background:#f3f4f6; }
      .app { background:#f3f4f6; }
      .card { background:#ffffff; border-color:#e5e7eb; }
      input, select, textarea { background:#ffffff; border-color:#e5e7eb; color:#111827; }
      .preview-box { background:#f9fafb; border-color:#e5e7eb; }
      .list { border-color:#e5e7eb; }
      .list-item { border-color:#f3f4f6; }
      .tabs { background:#e5e7eb; border-color:#d1d5db; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Ø¯ÙØªØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>

      <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª / Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
      <div class="tabs">
        <button id="tabStatements" class="tab active">Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</button>
        <button id="tabClients" class="tab">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª -->
      <div id="screenStatements">
        <label for="clientSelect">Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
        <select id="clientSelect"></select>

        <label for="dateInput">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateInput">

        <label for="titleInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù:</label>
        <input id="titleInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† Ø´Ø­Ù†Ø© Ø´Ø§Ø´Ø§Øª Ù…Ù† Ø´Ø­Ù†">

        <div class="items-header">
          <span>Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</span>
          <button id="copyLastItemsBtn" class="btn-secondary btn-small">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Ø¢Ø®Ø± ÙƒØ´Ù</button>
        </div>
        <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ Ù…ØªØ¹Ø¯Ø¯Ø©ØŒ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø© Ù„ÙƒÙ„ Ø¨Ù†Ø¯.</div>

        <div id="itemsContainer"></div>

        <button id="addItemBtn" class="btn-secondary btn-small" style="width:100%;margin-bottom:8px;">
          + Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
        </button>

        <label for="totalInput">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <input id="totalInput" type="text" placeholder="Ù…Ø«Ø§Ù„: 3,326,706 ÙŠÙ…Ù†ÙŠ + 2,300 Ø³Ø¹ÙˆØ¯ÙŠ">

        <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ù„ØµØ§Ù„Ø­Ù‡ -->
        <label for="directionSelect">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</label>
        <select id="directionSelect">
          <option value="on_client">Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
          <option value="for_client">Ø§Ù„Ù…Ø¨Ù„Øº Ù„ØµØ§Ù„Ø­ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
        </select>

        <label for="notesInput">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <textarea id="notesInput" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒØ´Ù"></textarea>

        <button id="saveStatementBtn" class="btn-main">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>

        <button id="newStatementSameClientBtn" class="btn-secondary" style="width:100%;margin-top:8px;">
          â• ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„)
        </button>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
      <div id="screenClients" style="display:none;">
        <label>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:</label>
        <input id="newClientNameInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø¯ÙŠØ¨Ø§Ù†">
        <button id="addClientBtn" class="btn-main">+ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</button>

        <div class="hint" style="margin-top:8px;">Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:</div>
        <div id="clientsList" class="list"></div>
      </div>
    </div>

    <!-- Ù†Øµ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª + Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ + ØªØ«Ø¨ÙŠØª -->
    <div class="card">
      <label>Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</label>
      <div id="previewBox" class="preview-box"></div>
      <button id="copyTextBtn" class="btn-secondary" style="width:100%;margin-top:8px;">
        ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ
      </button>

      <div class="hint" style="margin-top:10px;">Ø³Ø¬Ù„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:</div>
      <div id="statementsList" class="list"></div>

      <!-- Ø²Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <button id="showClientTotalsBtn" class="btn-secondary" style="width:100%;margin-top:8px;">
        ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„
      </button>
      <div id="clientTotalsPanel" class="preview-box" style="margin-top:6px; display:none;"></div>

      <!-- Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
      <button id="installButton" class="install-btn" hidden>
        ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
      </button>
      <div class="install-hint">
        Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ â‹® Ø§Ø®ØªÙŠØ§Ø± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".
      </div>
    </div>
  </div>

  <script>
    // ===== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ =====
    const STORAGE_KEY = 'kashfHesab_v1';
    let db = { clients: [], statements: [] };
    let currentStatementId = null;

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) db = JSON.parse(raw);
      } catch (e) {
        console.error('Error loading', e);
      }
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    }

    function formatNumber(num) {
      if (num == null || isNaN(num)) return '0';
      try {
        return num.toLocaleString('ar-EG');
      } catch {
        return String(num);
      }
    }

    // ===== Ø¹Ù†Ø§ØµØ± DOM =====
    const clientSelect = document.getElementById('clientSelect');
    const dateInput = document.getElementById('dateInput');
    const titleInput = document.getElementById('titleInput');
    const itemsContainer = document.getElementById('itemsContainer');
    const totalInput = document.getElementById('totalInput');
    const notesInput = document.getElementById('notesInput');
    const directionSelect = document.getElementById('directionSelect');
    const previewBox = document.getElementById('previewBox');
    const statementsList = document.getElementById('statementsList');
    const clientsList = document.getElementById('clientsList');
    const showClientTotalsBtn = document.getElementById('showClientTotalsBtn');
    const clientTotalsPanel = document.getElementById('clientTotalsPanel');

    // ===== ØªØ¨ÙˆÙŠØ¨Ø§Øª =====
    const tabStatements = document.getElementById('tabStatements');
    const tabClients = document.getElementById('tabClients');
    const screenStatements = document.getElementById('screenStatements');
    const screenClients = document.getElementById('screenClients');

    tabStatements.addEventListener('click', () => {
      tabStatements.classList.add('active');
      tabClients.classList.remove('active');
      screenStatements.style.display = '';
      screenClients.style.display = 'none';
    });

    tabClients.addEventListener('click', () => {
      tabClients.classList.add('active');
      tabStatements.classList.remove('active');
      screenStatements.style.display = 'none';
      screenClients.style.display = '';
      renderClientsList();
    });

    // ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =====
    function renderClientsSelect() {
      clientSelect.innerHTML = '';
      if (db.clients.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„Ù‹Ø§ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"';
        clientSelect.appendChild(opt);
        return;
      }
      db.clients.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        clientSelect.appendChild(opt);
      });
    }

    function renderClientsList() {
      clientsList.innerHTML = '';
      if (db.clients.length === 0) {
        clientsList.innerHTML = '<div class="list-item">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯.</div>';
        return;
      }
      db.clients.forEach(name => {
        const div = document.createElement('div');
        div.className = 'list-item';
        const left = document.createElement('div');
        left.textContent = name;
        const right = document.createElement('div');

        const count = db.statements.filter(s => s.client === name).length;
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = count + ' ÙƒØ´Ù';

        const openClientBtn = document.createElement('button');
        openClientBtn.className = 'btn-secondary btn-small';
        openClientBtn.textContent = 'ğŸ“„ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„';
        openClientBtn.style.marginLeft = '4px';
        openClientBtn.addEventListener('click', () => {
          // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø±Ø¬ÙˆØ¹ Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª
          clientSelect.value = name;
          tabStatements.click();
          renderStatementsList();
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-danger btn-small';
        delBtn.textContent = 'Ø­Ø°Ù';
        delBtn.addEventListener('click', () => {
          if (!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙƒÙ„ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
          db.clients = db.clients.filter(c => c !== name);
          db.statements = db.statements.filter(s => s.client !== name);
          saveToStorage();
          renderClientsSelect();
          renderClientsList();
          renderStatementsList();
          clientTotalsPanel.style.display = 'none';
        });

        right.appendChild(badge);
        right.appendChild(openClientBtn);
        right.appendChild(delBtn);
        div.appendChild(left);
        div.appendChild(right);
        clientsList.appendChild(div);
      });
    }

    document.getElementById('addClientBtn').addEventListener('click', () => {
      const name = document.getElementById('newClientNameInput').value.trim();
      if (!name) {
        alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      if (db.clients.includes(name)) {
        alert('Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
        return;
      }
      db.clients.push(name);
      saveToStorage();
      document.getElementById('newClientNameInput').value = '';
      renderClientsSelect();
      renderClientsList();
      alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„');
    });

    // ===== Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙƒØ´Ù =====
    function makeItemRow(item = { description: '', amount: '', currency: 'ÙŠÙ…Ù†ÙŠ' }) {
      const row = document.createElement('div');
      row.className = 'row';

      const desc = document.createElement('input');
      desc.type = 'text';
      desc.placeholder = 'ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯ (Ù…Ø«Ø§Ù„: Ø¨ÙŠØ§Ù† ÙˆØªØ­Ø³ÙŠÙ†ØŒ Ø§Ù„Ø­Ù…Ù„ÙŠÙ†ØŒ Ø§Ù„Ø¬ÙˆØ§Ø²...)';
      desc.value = item.description || '';

      const amount = document.createElement('input');
      amount.type = 'number';
      amount.className = 'amount';
      amount.placeholder = 'Ø§Ù„Ù…Ø¨Ù„Øº';
      amount.value = item.amount || '';

      const currency = document.createElement('select');
      currency.className = 'currency';
      ['ÙŠÙ…Ù†ÙŠ','Ø³Ø¹ÙˆØ¯ÙŠ','Ø¯Ø±Ù‡Ù…','Ø¯ÙˆÙ„Ø§Ø±','Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ'].forEach(cur => {
        const o = document.createElement('option');
        o.value = cur;
        o.textContent = cur;
        if (cur === (item.currency || 'ÙŠÙ…Ù†ÙŠ')) o.selected = true;
        currency.appendChild(o);
      });

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-danger delete-btn btn-small';
      delBtn.textContent = 'Ø­Ø°Ù';
      delBtn.addEventListener('click', () => {
        itemsContainer.removeChild(row);
      });

      row.appendChild(desc);
      row.appendChild(amount);
      row.appendChild(currency);
      row.appendChild(delBtn);
      return row;
    }

    function getItemsFromUI() {
      const rows = Array.from(itemsContainer.children);
      return rows.map(row => {
        const [desc, amount, currency, _btn] = row.querySelectorAll('input, select, button');
        return {
          description: desc.value.trim(),
          amount: amount.value ? Number(amount.value) : '',
          currency: currency.value
        };
      }).filter(i => i.description || i.amount);
    }

    function setItemsToUI(items) {
      itemsContainer.innerHTML = '';
      items.forEach(item => {
        itemsContainer.appendChild(makeItemRow(item));
      });
      if (items.length === 0) {
        itemsContainer.appendChild(makeItemRow());
      }
    }

    document.getElementById('addItemBtn').addEventListener('click', () => {
      itemsContainer.appendChild(makeItemRow());
    });

    // Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ø¨Ø§Ù„Øº (ÙÙ‚Ø· Ø§Ù„ÙˆØµÙ + Ø§Ù„Ø¹Ù…Ù„Ø©)
    document.getElementById('copyLastItemsBtn').addEventListener('click', () => {
      const client = clientSelect.value;
      if (!client) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      const clientStatements = db.statements
        .filter(s => s.client === client)
        .sort((a, b) => b.createdAt - a.createdAt);
      if (clientStatements.length === 0) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ´Ù Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù†Ù‡');
        return;
      }
      const last = clientStatements[0];
      const copiedItems = (last.items || []).map(it => ({
        description: it.description,
        amount: '',
        currency: it.currency || 'ÙŠÙ…Ù†ÙŠ'
      }));
      setItemsToUI(copiedItems);
      alert('ØªÙ… Ù†Ø³Ø® Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ (Ø¨Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„Øº)ØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
    });

    // ===== Ø­ÙØ¸ / ØªØ­Ù…ÙŠÙ„ ÙƒØ´Ù =====
    function clearForm(keepClient = true) {
      if (!keepClient) clientSelect.selectedIndex = 0;
      const today = new Date().toISOString().slice(0,10);
      dateInput.value = today;
      titleInput.value = '';
      totalInput.value = '';
      notesInput.value = '';
      directionSelect.value = 'on_client';
      setItemsToUI([]);
      currentStatementId = null;
      previewBox.textContent = '';
      clientTotalsPanel.style.display = 'none';
    }

    function renderStatementsList() {
      const client = clientSelect.value;
      statementsList.innerHTML = '';
      if (!client) {
        statementsList.innerHTML = '<div class="list-item">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª.</div>';
        return;
      }
      const list = db.statements
        .filter(s => s.client === client)
        .sort((a,b) => b.createdAt - a.createdAt);

      if (list.length === 0) {
        statementsList.innerHTML = '<div class="list-item">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.</div>';
        return;
      }

      list.forEach(s => {
        const div = document.createElement('div');
        div.className = 'list-item';

        const left = document.createElement('div');
        left.innerHTML = `<strong>${s.date}</strong><br>${s.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}`;

        const right = document.createElement('div');
        const openBtn = document.createElement('button');
        openBtn.className = 'btn-secondary btn-small';
        openBtn.textContent = 'ÙØªØ­ / ØªØ¹Ø¯ÙŠÙ„';
        openBtn.addEventListener('click', () => loadStatementToForm(s.id));

        right.appendChild(openBtn);
        div.appendChild(left);
        div.appendChild(right);
        statementsList.appendChild(div);
      });
    }

    function generatePreviewText(stmt) {
      let lines = [];
      lines.push(stmt.client);
      lines.push('Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + stmt.date);
      if (stmt.title) lines.push(stmt.title);
      lines.push('---------------------');

      stmt.items.forEach((item, idx) => {
        const num = idx + 1;
        const amountStr = item.amount ? ` - ${item.amount} ${item.currency}` : '';
        lines.push(`${num}- ${item.description}${amountStr}`);
      });

      if (stmt.total) {
        lines.push('---------------------');
        lines.push('Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + stmt.total);
      }
      if (stmt.direction === 'on_client') {
        lines.push('Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„');
      } else if (stmt.direction === 'for_client') {
        lines.push('Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„Ù…Ø¨Ù„Øº Ù„ØµØ§Ù„Ø­ Ø§Ù„Ø¹Ù…ÙŠÙ„');
      }
      if (stmt.notes) {
        lines.push('---------------------');
        lines.push(stmt.notes);
      }

      return lines.join('\n');
    }

    function saveCurrentStatement() {
      const client = clientSelect.value;
      if (!client) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      const date = dateInput.value || new Date().toISOString().slice(0,10);
      const title = titleInput.value.trim();
      const items = getItemsFromUI();
      const total = totalInput.value.trim();
      const notes = notesInput.value.trim();
      const direction = directionSelect.value || 'on_client';

      if (items.length === 0) {
        alert('Ø£Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ù†Ø¯Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒØ´Ù');
        return;
      }

      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ´ÙØŸ')) return;

      const base = {
        client,
        date,
        title,
        items,
        total,
        notes,
        direction,
      };

      if (!currentStatementId) {
        const id = 's_' + Date.now();
        const stmt = {
          id,
          ...base,
          createdAt: Date.now()
        };
        db.statements.push(stmt);
        currentStatementId = id;
      } else {
        const idx = db.statements.findIndex(s => s.id === currentStatementId);
        if (idx !== -1) {
          db.statements[idx] = {
            ...db.statements[idx],
            ...base
          };
        }
      }

      saveToStorage();
      const stmtObj = db.statements.find(s => s.id === currentStatementId);
      const text = generatePreviewText(stmtObj);
      previewBox.textContent = text;
      renderStatementsList();
      clientTotalsPanel.style.display = 'none';
      alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
    }

    function loadStatementToForm(id) {
      const s = db.statements.find(x => x.id === id);
      if (!s) return;
      currentStatementId = id;
      if (db.clients.includes(s.client)) {
        clientSelect.value = s.client;
      }
      dateInput.value = s.date;
      titleInput.value = s.title || '';
      totalInput.value = s.total || '';
      notesInput.value = s.notes || '';
      directionSelect.value = s.direction || 'on_client';
      setItemsToUI(s.items || []);
      previewBox.textContent = generatePreviewText(s);
      clientTotalsPanel.style.display = 'none';
    }

    document.getElementById('saveStatementBtn')
      .addEventListener('click', saveCurrentStatement);

    document.getElementById('newStatementSameClientBtn')
      .addEventListener('click', () => {
        clearForm(true);
      });

    clientSelect.addEventListener('change', () => {
      clearForm(true);
      renderStatementsList();
    });

    document.getElementById('copyTextBtn').addEventListener('click', async () => {
      const text = previewBox.textContent.trim();
      if (!text) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù†Ø³Ø®Ù‡. Ø§Ø­ÙØ¸ Ø§Ù„ÙƒØ´Ù Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØµØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.');
      } catch (e) {
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙˆÙ†Ø³Ø®Ù‡.');
      }
    });

    // ===== Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø© =====
    function computeClientTotals(client) {
      const totals = {};
      db.statements
        .filter(s => s.client === client)
        .forEach(s => {
          (s.items || []).forEach(it => {
            const amount = Number(it.amount) || 0;
            if (!amount) return;
            const cur = it.currency || 'ÙŠÙ…Ù†ÙŠ';
            if (!totals[cur]) totals[cur] = 0;
            totals[cur] += amount;
          });
        });
      return totals;
    }

    showClientTotalsBtn.addEventListener('click', () => {
      const client = clientSelect.value;
      if (!client) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      const clientStatements = db.statements.filter(s => s.client === client);
      if (!clientStatements.length) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ´ÙˆÙØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.');
        clientTotalsPanel.style.display = 'none';
        return;
      }
      const totals = computeClientTotals(client);
      if (!Object.keys(totals).length) {
        clientTotalsPanel.style.display = 'block';
        clientTotalsPanel.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº Ù…Ø³Ø¬Ù‘Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
        return;
      }
      const lines = [];
      lines.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„: ' + client);
      lines.push('---------------------');
      Object.entries(totals).forEach(([cur, sum]) => {
        lines.push(formatNumber(sum) + ' ' + cur);
      });
      clientTotalsPanel.style.display = 'block';
      clientTotalsPanel.textContent = lines.join('\n');
    });

    // ===== Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (PWA) =====
    let deferredPrompt = null;
    const installButton = document.getElementById('installButton');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.hidden = false;
    });

    installButton.addEventListener('click', async () => {
      if (!deferredPrompt) {
        alert('Ø§Ù„ØªØ«Ø¨ÙŠØª ØºÙŠØ± Ù…ØªØ§Ø­ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø§Ø®ØªÙŠØ§Ø± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".');
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        console.log('User accepted install');
      }
      deferredPrompt = null;
      installButton.hidden = true;
    });

    // ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ =====
    loadFromStorage();
    renderClientsSelect();
    clearForm(true);
    renderStatementsList();
  </script>
</body>
</html>
